name: Docker Build and Push

on:
    push:
        branches:
            - master
        paths-ignore:
            - "**.md"
            - "docs/**"
    workflow_dispatch:

env:
    REGISTRY: ghcr.io

jobs:
    build-and-push:
        name: Build and Push (${{ matrix.type }})
        runs-on: ubuntu-latest
        timeout-minutes: 60
        permissions:
            contents: read
            packages: write

        strategy:
            fail-fast: false
            matrix:
                include:
                    # 1. æ—¢å­˜ã®ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¯ãƒ³ç‰ˆï¼ˆå¤‰æ›´ãªã—ï¼‰
                    - type: all-in-one
                      dockerfile: ./Dockerfile
                      image_name: vemikrs/mirelplatform
                      description: "Full stack (Backend + Frontend + Nginx)"

                    # 2. æ–°è¦ã®SaaSç”¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç‰ˆ
                    - type: backend-only
                      dockerfile: ./Dockerfile.backend
                      image_name: vemikrs/mirelplatform-backend
                      description: "Backend only (Spring Boot optimized for Cloud Run)"

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels)
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ matrix.image_name }}
                  tags: |
                      type=ref,event=branch
                      type=sha,prefix={{branch}}-
                      type=raw,value=latest,enable={{is_default_branch}}
                  labels: |
                      org.opencontainers.image.description=${{ matrix.description }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ${{ matrix.dockerfile }}
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha,scope=${{ matrix.type }}
                  cache-to: type=gha,mode=max,scope=${{ matrix.type }}
                  platforms: linux/amd64
                  # ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¯ãƒ³ç‰ˆã«å¿…è¦ãªå¼•æ•°ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç‰ˆã§ã¯ç„¡è¦–ã•ã‚Œã‚‹ã®ã§ãã®ã¾ã¾ã§OKï¼‰
                  build-args: |
                      NODE_VERSION=22
                      NVM_VERSION=0.39.7

            - name: Image digest
              run: echo "Image [${{ matrix.type }}] pushed with digest ${{ steps.meta.outputs.digest }}"

            - name: Create summary
              run: |
                  echo "## Docker Build Summary ðŸ³ (${{ matrix.type }})" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Registry:** \`${{ env.REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Image:** \`${{ matrix.image_name }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Description:** ${{ matrix.description }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Tags" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Pull Command" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "docker pull ${{ env.REGISTRY }}/${{ matrix.image_name }}:latest" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    verify-all-in-one:
        name: Verify All-in-One Image
        runs-on: ubuntu-latest
        needs: build-and-push
        timeout-minutes: 15
        permissions:
            contents: read
            packages: read

        steps:
            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Pull and inspect image
              run: |
                  echo "Pulling image..."
                  docker pull ${{ env.REGISTRY }}/vemikrs/mirelplatform:latest

                  echo "Inspecting image..."
                  docker inspect ${{ env.REGISTRY }}/vemikrs/mirelplatform:latest

                  echo "Image history..."
                  docker history ${{ env.REGISTRY }}/vemikrs/mirelplatform:latest

            - name: Test image startup
              run: |
                  echo "Testing image startup..."
                  docker run --rm ${{ env.REGISTRY }}/vemikrs/mirelplatform:latest bash -c "
                    echo 'Container started successfully' && 
                    java -version
                  "

            - name: Verify installed components
              run: |
                  echo "Verifying Java, Node.js, and pnpm..."
                  docker run --rm --entrypoint bash ${{ env.REGISTRY }}/vemikrs/mirelplatform:latest -c "
                    export NVM_DIR='/home/vscode/.nvm' && 
                    [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\" && 
                    export PATH=\"\$NVM_DIR/versions/node/v22.20.0/bin:\$PATH\" &&
                    echo '=== Java Version ===' && 
                    java -version && 
                    echo '=== Node.js Version ===' && 
                    node --version && 
                    echo '=== pnpm Version ===' && 
                    pnpm --version &&
                    echo '=== JAR Files ===' &&
                    find /workspace/backend/build/libs -name '*.jar' ! -name '*plain.jar'
                  "

            - name: Create verification summary
              run: |
                  echo "## All-in-One Image Verification âœ…" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Image \`${{ env.REGISTRY }}/vemikrs/mirelplatform:latest\` has been successfully verified." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "The image includes:" >> $GITHUB_STEP_SUMMARY
                  echo "- â˜• Java 21 (Temurin)" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸŸ¢ Node.js 22" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ“¦ pnpm" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸš€ Backend (Spring Boot) + Frontend (Vite) + Nginx" >> $GITHUB_STEP_SUMMARY

    verify-backend:
        name: Verify Backend Image
        runs-on: ubuntu-latest
        needs: build-and-push
        timeout-minutes: 10
        permissions:
            contents: read
            packages: read

        steps:
            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Pull and inspect image
              run: |
                  echo "Pulling image..."
                  docker pull ${{ env.REGISTRY }}/vemikrs/mirelplatform-backend:latest

                  echo "Inspecting image..."
                  docker inspect ${{ env.REGISTRY }}/vemikrs/mirelplatform-backend:latest

                  echo "Image size..."
                  docker images ${{ env.REGISTRY }}/vemikrs/mirelplatform-backend:latest --format "{{.Size}}"

            - name: Test Java runtime
              run: |
                  echo "Testing Java runtime..."
                  docker run --rm --entrypoint java ${{ env.REGISTRY }}/vemikrs/mirelplatform-backend:latest -version

            - name: Create verification summary
              run: |
                  IMAGE_SIZE=$(docker images ${{ env.REGISTRY }}/vemikrs/mirelplatform-backend:latest --format "{{.Size}}")
                  echo "## Backend Image Verification âœ…" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Image \`${{ env.REGISTRY }}/vemikrs/mirelplatform-backend:latest\` has been successfully verified." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Image Size:** $IMAGE_SIZE (optimized for Cloud Run)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "The image includes:" >> $GITHUB_STEP_SUMMARY
                  echo "- â˜• Java 21 JRE (Eclipse Temurin Alpine)" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸš€ Spring Boot Application" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸŒ Asia/Tokyo timezone" >> $GITHUB_STEP_SUMMARY
