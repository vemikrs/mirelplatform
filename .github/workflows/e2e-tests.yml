name: E2E Tests

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

permissions: read-all

env:
  # Timezone setting for Japanese environment
  TZ: Asia/Tokyo

jobs:
  validate-setup:
    name: Validate E2E Test Setup
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Verify Node.js version
        run: |
          echo "Node version: $(node --version)"
          node --version | grep "v22" || (echo "ERROR: Node 22 not detected!" && exit 1)

      - name: Install E2E test dependencies
        working-directory: packages/e2e
        run: pnpm install --frozen-lockfile

      - name: Validate E2E setup
        working-directory: packages/e2e
        run: pnpm run test:e2e:validate || echo "Validation script not available yet"

      - name: Check Playwright configuration
        working-directory: packages/e2e
        run: pnpm exec playwright test --list

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-results
          path: |
            test-results/
          retention-days: 7

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: validate-setup
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Verify Node.js version
        run: |
          echo "Node version: $(node --version)"
          node --version | grep "v22" || (echo "ERROR: Node 22 not detected!" && exit 1)

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle', '**/*.gradle.kts', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install E2E test dependencies
        working-directory: packages/e2e
        run: pnpm install --frozen-lockfile

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(pnpm list @playwright/test --depth=0 --json | jq -r '.[0].devDependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-${{ matrix.browser }}
          restore-keys: |
            ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-
            ${{ runner.os }}-playwright-

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: packages/e2e
        run: pnpm exec playwright install --with-deps ${{ matrix.browser }}

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Start E2E services (PostgreSQL, Redis, MailHog)
        run: |
          echo "Starting E2E services with docker-compose..."
          docker compose -f docker-compose.e2e.yml up -d
          echo "Waiting for services to be healthy..."
          # Wait for PostgreSQL to be ready
          for i in {1..30}; do
            if docker compose -f docker-compose.e2e.yml exec -T postgres-e2e pg_isready -U mirel_e2e -d mirelplatform_e2e; then
              echo "✅ PostgreSQL is ready!"
              break
            fi
            echo "Attempt $i/30: Waiting for PostgreSQL..."
            sleep 2
            if [ $i -eq 30 ]; then
              echo "❌ PostgreSQL failed to start"
              docker compose -f docker-compose.e2e.yml logs postgres-e2e
              exit 1
            fi
          done
          # Wait for Redis to be ready
          for i in {1..15}; do
            if docker compose -f docker-compose.e2e.yml exec -T redis-e2e redis-cli ping | grep -q PONG; then
              echo "✅ Redis is ready!"
              break
            fi
            echo "Attempt $i/15: Waiting for Redis..."
            sleep 1
            if [ $i -eq 15 ]; then
              echo "❌ Redis failed to start"
              docker compose -f docker-compose.e2e.yml logs redis-e2e
              exit 1
            fi
          done
          # Wait for MailHog to be ready
          for i in {1..15}; do
            if curl -sf http://localhost:8026/api/v2/messages > /dev/null; then
              echo "✅ MailHog is ready!"
              break
            fi
            echo "Attempt $i/15: Waiting for MailHog..."
            sleep 1
            if [ $i -eq 15 ]; then
              echo "❌ MailHog failed to start"
              docker compose -f docker-compose.e2e.yml logs mailhog-e2e
              exit 1
            fi
          done
          echo "✅ All E2E services are healthy!"

      - name: Build backend
        run: ./gradlew :backend:build -x test

      - name: Start backend service
        run: |
          echo "Starting backend service..."
          echo "Working directory: $(pwd)"
          echo "Gradlew location: $(ls -la ./gradlew)"
          SPRING_PROFILES_ACTIVE=e2e \
          SERVER_PORT=3000 \
          DATABASE_URL=jdbc:postgresql://localhost:5433/mirelplatform_e2e \
          DATABASE_USER=mirel_e2e \
          DATABASE_PASS=mirel_e2e_password \
          REDIS_HOST=localhost \
          REDIS_PORT=6380 \
          SMTP_HOST=localhost \
          SMTP_PORT=1026 \
          ./gradlew :backend:bootRun > backend.log 2>&1 &
          BACKEND_PID=$!
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
          echo "Backend started with PID: $BACKEND_PID"
          sleep 5
          echo "Backend process status:"
          ps aux | grep $BACKEND_PID || echo "Backend process not found"

      - name: Start frontend service
        run: |
          echo "Starting frontend-v3 service (Vite)..."
          pnpm --filter frontend-v3 dev > frontend.log 2>&1 &
          FRONTEND_PID=$!
          echo "FRONTEND_PID=$FRONTEND_PID" >> $GITHUB_ENV
          echo "Frontend started with PID: $FRONTEND_PID"
          sleep 5
          echo "Frontend process status:"
          ps aux | grep $FRONTEND_PID || echo "Frontend process not found"

      - name: Wait for services to be ready
        run: |
          echo "Waiting for backend to be ready..."
          echo "Backend log (first 50 lines):"
          head -50 backend.log 2>/dev/null || echo "No backend log yet"

          for i in {1..60}; do
            if curl -sf http://localhost:3000/mipla2/actuator/health; then
              echo "✅ Backend is ready!"
              break
            fi
            echo "Attempt $i/60: Waiting for backend..."
            sleep 3
            
            if [ $i -eq 60 ]; then
              echo "❌ Backend failed to start within timeout"
              echo "=== Last 200 lines of backend log ==="
              tail -200 backend.log 2>/dev/null || echo "No backend log available"
              echo "=== Checking if backend process is running ==="
              ps aux | grep gradlew || echo "No gradlew process found"
              exit 1
            fi
          done

          echo "Waiting for frontend to be ready..."
          echo "Frontend log (first 50 lines):"
          head -50 frontend.log 2>/dev/null || echo "No frontend log yet"

          for i in {1..60}; do
            if curl -sf http://localhost:5173/; then
              echo "✅ Frontend is ready!"
              break
            fi
            echo "Attempt $i/60: Waiting for frontend..."
            sleep 3
            
            if [ $i -eq 60 ]; then
              echo "❌ Frontend failed to start within timeout"
              echo "=== Last 200 lines of frontend log ==="
              tail -200 frontend.log 2>/dev/null || echo "No frontend log available"
              echo "=== Checking if frontend process is running ==="
              ps aux | grep "vite" || echo "No vite process found"
              exit 1
            fi
          done

          echo "✅ All services are ready!"

      - name: Run E2E tests
        working-directory: packages/e2e
        run: pnpm exec playwright test --project=${{ matrix.browser }}
        env:
          CI: true
          E2E_BASE_URL: http://localhost:5173
          MAILHOG_API_URL: http://localhost:8026

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results-${{ matrix.browser }}
          path: |
            packages/e2e/test-results/
            packages/e2e/playwright-report/
          retention-days: 7

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots-${{ matrix.browser }}
          path: packages/e2e/test-results/screenshots/
          retention-days: 7

      - name: Stop services
        if: always()
        run: |
          echo "Stopping services..."
          if [ ! -z "$BACKEND_PID" ]; then
            kill $BACKEND_PID 2>/dev/null || true
          fi
          if [ ! -z "$FRONTEND_PID" ]; then
            kill $FRONTEND_PID 2>/dev/null || true
          fi
          pkill -f "gradlew.*bootRun" || true
          pkill -f "npm run dev" || true
          pkill -f "nuxt" || true
          echo "Stopping E2E Docker services..."
          docker compose -f docker-compose.e2e.yml down -v || true
          echo "Services stopped"

  accessibility-audit:
    name: Accessibility Audit
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: validate-setup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle', '**/*.gradle.kts', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install dependencies
        working-directory: packages/e2e
        run: pnpm install --frozen-lockfile

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(pnpm list @playwright/test --depth=0 --json | jq -r '.[0].devDependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-chromium
          restore-keys: |
            ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}-
            ${{ runner.os }}-playwright-

      - name: Install Playwright
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: packages/e2e
        run: pnpm exec playwright install --with-deps chromium

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Start E2E services (PostgreSQL, Redis, MailHog)
        run: |
          echo "Starting E2E services with docker-compose..."
          docker compose -f docker-compose.e2e.yml up -d
          echo "Waiting for services to be healthy..."
          # Wait for PostgreSQL to be ready
          for i in {1..30}; do
            if docker compose -f docker-compose.e2e.yml exec -T postgres-e2e pg_isready -U mirel_e2e -d mirelplatform_e2e; then
              echo "✅ PostgreSQL is ready!"
              break
            fi
            echo "Attempt $i/30: Waiting for PostgreSQL..."
            sleep 2
            if [ $i -eq 30 ]; then
              echo "❌ PostgreSQL failed to start"
              docker compose -f docker-compose.e2e.yml logs postgres-e2e
              exit 1
            fi
          done
          # Wait for Redis to be ready
          for i in {1..15}; do
            if docker compose -f docker-compose.e2e.yml exec -T redis-e2e redis-cli ping | grep -q PONG; then
              echo "✅ Redis is ready!"
              break
            fi
            echo "Attempt $i/15: Waiting for Redis..."
            sleep 1
            if [ $i -eq 15 ]; then
              echo "❌ Redis failed to start"
              docker compose -f docker-compose.e2e.yml logs redis-e2e
              exit 1
            fi
          done
          # Wait for MailHog to be ready
          for i in {1..15}; do
            if curl -sf http://localhost:8026/api/v2/messages > /dev/null; then
              echo "✅ MailHog is ready!"
              break
            fi
            echo "Attempt $i/15: Waiting for MailHog..."
            sleep 1
            if [ $i -eq 15 ]; then
              echo "❌ MailHog failed to start"
              docker compose -f docker-compose.e2e.yml logs mailhog-e2e
              exit 1
            fi
          done
          echo "✅ All E2E services are healthy!"

      - name: Build backend
        run: ./gradlew :backend:build -x test

      - name: Start services
        run: |
          echo "Starting backend service..."
          SPRING_PROFILES_ACTIVE=e2e \
          SERVER_PORT=3000 \
          DATABASE_URL=jdbc:postgresql://localhost:5433/mirelplatform_e2e \
          DATABASE_USER=mirel_e2e \
          DATABASE_PASS=mirel_e2e_password \
          REDIS_HOST=localhost \
          REDIS_PORT=6380 \
          SMTP_HOST=localhost \
          SMTP_PORT=1026 \
          ./gradlew :backend:bootRun > backend.log 2>&1 &
          BACKEND_PID=$!
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
          echo "Backend started with PID: $BACKEND_PID"

          echo "Starting frontend-v3 service (Vite)..."
          pnpm --filter frontend-v3 dev > frontend.log 2>&1 &
          FRONTEND_PID=$!
          echo "FRONTEND_PID=$FRONTEND_PID" >> $GITHUB_ENV
          echo "Frontend started with PID: $FRONTEND_PID"

          echo "Waiting for backend..."
          for i in {1..60}; do
            if curl -sf http://localhost:3000/mipla2/actuator/health; then
              echo "✅ Backend is ready!"
              break
            fi
            echo "Attempt $i/60: Waiting for backend..."
            sleep 3
            if [ $i -eq 60 ]; then
              echo "❌ Backend failed to start"
              tail -200 backend.log 2>/dev/null || echo "No backend log"
              exit 1
            fi
          done

          echo "Waiting for frontend..."
          for i in {1..60}; do
            if curl -sf http://localhost:5173/; then
              echo "✅ Frontend is ready!"
              break
            fi
            echo "Attempt $i/60: Waiting for frontend..."
            sleep 3
            if [ $i -eq 60 ]; then
              echo "❌ Frontend failed to start"
              tail -200 frontend.log 2>/dev/null || echo "No frontend log"
              exit 1
            fi
          done

          echo "✅ All services ready!"

      - name: Run accessibility tests
        working-directory: packages/e2e
        run: pnpm exec playwright test --project=chromium --grep="@a11y"
        env:
          E2E_BASE_URL: http://localhost:5173
          MAILHOG_API_URL: http://localhost:8026

      - name: Upload accessibility results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-audit-results
          path: |
            packages/e2e/test-results/
            packages/e2e/playwright-report/
          retention-days: 7

      - name: Stop services
        if: always()
        run: |
          echo "Stopping services..."
          if [ ! -z "$BACKEND_PID" ]; then
            kill $BACKEND_PID 2>/dev/null || true
          fi
          if [ ! -z "$FRONTEND_PID" ]; then
            kill $FRONTEND_PID 2>/dev/null || true
          fi
          pkill -f "gradlew.*bootRun" || true
          pkill -f "npm run dev" || true
          pkill -f "nuxt" || true
          echo "Stopping E2E Docker services..."
          docker compose -f docker-compose.e2e.yml down -v || true
          echo "Services stopped"
