name: Build Frontend Artifact

on:
    push:
        branches: ["master"]
        paths:
            - "apps/frontend-v3/**"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Install pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: "22"
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Check Version and Auto Bump
              id: check_version
              run: |
                  # Single Source of Truth から読み込み
                  CURRENT_VERSION=$(cat VERSION)
                  echo "Current version: $CURRENT_VERSION"

                  # Remote Tag Search Loop
                  VERSION=$CURRENT_VERSION
                  while true; do
                    TAG_NAME="frontend-v3/v$VERSION"
                    echo "Checking if tag $TAG_NAME exists on remote..."

                    if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
                      echo "Tag $TAG_NAME already exists. Bumping..."
                      # VERSION を patch bump (shell のみ)
                      IFS='.' read -ra PARTS <<< "$VERSION"
                      PATCH=$((${PARTS[2]} + 1))
                      VERSION="${PARTS[0]}.${PARTS[1]}.$PATCH"
                    else
                      echo "Tag $TAG_NAME does not exist. Using version $VERSION"
                      break
                    fi
                  done

                  FINAL_TAG="frontend-v3/v$VERSION"

                  if [ "$VERSION" != "$CURRENT_VERSION" ]; then
                    echo "Version bumped from $CURRENT_VERSION to $VERSION"
                    # VERSION ファイルと全 package.json を同期更新
                    echo "$VERSION" > VERSION
                    cd apps/frontend-v3
                    npm version $VERSION --no-git-tag-version --allow-same-version
                    cd ../..
                    jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json
                    git add VERSION apps/frontend-v3/package.json package.json
                    git commit -m "chore(release): bump to $VERSION [skip ci]"
                    git fetch origin master
                    git rebase origin/master
                    git push origin master
                    echo "bumped=true" >> $GITHUB_OUTPUT
                  else
                    echo "No version bump needed"
                    echo "bumped=false" >> $GITHUB_OUTPUT
                  fi

                  echo "tag_name=$FINAL_TAG" >> $GITHUB_OUTPUT
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Create Tag
              run: |
                  TAG_NAME="${{ steps.check_version.outputs.tag_name }}"
                  if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
                    echo "Tag $TAG_NAME already exists on remote, skipping..."
                  else
                    git tag $TAG_NAME
                    git push origin $TAG_NAME
                  fi

            - name: Build Frontend
              run: |
                  cd apps/frontend-v3
                  pnpm build

            - name: Create Archive
              run: |
                  cd apps/frontend-v3/dist
                  zip -r ../../../frontend-assets.zip .

            - name: Upload Artifact
              uses: actions/upload-artifact@v7
              with:
                  name: frontend-assets
                  path: frontend-assets.zip
                  retention-days: 30

            - name: Create Release & Upload Asset
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.check_version.outputs.tag_name }}
                  name: Frontend ${{ steps.check_version.outputs.tag_name }}
                  files: frontend-assets.zip
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
