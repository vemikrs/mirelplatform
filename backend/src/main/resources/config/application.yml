server:
  port: ${SERVER_PORT:3000}
  servlet:
    context-path: /mipla2
    multipart:
      max-file-size: 20MB
      max-request-size: 20MB

spring:
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  datasource:
    url: ${DATABASE_URL:}
    driver-class-name: ${DATABASE_DRIVER:}
    username: ${DATABASE_USER:}
    password: ${DATABASE_PASS:}
  session:
    store-type: redis
  jpa:
    database-platform: ${DATABASE_PLATFORM:}
    hibernate:
      ddl-auto: update
  spring-boot:
    run:
      jvmArguments:: -Xint
  sql:
    init:
      mode: never
  autoconfigure:
    exclude:
      # Spring AI AutoConfigure を全て無効化
      # Chat / Embedding / VectorStore は Mira 独自の VectorStoreConfig で手動構成
      # --- PgVectorStore ---
      - org.springframework.ai.vectorstore.pgvector.autoconfigure.PgVectorStoreAutoConfiguration
      # --- Vertex AI (両パッケージ) ---
      - org.springframework.ai.autoconfigure.vertexai.gemini.VertexAiGeminiAutoConfiguration
      - org.springframework.ai.autoconfigure.vertexai.embedding.VertexAiEmbeddingAutoConfiguration
      - org.springframework.ai.model.vertexai.autoconfigure.gemini.VertexAiGeminiChatAutoConfiguration
      - org.springframework.ai.model.vertexai.autoconfigure.embedding.VertexAiEmbeddingConnectionAutoConfiguration
      - org.springframework.ai.model.vertexai.autoconfigure.embedding.VertexAiTextEmbeddingAutoConfiguration
      - org.springframework.ai.model.vertexai.autoconfigure.embedding.VertexAiMultiModalEmbeddingAutoConfiguration
      # --- OpenAI (両パッケージ) ---
      - org.springframework.ai.autoconfigure.openai.OpenAiAutoConfiguration
      - org.springframework.ai.model.openai.autoconfigure.OpenAiAutoConfiguration
      - org.springframework.ai.model.openai.autoconfigure.OpenAiAudioSpeechAutoConfiguration
      - org.springframework.ai.model.openai.autoconfigure.OpenAiAudioTranscriptionAutoConfiguration
      - org.springframework.ai.model.openai.autoconfigure.OpenAiChatAutoConfiguration
      - org.springframework.ai.model.openai.autoconfigure.OpenAiEmbeddingAutoConfiguration
      - org.springframework.ai.model.openai.autoconfigure.OpenAiImageAutoConfiguration
      - org.springframework.ai.model.openai.autoconfigure.OpenAiModerationAutoConfiguration

  # MVC非同期処理設定（Mira ストリーミング応答用）
  task:
    execution:
      pool:
        core-size: 4
        max-size: 16
        queue-capacity: 100
      thread-name-prefix: MiraAsync-
  mvc:
    async:
      request-timeout: 120000  # 2分タイムアウト

  # Redis設定
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms
  # GitHub OAuth2設定（環境変数未設定時は無効化）
  security:
    oauth2:
      client:
        registration:
          github:
            client-id: ${GITHUB_CLIENT_ID:#{null}}
            client-secret: ${GITHUB_CLIENT_SECRET:#{null}}
            scope:
              - read:user
              - user:email
        provider:
          github:
            user-name-attribute: login
  # Spring Boot Mail設定（JavaMailSender Bean生成用）
  # email.provider=smtp の場合のみ有効化するため、環境変数で制御
  # Azure Communication Services 使用時は spring.mail.host を未設定にすることで Bean 生成を抑制
  #
  # 【重要】開発環境でのデフォルト設定について:
  # - SPRING_MAIL_HOST が未設定の場合、host は空文字列になります
  # - 空のhostでJavaMailSender Beanの作成に失敗する可能性があります
  # - email.provider=azure の場合は JavaMailSender は使用されません
  # - email.provider=smtp の場合は必ず SPRING_MAIL_HOST を設定してください
  #   例: SPRING_MAIL_HOST=localhost (MailHog等のSMTPサーバー)
  mail:
    host: ${SPRING_MAIL_HOST:}
    port: ${SPRING_MAIL_PORT:1025}
    username: ${SPRING_MAIL_USERNAME:}
    password: ${SPRING_MAIL_PASSWORD:}
    properties:
      mail:
        smtp:
          auth: ${SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH:false}
          starttls:
            enable: ${SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE:false}

# ログレベル設定（logger.xml の設定より優先されます）
logging:
  level:
    # Spring Framework
    org.springframework: INFO
    org.springframework.web: DEBUG
    org.springframework.security: DEBUG
    # アプリケーション
    jp.vemi.mirel: DEBUG
    jp.vemi.ste: DEBUG
    # Mira AI
    jp.vemi.mirel.apps.mira: DEBUG
    jp.vemi.mirel.apps.mira.infrastructure.ai: TRACE

# CORS設定
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:5173}

mipla2:
  security:
    api:
      enabled: true
  config:
    storage-dir: ${MIREL_STORAGE_DIR:}

mirel:
  storage-dir: ${MIREL_STORAGE_DIR:./data/storage}
  # セキュリティ設定
  security:
    # JWT署名鍵暗号化用マスターキー（Base64エンコード、32バイト以上）
    # 本番環境では必ず環境変数で設定すること
    master-key: ${MIREL_MASTER_KEY:}
  database:
    # 初期化モード: ALWAYS（毎回）, ONCE（初回のみ、デフォルト）, NEVER（実行しない）
    initialize-mode: ${MIREL_DB_INITIALIZE_MODE:ONCE}
    # サンプルデータ投入（本番環境ではfalse）
    seed-sample-data: ${MIREL_DB_SEED_SAMPLE:false}
  # ステンシルレイヤー設定は application-dev.yml で環境固有設定として管理
  apps:
    mste:
      # ProMarker起動時のステンシルマスタ自動リロード設定
      # 開発環境: true (デフォルト) - 起動時に自動リロード
      # 本番環境: false - 手動リロードのみ許可
      auto-reload-stencil-on-startup: ${MIREL_MSTE_AUTO_RELOAD_ON_STARTUP:true}

# OTP設定
otp:
  enabled: ${OTP_ENABLED:true}
  length: ${OTP_LENGTH:6}
  expiration-minutes: ${OTP_EXPIRATION_MINUTES:5}
  max-attempts: ${OTP_MAX_ATTEMPTS:3}
  resend-cooldown-seconds: ${OTP_RESEND_COOLDOWN_SECONDS:60}

# レート制限設定
rate-limit:
  otp:
    request-per-minute: ${RATE_LIMIT_OTP_REQUEST_PER_MINUTE:3}
    verify-per-minute: ${RATE_LIMIT_OTP_VERIFY_PER_MINUTE:5}
  redis:
    fallback-to-memory: ${RATE_LIMIT_REDIS_FALLBACK_TO_MEMORY:true}

# メール設定
email:
  provider: ${EMAIL_PROVIDER:smtp}
  smtp:
    host: ${SMTP_HOST:localhost}
    port: ${SMTP_PORT:1025}
    username: ${SMTP_USERNAME:}
    password: ${SMTP_PASSWORD:}
  azure:
    communication:
      connection-string: ${AZURE_COMMUNICATION_CONNECTION_STRING:}
      email:
        from: ${SMTP_FROM_ADDRESS:no-reply@localhost}
        from-name: mirelplatform

# アプリケーション設定
app:
  name: ${APP_NAME:mirelplatform}
  version: ${APP_VERSION:0.0.1-SNAPSHOT}
  base-url: ${APP_BASE_URL:http://localhost:5173}
  domain: ${APP_DOMAIN:localhost}

springdoc:
  api-docs:
    path: /api-docs
    enabled: true
  swagger-ui:
    path: /swagger-ui.html
    enabled: true
    operations-sorter: method
    tags-sorter: alpha
  show-actuator: false
  paths-to-match:
    - /apps/**
    - /commons/**
    - /auth/**

auth:
  method: jwt
  jwt:
    enabled: true
    secret: ${JWT_SECRET:changeit_changeit_changeit_changeit_changeit_changeit} # 32文字以上
    expiration: 3600
    refresh-expiration: 86400

management:
  endpoints:
    web:
      exposure:
        include: health,metrics,info
  endpoint:
    health:
      show-details: always
  info:
    env:
      enabled: true
    java:
      enabled: true
    os:
      enabled: true

# Mira (mirel Assist) AI アシスタント設定
# 詳細設定は各環境の application-{profile}.yml で定義
mira:
  ai:
    # AI プロバイダ: azure-openai | github-models | openai | mock
    provider: ${MIRA_AI_PROVIDER:mock}

    # Vertex AI (Gemini) 設定
    vertex-ai:
      project-id: ${GEMINI_PROJECT_ID:}
      location: ${GEMINI_LOCATION:us-central1}
      model: ${GEMINI_MODEL:gemini-2.5-flash}

    # GitHub Models 設定
    github-models:
      api-key: ${GITHUB_TOKEN:}
      base-url: https://models.github.ai/inference
      model: ${GITHUB_MODELS_MODEL:openai/gpt-5-mini}
      temperature: 0.7
      max-tokens: 4096
      timeout-seconds: 60

    # Azure OpenAI 設定
    azure-openai:
      endpoint: ${AZURE_OPENAI_ENDPOINT:}
      api-key: ${AZURE_OPENAI_API_KEY:}
      deployment-name: gpt-4o
      temperature: 0.7
      max-tokens: 4096
      timeout-seconds: 60

    # セキュリティ設定
    security:
      prompt-injection:
        enabled: true
        soft-block-threshold: 3 # ソフトブロック閾値（警告表示）
        hard-block-threshold: 5 # ハードブロック閾値（リクエスト拒否）
        semantic-tag-sensitivity: LOW # LOW, MEDIUM, HIGH - 意味タグ検出の感度（汎用チャットボット用）

    audit:
      # 保存ポリシー: FULL | SUMMARY | METADATA_ONLY
      storage-policy: ${MIRA_AUDIT_STORAGE_POLICY:METADATA_ONLY}
      retention-days: 90

    # リランカー設定
    reranker:
      enabled: false  # デフォルト無効（本番環境で有効化）
      provider: vertex-ai  # vertex-ai, cohere, none
      model: semantic-ranker-default-004
      top-n: 5
      min-candidates: 10  # 10件以上の候補がある場合のみリランク実行
      timeout-ms: 5000

    # VectorStore 設定 (PgVector)
    vector-store:
      table-name: mir_mira_vector_store
      dimensions: 768
      distance-type: COSINE_DISTANCE
      index-type: HNSW
      initialize-schema: true

    # トークンクォータ設定
    quota:
      enabled: false  # デフォルト無効
      daily-token-limit: 1000000

# アプリケーション情報（actuator/info で公開）
info:
  app:
    name: mirelplatform
    version: 1.0.0
    description: 汎用業務アプリケーション基盤
