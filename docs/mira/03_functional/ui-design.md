# ui-design.md

## 1. 概要

Mira の UI は、mirelplatform 上のどの画面からも利用可能な **共通チャット UI** として提供する。  
ユーザは以下の 3 状態で Mira を利用できる。

- `minimized`：最小化状態（アイコンのみ表示）
- `docked`：画面右側にドッキングされたチャットウィンドウ
- `fullscreen`：ブラウザ全体を占有する全画面ビュー

3 状態はシームレスに切り替え可能とする。

---

## 2. 共通レイアウト

### 2.1 共通ヘッダ

全ての状態で共通のヘッダエリアを持つ。

- 要素
  - タイトル：`Mira`
  - 現在モード表示：`General / Help / Error / Studio / Workflow`
  - テナント名（任意表示）：`<Tenant Display Name>`
  - アイコンボタン群：
    - 最小化アイコン（`docked` / `fullscreen` → `minimized`）
    - ドック / 全画面切替アイコン（`docked` ↔ `fullscreen`）
    - 設定アイコン（将来のモデル選択等への拡張用）

---

### 2.2 メッセージエリア

- user / assistant のメッセージを時系列に表示
- メッセージ単位で以下のメタ情報をオプション表示可能とする
  - タイムスタンプ
  - モードラベル（`Help / Error / StudioAgent / WorkflowAgent`）
  - コンテキストアイコン（対象画面へのリンクなど、将来拡張）

---

### 2.3 入力エリア

- テキスト入力欄（1〜数行）
- 送信ボタン
- ショートカットボタン：
  - 「この画面の説明」
  - 「エラーを説明」
  - 「設定手順を教えて」
  - 「Studio の設計相談」
  - 「Workflow の設計相談」

ショートカットボタンの押下により、Mira 内部の `mode` を明示的に指定したリクエストを送信する。

---

## 3. 各状態の画面設計

### 3.1 minimized 状態

- 画面右下に小さな丸型 or 角丸アイコンのみ表示
  - アイコン：`M`、または Mira 用シンボル
- ホバー時にツールチップ表示：`Mira - mirel Assist`
- クリックで `docked` 状態に遷移

#### 表示例

- 右下 24px〜32px 程度のアイコン
- スクロールに追従（固定表示）

---

### 3.2 docked 状態（チャットウィンドウ）

- 画面右側に幅 30〜35% 程度のパネルとして表示
- 高さは viewport 高さにフィット
- mirelplatform のメインコンテンツは左側に残る

#### 構成

1. ヘッダ
   - `Mira` ロゴ / タイトル
   - 現在モード表示
   - アイコンボタン：最小化、全画面（↔）切替

2. メッセージエリア
   - 上から下へ時系列表示
   - スクロール可能、最新メッセージは下端

3. 入力エリア
   - テキスト入力
   - 送信ボタン
   - ショートカットボタン（折りたたみ可能）

#### 挙動

- 画面遷移時：
  - `conversationId` は維持
  - `ContextSnapshot` は画面ごとに更新し、次回メッセージ送信時に付与
- モード切替：
  - ショートカット利用時は内部モードを上書き（画面内で明示）

---

### 3.3 fullscreen 状態（全画面ビュー）

全画面ビューは、より情報量の多いやり取り・設計相談に最適化する。

#### レイアウト案（2カラム）

- 左カラム：メッセージエリア（幅 60〜70%）
- 右カラム：コンテキスト / 推奨アクションエリア（幅 30〜40%）

##### 左カラム

- docked 状態と同等のメッセージ表示・入力エリア
- 過去のメッセージを広範囲に閲覧可能

##### 右カラム（コンテキストパネル）

- 現在の画面情報：
  - `appId` / `screenId`
  - 選択中オブジェクト（例：エンティティ名、Workflow ノード名等）
- 推奨アクション一覧：
  - 「対象画面を開く」
  - 「該当の設定画面を開く」
  - 「Workflow をテスト実行する」等（将来拡張）
- ショートカットの一覧：
  - `Help / Error / StudioAgent / WorkflowAgent` などのモードボタン

#### 状態遷移

- `docked` → `fullscreen`：
  - メッセージ履歴を維持したままレイアウト変更
- `fullscreen` → `docked`：
  - 直前のスクロール位置・入力内容は可能な範囲で維持

---

## 4. モード別 UI 挙動

### 4.1 general_chat モード

- プレーンなチャット
- 右カラムのコンテキスト表示は最小限（画面情報の簡易表示のみ）

### 4.2 context_help モード

- 「この画面の説明」ボタンから遷移
- ヘッダ上に `Help` バッジ表示
- 初回メッセージに、対象画面の概要・主な操作を提示

### 4.3 error_analyze モード

- エラーが発生した直後に自動起動する場合もある
- メッセージ先頭に「直近のエラー」セクションを表示（要約＋詳細）
- 推奨アクションを右カラムに箇条書き表示

### 4.4 studio_agent / workflow_agent モード

- Studio / Workflow 画面からのショートカットで起動
- 右カラムに、関連するデザイン要素の概要（エンティティ構造、Workflow ノード構造等）を表示（将来拡張）
- 「設計案の候補」をリスト表示

---

## 5. メッセージ編集・再送信機能

### 5.1 概要

ユーザーが送信済みのメッセージを編集して再送信できる機能を提供する。  
誤字修正やプロンプトの改善により、より適切な応答を得ることが可能になる。

### 5.2 実装方式

**インライン編集型（シンプル上書き方式）**を採用する。

- 編集したメッセージから会話を再開
- 編集点以降のメッセージは削除される
- 編集前の履歴は保持されない

#### 将来の拡張

分岐型（編集後に新しい会話ツリーを作成）への拡張も検討可能だが、初期実装では上書き方式を採用する。

### 5.3 UI/UX フロー

#### 編集開始

1. ユーザーメッセージにホバー → **編集ボタン（鉛筆アイコン）** が表示される
2. 編集ボタンをクリック → 入力欄にメッセージ内容がセットされ、編集モードに遷移
3. 入力欄上部に **「メッセージを編集中」** バナーを表示
4. キーボードショートカット: メッセージにフォーカス中に `e` キーで編集モード起動

#### 編集・再送信

1. メッセージを編集
2. Enter または送信ボタンで再送信
3. **編集点以降のメッセージをすべて削除**
4. 編集後のメッセージで新規チャットリクエストを送信
5. AI応答を受信し、新しいメッセージとして追加

#### 警告ダイアログ

編集点以降にメッセージが存在する場合、以下の警告を表示：

```
このメッセージを編集すると、以降の会話履歴（N件）が削除されます。
よろしいですか？

[キャンセル]  [削除して再送信]
```

#### キャンセル

- Escキー または「キャンセル」ボタンで編集モードを終了
- 入力欄は元の状態に戻る

### 5.4 制約・仕様

#### 編集可能な範囲

- ✅ **ユーザーメッセージのみ**編集可能
- ❌ アシスタントメッセージは編集不可
- ✅ 最新メッセージ以外も編集可能（編集点以降を削除して再送信）

#### 会話履歴の整合性

- 編集点以降のメッセージは**すべて削除**される
- ユーザーに警告ダイアログで確認を求める
- 削除されたメッセージは復元不可（将来的に監査ログで記録可能）

#### ローディング状態

- 編集中は新規メッセージ送信を無効化
- 編集・再送信中も `isLoading` で UI をブロック

### 5.5 キーボードショートカット

| キー | 動作 | 備考 |
|---|---|---|
| `e` | メッセージ編集モード起動 | ユーザーメッセージにフォーカス中 |
| `Esc` | 編集モードをキャンセル | 編集モード中のみ有効 |
| `Enter` | 編集済みメッセージを再送信 | 編集モード中、Shift+Enterは改行 |

---

## 6. アクセシビリティ

- キーボード操作での起動・フォーカス移動に対応
  - ショートカット例：`Ctrl+Shift+M` で Mira を開閉
  - `e` キーでメッセージ編集モード起動
- スクリーンリーダー対応のため、ヘッダ・メッセージ・入力欄に適切な ARIA 属性を付与
- コントラスト比・フォントサイズは mirelplatform 共通のガイドラインに準拠
