# ADR: メッセージ単位のコンテキストインライン編集機能の導入

**ステータス**: Accepted
**日付**: 2025-12-06
**スコープ**: mirel Studio / mirelplatform（Miraアプリ）

---

## 1. 背景（Context）

LLM を利用した会話型 UI（Mira）は、通常、以下を自動的に組み合わせて推論を行う。

* システム／テナント／組織／ユーザー階層のコンテキスト
* 会話履歴
* 自動要約・圧縮
* トーン・スタイルの暗黙適用

一方で、高度ユーザー・専門業務ユーザーのユースケースでは、

* **当該メッセージのみに履歴を限定したい**
* **デフォルトコンテキストを一時的に無効化したい**
* **レビュー用途などで強いコンテキストを上書きしたい**
* **トークン節約のために最小構成で送りたい**

というニーズが明確に存在する。

既存の UI・API では、**メッセージ送信単位のコンテキスト再構成**が不可能であり、
推論品質の微調整や業務特化 AI の実用化において制約となっている。

これらを解決するため、**送信直前にインラインでコンテキストを編集する機能**を導入したい。

---

## 2. 決定（Decision）

### 2.1 メッセージ単位の「コンテキスト編集レイヤ」を設ける

* ユーザーが **送信前にモーダルを開いて、以下を自由に操作できるレイヤ** を導入する。

  * 履歴スコープ（全履歴 / 直近 N 件 / 履歴なし）
  * デフォルトコンテキストの ON/OFF と優先度（override / normal / low）
  * プリセットコンテキストの追加
  * 一時追加コンテキスト（ワンショット）の記述

### 2.2 UI は「モーダル（Context Switcher Modal）」を採用する

理由：

* 操作点が多く、クイックパレット単体では階層的 UI が表現できない
* 拡張性（タブ、AI 推奨、優先度 UI、ターミナルなど）を確保しやすい
* 将来的に複雑な設定を視認できる導線が必要

### 2.3 モーダル内に「コマンドターミナル」も統合する

* キーボード中心のユーザー向けに、VSCode 風の簡易パレットを統合
* `> history 5` など、ショートコマンドを提供
* ただし UI 自体はモーダルが主であり、ターミナルは補助位置づけ

### 2.4 Backend に `messageConfig` を新設

```
ChatRequest.context.messageConfig
```

を追加し、次の情報を受け取る：

* 履歴スコープ（auto / recent / none）
* recentCount
* contextOverrides（enabled / priority）
* additionalPresets（プリセットID）
* temporaryContext（ワンショット追加）

Backend はこの設定に基づいて、
**「階層コンテキスト × 優先度 × プリセット × カスタム」**
をマージし、最終プロンプトとして LLM に渡す。

### 2.5 AI 推奨プリセットを提供する

* ユーザー入力文を元に、軽量 LLM（またはヒューリスティック）で推奨設定を生成
* モーダル上部に「おすすめ設定」として提示
* ワンクリックで反映可能

---

## 3. 代替案（Alternatives）

### 3.1 クイックパレットのみで行う

**採用しなかった理由：**

* 操作項目が多く、階層構造（コンテキストカテゴリ別 UI）が表現できない
* 将来的に機能追加する際の拡張性が乏しい
* 視認性が低く、設定ミスを誘発しやすい

### 3.2 “会話モード”を複数用意し、切り替える方式

**採用しなかった理由：**

* モード切替は「セッション単位」でありメッセージ単位の柔軟性には対応できない
* 履歴削除／優先度上書き／ワンショット追加等が表現しづらい

### 3.3 全てバックエンドで自動推論（ユーザー操作を排除）

**採用しなかった理由：**

* 高度ユーザーの「意図したい操作」を奪う
* トークン節約や厳密レビューなど、操作の透明性が必須のケースに対応できない

---

## 4. 結果（Consequences）

### 4.1 利点（Positive）

* 1メッセージ単位の高精度なコンテキスト制御が可能となる
* トークン節約や精密レビューのユースケースに対応
* 既存の階層コンテキスト (`MiraContextLayerService`) を拡張する形で統合可能
* 将来「コンテキスト運用職（ジュニアコンテキストエンジニア）」向けの UI/ガイドとして発展性がある
* 設定を監査ログとして保存すれば、業務利用でのトレーサビリティも確保できる

### 4.2 欠点・コスト（Negative）

* UI/Backend の新規実装量が大きい
* モーダル UI が複雑化し、学習コストが発生する
* コンテキストマージロジックの負荷が増える
* チーム内で「どの設定を使うべきか」の運用ガイドラインが必要となる

---

## 5. 将来展望

* チーム共有プリセット
* AI が「このメッセージは履歴不要です」などの自動アシスト
* コンテキストの可視化（どのレイヤが最終的に効いたか）
* LLM 推論ログとのセットで「プロンプト解析ツール」の提供
* コンテキスト編集の権限管理（エンプラ向け）

---

## 6. 採用理由（Summary）

本機能は、一般的な AI チャット UI には存在しないが、
以下の理由で **mirel Studio の中核機能として妥当** である。

* 業務・開発用途では「メッセージ単位のコンテキスト操作」が強い要求となる
* 既存の `MiraContextLayerService` を活かしながら、拡張可能な構造にできる
* 将来の AI 利用組織では「コンテキスト調整職」の存在がほぼ確実でありニーズが高まる

したがって、**本 ADR の方針に基づき、段階的に実装を進める。**

