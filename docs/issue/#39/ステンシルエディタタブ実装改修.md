## 改修方針B（ファイルタブ方式）の詳細設計

### 全体レイアウト
```
┌─────────────────────────────────────────────────────────────┐
│ Service (PJ171)  [参照モード] [保存] [プレビュー] [📋履歴] [一覧へ戻る]│
├──────────┬──────────────────────────────────────────────────┤
│          │ 📄 stencil-settings.yml [×] 📝 template.ftl [×]  │
│  Files   ├──────────────────────────────────────────────────┤
│  📁 src  │                                                  │
│  📁 main │      選択中タブのエディタ表示エリア                 │
│   📁java │                                                  │
│    📄.yml│                                                  │
│    📝.ftl│                                                  │
└──────────┴──────────────────────────────────────────────────┘
```

### 主要な変更点

#### 1. **タブシステム（VS Code風）**

**タブの動作**:
- ファイルクリック → 新しいタブで開く
- 既に開いているファイル → そのタブにフォーカス
- `[×]`ボタン → タブを閉じる
- 未保存のタブ → `●`マーク表示
- アクティブタブ → ハイライト表示

**実装イメージ**:
```tsx
interface OpenTab {
  path: string;
  name: string;
  type: FileType;
  isDirty: boolean; // 未保存フラグ
}

const [openTabs, setOpenTabs] = useState<OpenTab[]>([]);
const [activeTabPath, setActiveTabPath] = useState<string | null>(null);
```

#### 2. **履歴機能 → モーダルダイアログ化**

**現状の問題**:
- 「履歴」タブは使用頻度が低い
- タブエリアを常に占有するのは無駄

**改善案**:
```
ヘッダーに [📋 履歴] ボタンを配置
↓
クリックでモーダルダイアログ表示
┌──────────────────────────────────┐
│  バージョン履歴                     │
├──────────────────────────────────┤
│  ● 250913A (2025/09/13) [復元]   │
│  ○ 250912A (2025/09/12) [復元]   │
│  ○ 250911A (2025/09/11) [復元]   │
├──────────────────────────────────┤
│  [差分表示] [キャンセル]            │
└──────────────────────────────────┘
```

**メリット**:
- タブエリアを編集ファイルに専念できる
- 必要な時だけ表示（オンデマンド）
- 差分表示や復元操作も同じダイアログ内で完結

#### 3. **プレビュー機能の扱い**

**選択肢A**: 現状維持（全画面オーバーレイ）
```tsx
{showPreview && <PreviewPanel ... />}
```

**選択肢B**: サイドパネル方式
```
├──────────┬──────────────┬──────────┤
│  Files   │  Editor      │ Preview  │
│          │              │ (toggle) │
```

**推奨**: 選択肢A（オーバーレイ）
- プレビューは一時的な確認用途
- 常時表示する必要なし

---

## 詳細実装設計

### コンポーネント構成

```tsx
<StencilEditor>
  {/* ヘッダー */}
  <Header>
    <ModeToggle />
    <SaveButton />
    <PreviewButton />
    <HistoryButton onClick={() => setShowHistoryDialog(true)} />
    <BackButton />
  </Header>

  {/* メインレイアウト */}
  <div className="flex">
    {/* 左: ファイルエクスプローラー */}
    <FileExplorer 
      files={data.files}
      onFileSelect={handleFileOpen}  // タブを開く
      currentFilePath={activeTabPath}
    />

    {/* 右: タブ + エディタエリア */}
    <div className="flex-1">
      {/* タブバー */}
      <FileTabs
        tabs={openTabs}
        activeTab={activeTabPath}
        onTabChange={setActiveTabPath}
        onTabClose={handleTabClose}
      />

      {/* エディタエリア */}
      <EditorArea>
        {renderActiveEditor()}
      </EditorArea>
    </div>
  </div>

  {/* モーダルダイアログ */}
  {showHistoryDialog && (
    <HistoryDialog
      stencilId={stencilId}
      currentSerial={serial}
      onRestore={handleRestore}
      onClose={() => setShowHistoryDialog(false)}
    />
  )}

  {showPreview && (
    <PreviewPanel ... />
  )}
</StencilEditor>
```

### 新規コンポーネント

#### `FileTabs.tsx`
```tsx
interface FileTabsProps {
  tabs: OpenTab[];
  activeTab: string | null;
  onTabChange: (path: string) => void;
  onTabClose: (path: string) => void;
}

export const FileTabs: React.FC<FileTabsProps> = ({
  tabs, activeTab, onTabChange, onTabClose
}) => {
  return (
    <div className="flex border-b overflow-x-auto">
      {tabs.map(tab => (
        <div
          key={tab.path}
          className={`tab ${activeTab === tab.path ? 'active' : ''}`}
          onClick={() => onTabChange(tab.path)}
        >
          <FileIcon type={tab.type} />
          <span>{tab.name}</span>
          {tab.isDirty && <span className="dirty-marker">●</span>}
          <button onClick={(e) => {
            e.stopPropagation();
            onTabClose(tab.path);
          }}>×</button>
        </div>
      ))}
    </div>
  );
};
```

#### `HistoryDialog.tsx`
```tsx
interface HistoryDialogProps {
  stencilId: string;
  currentSerial: string;
  onRestore: (serial: string) => void;
  onClose: () => void;
}

export const HistoryDialog: React.FC<HistoryDialogProps> = ({
  stencilId, currentSerial, onRestore, onClose
}) => {
  const [versions, setVersions] = useState<Version[]>([]);
  const [selectedVersion, setSelectedVersion] = useState<string | null>(null);
  const [showDiff, setShowDiff] = useState(false);

  return (
    <Dialog open onOpenChange={onClose}>
      <DialogContent className="max-w-4xl">
        <DialogHeader>
          <DialogTitle>バージョン履歴</DialogTitle>
        </DialogHeader>
        
        <div className="grid grid-cols-2 gap-4">
          {/* 左: バージョンリスト */}
          <div className="space-y-2">
            {versions.map(v => (
              <div 
                key={v.serial}
                className={`version-item ${v.serial === currentSerial ? 'current' : ''}`}
                onClick={() => setSelectedVersion(v.serial)}
              >
                <div className="font-semibold">{v.serial}</div>
                <div className="text-sm text-gray-500">{v.updateDate}</div>
                <div className="text-xs">{v.updateUser}</div>
              </div>
            ))}
          </div>

          {/* 右: プレビュー/差分 */}
          <div>
            {showDiff && selectedVersion ? (
              <DiffViewer 
                oldVersion={currentSerial}
                newVersion={selectedVersion}
              />
            ) : (
              <VersionPreview version={selectedVersion} />
            )}
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => setShowDiff(!showDiff)}>
            {showDiff ? 'プレビュー' : '差分表示'}
          </Button>
          <Button 
            onClick={() => {
              if (selectedVersion) onRestore(selectedVersion);
            }}
            disabled={!selectedVersion}
          >
            復元
          </Button>
          <Button variant="ghost" onClick={onClose}>閉じる</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};
```

---

## 主要なハンドラー実装

### タブ管理
```tsx
// ファイルを開く（タブ追加または選択）
const handleFileOpen = useCallback((file: StencilFile) => {
  const existingTab = openTabs.find(t => t.path === file.path);
  
  if (existingTab) {
    // 既に開いている → フォーカス
    setActiveTabPath(file.path);
  } else {
    // 新規タブを追加
    setOpenTabs(prev => [...prev, {
      path: file.path,
      name: file.name,
      type: file.type,
      isDirty: false
    }]);
    setActiveTabPath(file.path);
  }
}, [openTabs]);

// タブを閉じる
const handleTabClose = useCallback((path: string) => {
  const tab = openTabs.find(t => t.path === path);
  
  if (tab?.isDirty) {
    // 未保存警告
    if (!confirm(`${tab.name} に未保存の変更があります。閉じますか？`)) {
      return;
    }
  }
  
  setOpenTabs(prev => prev.filter(t => t.path !== path));
  
  // アクティブタブを閉じた場合、次のタブに移動
  if (activeTabPath === path) {
    const remainingTabs = openTabs.filter(t => t.path !== path);
    setActiveTabPath(remainingTabs[0]?.path || null);
  }
}, [openTabs, activeTabPath]);

// 内容変更時にdirtyフラグを更新
const handleContentChange = useCallback((path: string, content: string) => {
  setOpenTabs(prev => prev.map(tab => 
    tab.path === path 
      ? { ...tab, isDirty: true }
      : tab
  ));
  
  // 実際のコンテンツ保存
  if (path === '/stencil-settings.yml') {
    setYamlContent(content);
  } else {
    setTemplateContents(prev => ({ ...prev, [path]: content }));
  }
}, []);
```

---

## UXの改善ポイント

### 1. **初期表示**
- stencil-settings.ymlを自動的に開いた状態で表示
- 「ここからスタート」感を演出

### 2. **キーボードショートカット**
- `Ctrl + W`: タブを閉じる
- `Ctrl + Tab`: 次のタブ
- `Ctrl + Shift + Tab`: 前のタブ
- `Ctrl + S`: 保存
- `Ctrl + H`: 履歴ダイアログ

### 3. **視覚的フィードバック**
- タブ切り替え時のスムーズなアニメーション
- 未保存ファイルの明確な表示（●マーク + 色変更）
- アクティブタブの強調表示

### 4. **エラーハンドリング**
- タブ内にバリデーションエラー数を表示（例: `template.ftl ⚠️ 3`）
- エラーのあるファイルは赤色で強調

---

## 段階的な実装計画

### Phase 1: 基本タブシステム（最優先）
1. `FileTabs`コンポーネント作成
2. タブ開く/閉じる機能
3. アクティブタブ管理
4. 未保存フラグ表示

### Phase 2: 履歴ダイアログ化
1. `HistoryDialog`コンポーネント作成
2. 既存の`VersionHistory`を統合
3. ヘッダーにボタン配置
4. 差分表示機能

### Phase 3: UX改善
1. キーボードショートカット
2. タブドラッグ&ドロップ（並び替え）
3. タブのコンテキストメニュー
4. エラー数表示
