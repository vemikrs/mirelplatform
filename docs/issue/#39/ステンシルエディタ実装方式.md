# ğŸ¨ ProMarker ã‚¹ãƒ†ãƒ³ã‚·ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿å®Ÿè£…ä»•æ§˜

## ğŸ“‹ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **ã‚¨ãƒ‡ã‚£ã‚¿**: CodeMirror 6
- **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: Zod
- **å·®åˆ†è¡¨ç¤º**: react-diff-viewer
- **UI**: @mirel/ui (shadcn/ui)

---

## ğŸ“ ã‚¹ãƒ†ãƒ³ã‚·ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
/user/{category}/{stencil-id}/{serial}/
â”œâ”€â”€ stencil-settings.yml           # ãƒ¡ã‚¤ãƒ³è¨­å®š(å¿…é ˆ)
â”œâ”€â”€ {prefix}_stencil-settings.yml  # ã‚«ãƒ†ã‚´ãƒªå…±é€šè¨­å®š(ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
â””â”€â”€ files/
    â”œâ”€â”€ *.ftl                      # FreeMarkerãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    â”œâ”€â”€ .gitkeep                   # ç©ºãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¿æŒ
    â””â”€â”€ {ãã®ä»–}                    # å›ºå®šãƒ•ã‚¡ã‚¤ãƒ«
```

### ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥

| ç¨®åˆ¥ | ç·¨é›† | èª¬æ˜ |
|------|-----|------|
| `stencil-settings.yml` | âœ… | YAMLè¨­å®šã€Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
| `{prefix}_stencil-settings.yml` | âœ… | ã‚«ãƒ†ã‚´ãƒªå…±é€šè¨­å®š(å°‚ç”¨ã‚¨ãƒ‡ã‚£ã‚¿ã¸ãƒªãƒ³ã‚¯) |
| `*.ftl` | âœ… | FreeMarkerãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ |
| `.gitkeep` | âŒ | èª­å–å°‚ç”¨ |
| ãã®ä»– | âœ… | æ‹¡å¼µå­ã‹ã‚‰è¨€èªãƒ¢ãƒ¼ãƒ‰åˆ¤å®š |

### ã‚¨ãƒ‡ã‚£ã‚¿UIæ§‹æˆ

- **ã‚¿ãƒ–**: ãƒ¡ã‚¤ãƒ³è¨­å®šã€ã‚«ãƒ†ã‚´ãƒªå…±é€šè¨­å®šã€Templatesã€Static Filesã€Version History
- **ãƒ•ã‚¡ã‚¤ãƒ«åˆ†é¡**: classifyFile(), getLanguageMode(), isEditable()
- **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: validateFtlFileName(), validateDirectoryName()

---

## ğŸ”„ ç”»é¢çŠ¶æ…‹é·ç§»å›³

```mermaid
stateDiagram-v2
    [*] --> StencilList: ã‚¨ãƒ‡ã‚£ã‚¿èµ·å‹•
    
    StencilList --> ViewMode: ã‚¹ãƒ†ãƒ³ã‚·ãƒ«é¸æŠ(å‚ç…§)
    StencilList --> EditMode: ã‚¹ãƒ†ãƒ³ã‚·ãƒ«é¸æŠ(ç·¨é›†)
    StencilList --> CreateMode: æ–°è¦ä½œæˆ
    
    state ViewMode {
        [*] --> ViewYAML: YAMLè¡¨ç¤º
        ViewYAML --> ViewTemplates: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¡¨ç¤º
        ViewTemplates --> ViewHistory: å±¥æ­´è¡¨ç¤º
        ViewHistory --> ViewYAML
    }
    
    state EditMode {
        [*] --> EditYAML: YAMLç·¨é›†
        EditYAML --> EditTemplates: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†
        EditTemplates --> EditHistory: å±¥æ­´ç¢ºèª
        EditHistory --> EditYAML
        
        EditYAML --> Validating: ä¿å­˜å®Ÿè¡Œ
        EditTemplates --> Validating
        
        Validating --> ConfirmSave: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³OK
        Validating --> EditYAML: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³NG
        
        ConfirmSave --> Saving: ç¢ºèªOK
        ConfirmSave --> EditYAML: ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        
        Saving --> [*]: ä¿å­˜å®Œäº†(æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç”Ÿæˆ)
    }
    
    state CreateMode {
        [*] --> InputYAML: è¨­å®šå…¥åŠ›
        InputYAML --> InputTemplates: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
        InputTemplates --> ValidatingNew: ä¿å­˜å®Ÿè¡Œ
        
        ValidatingNew --> SavingNew: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³OK
        ValidatingNew --> InputYAML: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³NG
        
        SavingNew --> [*]: ä¿å­˜å®Œäº†(åˆç‰ˆç”Ÿæˆ)
    }
    
    ViewMode --> StencilList: ä¸€è¦§ã¸æˆ»ã‚‹
    EditMode --> StencilList: ä¸€è¦§ã¸æˆ»ã‚‹
    CreateMode --> StencilList: ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    
    EditMode --> ViewMode: å‚ç…§ãƒ¢ãƒ¼ãƒ‰ã¸
    ViewMode --> EditMode: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¸
```

### çŠ¶æ…‹é·ç§»ã®è©³ç´°

#### 1. åˆæœŸçŠ¶æ…‹ â†’ ãƒ¢ãƒ¼ãƒ‰é¸æŠ
- **StencilList**: ã‚¹ãƒ†ãƒ³ã‚·ãƒ«ä¸€è¦§ç”»é¢
  - å‚ç…§é¸æŠ â†’ ViewMode
  - ç·¨é›†é¸æŠ â†’ EditMode
  - æ–°è¦ä½œæˆ â†’ CreateMode

#### 2. ViewMode (å‚ç…§ãƒ¢ãƒ¼ãƒ‰)
- **æ¨©é™**: èª­å–å°‚ç”¨
- **æ“ä½œ**: ã‚¿ãƒ–åˆ‡æ›¿(YAML/Templates/History)
- **é·ç§»**: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¸åˆ‡æ›¿å¯èƒ½

#### 3. EditMode (ç·¨é›†ãƒ¢ãƒ¼ãƒ‰)
- **æ¨©é™**: ç·¨é›†å¯èƒ½
- **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  + ä¿å­˜æ™‚
- **ä¿å­˜ãƒ•ãƒ­ãƒ¼**:
  1. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
  2. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
  3. æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç”Ÿæˆ(YYMMDDxå½¢å¼)
  4. DBæ›´æ–°

#### 4. CreateMode (æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰)
- **æ¨©é™**: æ–°è¦ä½œæˆ
- **å¿…é ˆé …ç›®**: stencil-settings.yml
- **ä¿å­˜**: åˆç‰ˆ(xxxxxx**A**)ã¨ã—ã¦ä¿å­˜

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¢ãƒ¼ãƒ‰

```typescript
export type EditorMode = 'view' | 'edit' | 'create';
```

### Zodã‚¹ã‚­ãƒ¼ãƒ

```typescript
export const StencilConfigSchema = z.object({
  id: z.string().regex(/^\/[a-z0-9\-_\/]+$/),
  name: z.string().min(1).max(200),
  serial: z.string().regex(/^\d{6}[A-Z]$/),
  // ...
});
```

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†

```typescript
export interface StencilVersion {
  serial: string;
  createdAt: string;
  createdBy: string;
  isActive: boolean;
}
```

---

## ğŸ’» ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
apps/frontend-v3/src/features/stencil-editor/
â”œâ”€â”€ api/                 # APIå‘¼ã³å‡ºã—
â”œâ”€â”€ components/          # UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”œâ”€â”€ hooks/               # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
â”œâ”€â”€ schemas/             # Zodã‚¹ã‚­ãƒ¼ãƒ
â”œâ”€â”€ types/               # å‹å®šç¾©
â””â”€â”€ utils/               # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
```

### ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

- **StencilEditor**: ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿
- **YamlEditor**: CodeMirror + YAML + ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- **TemplateEditor**: FreeMarkerç·¨é›†
- **DiffViewer**: react-diff-viewerçµ±åˆ
- **VersionControl**: å±¥æ­´è¡¨ç¤ºãƒ»å¾©å…ƒ

---

## ğŸ”§ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

### æ—¢å­˜è³‡ç”£

#### StorageConfig
```java
public static String getUserStencilDir();      // userå±¤
public static String getStandardStencilDir();  // standardå±¤
public static String getSamplesStencilDir();   // sampleså±¤(classpath)
public static boolean isAutoDeploySamples();
```

#### MsteStencilRepository
```java
@Entity
@Table(name = "mste_stencil")
public class MsteStencil {
    @Id public String stencilCd;
    public String stencilName;
    public String itemKind;  // 0:ã‚«ãƒ†ã‚´ãƒª, 1:ã‚¹ãƒ†ãƒ³ã‚·ãƒ«
}
```

#### æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹

| ã‚µãƒ¼ãƒ“ã‚¹ | å½¹å‰² | çŠ¶æ³ |
|---------|------|------|
| SuggestService | UIãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ | âœ… |
| GenerateService | ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ | âœ… |
| ReloadStencilMasterService | DBå†æ§‹ç¯‰ | âœ… |
| UploadStencilService | ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ | âš ï¸ TODO |

### æ–°è¦API

#### StencilEditorController

```java
@RestController
@RequestMapping("/apps/mste/editor")
public class StencilEditorController {
    
    @GetMapping("/{stencilId}/{serial}")
    public ApiResponse<LoadStencilResponse> getStencil(...);
    
    @PostMapping("/save")
    public ApiResponse<SaveStencilResponse> saveStencil(...);
    
    @PostMapping("/common/{categoryId}")
    public ApiResponse<Void> saveCommonSettings(...);
    
    @GetMapping("/{stencilId}/versions")
    public ApiResponse<List<VersionInfo>> getVersionHistory(...);
}
```

#### StencilEditorService

```java
@Service
@Transactional
public class StencilEditorServiceImp implements StencilEditorService {
    
    @Autowired private MsteStencilRepository stencilRepository;
    
    /**
     * ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¤œç´¢: user â†’ standard â†’ samples
     */
    @Override
    public ApiResponse<LoadStencilResponse> loadStencil(String stencilId, String serial) {
        String[] layers = { 
            StorageConfig.getUserStencilDir(),
            StorageConfig.getStandardStencilDir()
        };
        // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã«æ¤œç´¢ã€æœ€åˆã«è¦‹ã¤ã‹ã£ãŸã‚‚ã®ã‚’è¿”ã™
    }
    
    /**
     * userãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æ–°ã‚·ãƒªã‚¢ãƒ«ç•ªå·ã§ä¿å­˜
     */
    @Override
    public ApiResponse<SaveStencilResponse> saveStencil(SaveStencilRequest request) {
        String newSerial = generateNewSerial();  // yyMMddA
        String userDir = StorageConfig.getUserStencilDir();
        // Files.write()ã§ä¿å­˜
        // MsteStencilRepository.save()ã§DBæ›´æ–°
    }
}
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- **ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«é˜²æ­¢**: StorageUtilãŒè‡ªå‹•çš„ã«ãƒ™ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå¤–ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯
- **XSSå¯¾ç­–**: CodeMirrorã®è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— + å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
- **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: `SanitizeUtil.sanitizeCanonicalPath()`, `TemplateEngineProcessor.constructSecurePath()`

---

## ğŸ“Š å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### Phase 1: åŸºæœ¬ã‚¨ãƒ‡ã‚£ã‚¿(2é€±é–“)
- CodeMirror 6çµ±åˆ
- CRUD APIå®Ÿè£…
- Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### Phase 2: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³(1é€±é–“)
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºUI

### Phase 3: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†(2é€±é–“)
- å±¥æ­´API
- å·®åˆ†è¡¨ç¤º
- å¾©å…ƒæ©Ÿèƒ½

### Phase 4: UXæ”¹å–„(1é€±é–“)
- è‡ªå‹•ä¿å­˜
- ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

---

## ğŸ“¦ ä¾å­˜é–¢ä¿‚

```json
{
  "dependencies": {
    "@uiw/react-codemirror": "^4.23.5",
    "@codemirror/lang-yaml": "^6.1.1",
    "@codemirror/lint": "^6.8.2",
    "react-diff-viewer-continued": "^3.4.0",
    "zod": "^3.24.1",
    "js-yaml": "^4.1.0"
  }
}
```

---

## âœ… æˆåŠŸæŒ‡æ¨™

1. **å®‰å…¨æ€§**: ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒãƒ†ã‚¹ãƒˆ100%é€šé
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: 100ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†3ç§’ä»¥å†…
3. **UX**: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå¯¾å¿œ80%ä»¥ä¸Š
4. **ä¿¡é ¼æ€§**: ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¾©å…ƒ99.9%æˆåŠŸ
5. **ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º**: å¢—åŠ 2MBä»¥å†…

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [CodeMirror 6](https://codemirror.net/)
- [react-diff-viewer](https://github.com/praneshr/react-diff-viewer)
- [Zod](https://zod.dev/)

---

**å®Ÿè£…æ–¹é‡**: CodeMirror 6æ¡ç”¨ã«ã‚ˆã‚Šè»½é‡ã‹ã¤æ‹¡å¼µå¯èƒ½ãªã‚¨ãƒ‡ã‚£ã‚¿ã‚’å®Ÿç¾ã€‚StorageConfigç­‰ã®æ—¢å­˜è³‡ç”£ã‚’æœ€å¤§é™æ´»ç”¨ã€‚
