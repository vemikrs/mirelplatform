# Mirel Schema 現状分析レポート

## 1. 概要

本レポートは、`docs/issue/#40/Schema` の仕様書と現在の実装状況（`apps/frontend-v3/src/features/schema` および `packages/ui`）を比較し、GAPと残作業を整理したものです。

## 2. 実装状況サマリ

| 機能                 | ステータス    | 概要                                                                                               |
| -------------------- | ------------- | -------------------------------------------------------------------------------------------------- |
| **モデル管理**       | ⚠️ 部分実装   | 基本的なモデル定義（フラット構造）の作成・保存は可能。階層構造、詳細なバリデーション設定が未実装。 |
| **レコード管理**     | ⚠️ 部分実装   | 一覧表示、詳細表示、保存は可能。ページネーション、ソート、フィルタ、動的カラム生成が不完全。       |
| **コードマスタ**     | ⚠️ 部分実装   | グループ・コード値のCRUDは実装済み。UIの洗練が必要。                                               |
| **UIコンポーネント** | ❌ 未実装多数 | `DataTable`などの共通コンポーネントが`packages/ui`に不在。ウィジェットタイプも限定的。             |

## 3. 詳細GAP分析

### 3.1 共通コンポーネント (`packages/ui`)

| コンポーネント    | 仕様                                               | 現状                                   | GAP / 対応方針                                                                       |
| ----------------- | -------------------------------------------------- | -------------------------------------- | ------------------------------------------------------------------------------------ |
| **DataTable**     | ソート、フィルタ、ページネーション、動的カラム対応 | ❌ 未実装 (`RecordGrid.tsx`で簡易実装) | `packages/ui` に高機能な `DataTable` を実装し、`RecordGrid` を置き換える必要がある。 |
| **FormContainer** | フォームのレイアウトコンテナ                       | ❌ 未実装                              | 必要に応じて実装するか、既存の `Card` 等で代用可能か検討。                           |

### 3.2 モデル管理機能 (`SchemaModelDefinePage`)

- **階層構造**: 仕様では「階層型スキーマモデル」が定義されているが、現状はフラットなフィールドリストのみ対応。`embedded` や `detail` タイプのウィジェット実装も不足。
- **フィールド属性**: `isKey`, `regexPattern`, `minLength`, `maxValue` などのバリデーション属性はデータ構造には存在するが、UI上での設定・保存・反映が不完全の可能性あり。

### 3.3 レコード管理機能 (`SchemaRecordListPage`, `SchemaRecordDetailPage`)

- **一覧画面**:
  - 現状は全件取得 (`schemaApi.list`) しており、サーバーサイドページネーション・検索が未実装。
  - `RecordGrid` は単なるHTMLテーブルであり、仕様にある「動的カラム生成」「ソート」「フィルタ」機能がない。
- **詳細画面 (DynamicForm)**:
  - **ウィジェット不足**: 実装済みは `text`, `textarea`, `text_date`, `checkbox`, `selectbox` (TODOあり) のみ。
  - **未実装ウィジェット**: `text_time`, `tag`, `treeselect`, `htmleditor`, `file`, `embedded`, `detail`, `break`, `title`。
  - **バリデーション**: フロントエンドでのバリデーションロジック（正規表現、必須チェック等）が `DynamicForm` に組み込まれていない。

### 3.4 コードマスタ機能 (`SchemaCodeMasterPage`)

- 機能的にはCRUDが実装されているが、エラーハンドリングやUIのフィードバック（保存成功メッセージ等）が簡易的（`alert`使用）。
- `WidgetRenderer` の `selectbox` がコードマスタと連携していない（TODOコメントあり）。

### 3.5 UI/UX・ナビゲーション (`SchemaLayout`)

- **サイドバー**: 現状は各ページで個別にリンクを配置しているのみで、アプリケーション全体を横断する永続的なサイドバーが存在しない。
- **画面構成**: ユーザーからのフィードバックにある通り、1画面内で完結する操作性（サイドバーからの即時切り替え等）が不足している。
- **データ分離**: 「マスタデータ」と「トランザクションデータ（アプリケーション）」をUI上で分離する構造になっていない。モデル定義に `modelType` (Master/Transaction) などの属性が不足しており、サイドバーでのグルーピングが困難。

## 4. 残作業リスト (優先度順)

### Phase 1: 基盤コンポーネント整備 & レイアウト刷新

- [ ] `packages/ui` への `Sidebar` 関連コンポーネント実装
- [ ] `SchemaLayout` の作成と全ページへの適用 (永続的サイドバーの実現)
- [ ] `packages/ui` への `DataTable` コンポーネント実装 (TanStack Table推奨)

### Phase 2: データ構造とナビゲーションの改善

- [ ] モデル定義への `category` または `modelType` (Master/Transaction) 属性の追加
- [ ] サイドバーでの「アプリケーション（トランザクション）」と「マスタ」の分離表示実装
- [ ] `SchemaModelDefinePage` への属性設定UI追加

### Phase 3: レコード管理の高度化

- [ ] `RecordGrid` を `DataTable` に置き換え
- [ ] `WidgetRenderer` の拡充 (未実装ウィジェットの追加)
- [ ] `DynamicForm` へのバリデーションロジック実装 (React Hook Form + Zod 推奨)
- [ ] `selectbox` ウィジェットとコードマスタの連携実装

### Phase 4: モデル管理の高度化

- [ ] 階層型モデル定義のUI実装
- [ ] フィールド属性設定の完全対応

### Phase 5: その他

- [ ] エラーハンドリングの改善 (`alert` から `Toast` への移行)
- [ ] サーバーサイドページネーション・検索のAPI連携

## 5. 添付スクリーンショットからの考察

提供されたスクリーンショットを確認すると、基本的な画面遷移とレイアウトは実装されているが、詳細なUIパーツ（特にテーブルやフォームのバリデーション表示）が素朴な状態であることが確認できる。仕様書のワイヤーフレームにあるようなリッチなUI（フィルタバー、ページネーションコントロール等）が不足している。また、サイドバーが固定表示されておらず、画面遷移のたびにコンテキストが切り替わるため、業務アプリとしての操作性に課題がある。
