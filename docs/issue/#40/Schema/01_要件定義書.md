# Mirel Schema 要件定義書

## 1. 文書情報

| 項目 | 内容 |
|------|------|
| システム名 | Mirel Schema（ミレル スキーマ） |
| 版数 | 4.0 |
| 作成日 | 2025年11月28日 |
| ターゲット | mirelplatform |

---

## 2. システム概要

### 2.1 Mirel Schemaとは

Mirel Schemaは、mirelplatform上で動作する**ノーコード動的データ管理アプリケーション**です。

プログラミングなしで、ブラウザ上からデータ構造を定義し、即座にデータの登録・検索・編集が可能になります。

### 2.2 コンセプト

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Mirel Schema の世界観                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   1. モデルを定義する                                                │
│      「注文」「顧客」「商品」など、管理したいデータの構造を設計        │
│                                                                     │
│   2. フィールドを追加する                                            │
│      テキスト、日付、選択肢、ファイルなど、多様な入力形式に対応       │
│                                                                     │
│   3. 階層構造を作る                                                  │
│      モデルの中にモデルを埋め込み、複雑な構造を表現                   │
│                                                                     │
│   4. すぐに使い始める                                                │
│      定義を保存した瞬間から、データの登録・検索・編集が可能           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 解決する課題

| 従来の課題 | Mirel Schemaの解決策 |
|-----------|----------------------|
| 新しいデータ管理にはDB設計・開発が必要 | ブラウザ上でモデルを定義するだけ |
| スキーマ変更にはマイグレーションが必要 | JSONBにより柔軟なスキーマ変更が可能 |
| 画面開発に工数がかかる | モデル定義から画面を自動生成 |
| 選択肢の追加に改修が必要 | コードマスタで管理者が自由に編集 |
| 複雑なデータ構造の表現が難しい | 階層型スキーマモデルでネスト構造を実現 |

### 2.4 ターゲットユーザー

| ユーザー | 役割 |
|---------|------|
| システム管理者 | モデル定義、コードマスタの管理 |
| 業務管理者 | 新しい業務データ（台帳・マスタ）の管理 |
| エンドユーザー | データの登録・参照・更新・削除 |

---

## 3. 機能要件

### 3.1 モデル管理機能

| ID | 機能名 | 概要 |
|----|--------|------|
| FR-MDL-01 | モデル一覧取得 | 登録済みモデルの一覧を取得。非表示フラグによる表示制御 |
| FR-MDL-02 | モデル定義取得 | フィールド定義一覧の取得。階層構造の再帰的な解決 |
| FR-MDL-03 | モデル定義保存 | フィールドの追加・変更・削除。全属性の設定 |
| FR-MDL-04 | モデル削除 | モデル定義の削除 |

#### フィールド属性一覧

| 属性 | 必須 | 説明 |
|------|:----:|------|
| フィールドID (fieldId) | ○ | 一意なフィールド識別子（英数字） |
| フィールド名 (fieldName) | ○ | 画面表示名 |
| ウィジェットタイプ (widgetType) | ○ | UI部品種別 |
| データ型 (dataType) | | 内部データ型（string, number等） |
| キーフラグ (isKey) | | 主キー項目か |
| 必須フラグ (isRequired) | | 必須入力か |
| 一覧表示フラグ (isHeader) | | 一覧画面に表示するか |
| ソート順 (sort) | | 表示順序 |
| 関連コードグループ (relationCodeGroup) | | 選択肢のコードマスタ参照 |
| デフォルト値 (defaultValue) | | 新規作成時の初期値 |
| ファンクション (function) | | 自動計算・自動採番の関数式 |
| 表示幅 (displayWidth) | | 画面表示時の幅 |
| フォーマット (format) | | 表示フォーマット |
| 最大桁数 (maxDigits) | | 数値型の最大桁数 |
| 説明 (description) | | フィールドの説明 |
| 正規表現パターン (regexPattern) | | 入力値の正規表現チェック |
| 最小文字数 (minLength) | | 文字列の最小文字数 |
| 最大文字数 (maxLength) | | 文字列の最大文字数 |
| 最小値 (minValue) | | 数値の最小値 |
| 最大値 (maxValue) | | 数値の最大値 |

### 3.2 レコード管理機能

| ID | 機能名 | 概要 |
|----|--------|------|
| FR-REC-01 | レコード一覧取得 | 指定モデルの全データ一覧を取得。検索・ページネーション・ソート対応 |
| FR-REC-02 | レコード詳細取得 | 1件のデータ詳細を取得。関連コードリストも同時取得 |
| FR-REC-03 | レコード保存 | 新規登録・更新。バリデーション実行 |
| FR-REC-04 | レコード削除 | 指定データの削除 |

#### バリデーションルール

| ルール | 条件 | エラーメッセージ |
|--------|------|-----------------|
| 必須チェック | isRequired=true かつ 値がnull/空 | {fieldName}は必須項目です。 |
| キー重複チェック | isKey=trueの項目が既存レコードと重複 | キーが重複しています。 |
| 正規表現チェック | regexPattern が設定されており、入力値がマッチしない | {fieldName}の形式が正しくありません。 |
| 文字数チェック | minLength/maxLength が設定されており、範囲外 | {fieldName}は{minLength}〜{maxLength}文字で入力してください。 |
| 数値範囲チェック | minValue/maxValue が設定されており、範囲外 | {fieldName}は{minValue}〜{maxValue}の範囲で入力してください。 |

### 3.3 コードマスタ管理機能

| ID | 機能名 | 概要 |
|----|--------|------|
| FR-CODE-01 | コードグループ一覧取得 | 登録済みコードグループの一覧 |
| FR-CODE-02 | コード値一覧取得 | 指定グループのコード値一覧 |
| FR-CODE-03 | コード保存 | グループ単位でコード値を一括保存 |
| FR-CODE-04 | コードグループ削除 | グループと配下コードの削除 |

### 3.4 ファンクション機能

| ID | 機能名 | 概要 |
|----|--------|------|
| FR-FUNC-01 | ファンクション定義 | フィールドに関数式を設定 |
| FR-FUNC-02 | 組み込みファンクション | 標準関数の提供 |
| FR-FUNC-03 | プラグイン拡張 | カスタム関数の追加 |
| FR-FUNC-04 | テンプレートパース | 文字列中の関数式を解決 |

#### 組み込みファンクション一覧

| 関数名 | 引数 | 戻り値 | 説明 |
|--------|------|--------|------|
| `_uuid` | なし | String | UUID v4を生成 |
| `_now` | なし | DateTime | 現在日時を返却 |
| `_today` | なし | Date | 本日日付を返却 |
| `_seq` | prefix, digits | String | シーケンス番号を生成 |
| `_concat` | ...args | String | 引数を連結 |
| `_format` | value, pattern | String | 値をフォーマット |
| `_calc` | expression | Number | 数式を評価 |
| `_lookup` | modelId, key | Object | 他モデルの値を参照 |
| `_user` | なし | String | 現在ログインユーザー |

### 3.5 階層型スキーマモデル

モデルは**階層構造**を持つことができます。

```
注文モデル (order)
├── 注文ID (orderId) ... プリミティブ型
├── 注文日 (orderDate) ... プリミティブ型
├── 顧客情報 (customer) ... 埋め込みモデル（embedded）
│   ├── 顧客ID (customerId)
│   └── 顧客名 (customerName)
└── 明細 (items) ... 明細モデル（detail）
    ├── 商品ID (productId)
    ├── 数量 (quantity)
    └── 単価 (unitPrice)
```

#### ノードタイプ

| タイプ | 説明 |
|--------|------|
| ROOT | モデルのルートノード |
| ABSTRACT_SCHEMA | 複合スキーマ（他モデルの埋め込み） |
| PRIMITIVE_TYPE | プリミティブ型フィールド |

### 3.6 ウィジェットタイプ

| ウィジェット | データ型 | 説明 |
|-------------|---------|------|
| text | string | テキストボックス |
| textarea | string | 複数行テキスト |
| text_date | date | 日付入力 |
| text_time | time | 時刻入力 |
| checkbox | boolean | チェックボックス |
| selectbox | string | ドロップダウン選択（コードマスタ連携） |
| tag | string[] | タグ入力 |
| treeselect | string | ツリー選択 |
| htmleditor | html | リッチテキストエディタ |
| file | file | ファイルアップロード |
| embedded | model | 埋め込みモデル（1:1） |
| detail | model[] | 明細行（1:N） |
| break | - | 区切り線 |
| title | - | タイトル（見出し） |

### 3.7 アプリケーション連携機能

| ID | 機能名 | 概要 |
|----|--------|------|
| FR-APP-01 | アプリケーション一覧取得 | mirelplatformに登録されているアプリケーション（Schema, Mste等）の一覧を取得 |

#### 用途

- サイドバーやナビゲーションでのアプリ切り替え表示
- ユーザーがアクセス可能なアプリケーションの動的表示
- ダッシュボードでの統合メニュー構築

---

## 4. 非機能要件

### 4.1 性能要件

| 項目 | 要件 |
|------|------|
| API応答時間 | 95%タイルで500ms以内 |
| 同時接続数 | 100ユーザー |
| データ量 | 1モデルあたり100万レコード |
| 画面表示 | First Contentful Paint < 1.5秒 |

### 4.2 拡張性要件

| 項目 | 要件 |
|------|------|
| スキーマ階層 | 最大100階層のネストをサポート |
| フィールド数 | 1モデルあたり最大1000フィールド |
| ウィジェット拡張 | 新規ウィジェットタイプの追加が可能 |
| ファンクション拡張 | プラグイン方式でカスタム関数追加可能 |

### 4.3 セキュリティ要件

| 項目 | 要件 |
|------|------|
| 認証 | mirelplatform認証基盤（JWT）との連携 |
| 認可 | Spring Securityによるエンドポイント保護 |
| 通信 | HTTPS必須 |

### 4.4 運用性要件

| 項目 | 要件 |
|------|------|
| ログ出力 | 操作ログ、エラーログの出力 |
| 監視 | Spring Boot Actuatorによるヘルスチェック |

### 4.5 マルチテナント要件

| 項目 | 要件 |
|------|------|
| テナント分離 | 全データにテナントIDを付与し論理分離 |
| テナント識別 | JWTトークンまたはリクエストヘッダーからテナント特定 |
| データ隔離 | Row Level Security（RLS）によるDB層での強制分離 |
| テナント管理 | mirelplatformの `mir_tenant` テーブルと連携 |

### 4.6 権限管理要件

| 項目 | 要件 |
|------|------|
| ロールベース認可 | mirelplatformの `mir_role` / `mir_user_role` と連携したRBAC |
| モデル単位権限 | モデルごとに参照/作成/更新/削除の権限設定 |
| フィールド単位権限 | 機密フィールドの参照制限（将来拡張） |
| ロール管理 | バージョン管理（楽観的ロック）と論理削除対応 |

### 4.7 監査・トレーサビリティ要件

| 項目 | 要件 |
|------|------|
| 変更履歴 | レコードの変更履歴（誰が・いつ・何を変更）を保持 |
| 操作ログ | 全API操作のログ記録 |
| データリネージ | 変更前後の値を記録 |

### 4.8 外部連携要件

| 項目 | 要件 |
|------|------|
| Webhook | レコード変更時に外部URLへ通知 |
| イベント発行 | 内部イベントバスへの発行 |
| 外部ストレージ | S3互換オブジェクトストレージ対応 |

### 4.9 キャッシュ要件

| 項目 | 要件 |
|------|------|
| メタデータキャッシュ | モデル定義・コードマスタのRedisキャッシュ |
| キャッシュ無効化 | 定義変更時の自動パージ |
| TTL | 設定可能なキャッシュ有効期限 |

### 4.10 排他制御要件

| 項目 | 要件 |
|------|------|
| 楽観的ロック | 全エンティティにバージョンカラム（version）を付与 |
| 更新時チェック | 更新時にバージョンを比較し、競合時はエラー返却 |
| 競合メッセージ | 「他のユーザーにより更新されました。再読み込みしてください。」 |

### 4.11 例外処理要件

| 例外種別 | 説明 | ユーザーへの表示 | ログ出力 |
|----------|------|------------------|----------|
| BusinessException | 業務エラー（入力値不正、権限不足等） | エラーメッセージをそのまま表示 | WARNレベルでスタックトレース出力 |
| SystemException | システムエラー（DB接続失敗、外部連携エラー等） | 「システムエラーが発生しました。管理者に連絡してください。」 | ERRORレベルでスタックトレース出力 |

#### エラーコード体系

| コード範囲 | カテゴリ | 例 |
|-----------|----------|-----|
| SCH-V-XXX | バリデーションエラー | SCH-V-001: 必須項目未入力 |
| SCH-D-XXX | データ整合性エラー | SCH-D-001: キー重複 |
| SCH-A-XXX | 認証・認可エラー | SCH-A-001: 権限不足 |
| SCH-S-XXX | システムエラー | SCH-S-001: DB接続エラー |

### 4.12 論理削除・物理削除要件

| 対象 | 削除方式 | 理由 |
|------|----------|------|
| ロール | 論理削除（delete_flag） | 監査ログとの整合性維持 |
| レコード | 物理削除 | ユーザーデータは完全削除が原則 |
| モデル定義 | 論理削除（is_hidden） | 既存レコードへの参照整合性維持 |
| コードマスタ | 論理削除（is_deleted） | 既存レコードでの参照値維持 |

---

## 5. 技術スタック

### 5.1 バックエンド

| 項目 | 技術 |
|------|------|
| 言語 | Java 21 (LTS) |
| フレームワーク | Spring Boot 3.3 |
| ORM | Spring Data JPA |
| データベース | PostgreSQL (JSONB対応) |
| API仕様 | OpenAPI 3.0 / Swagger UI |

### 5.2 フロントエンド

| 項目 | 技術 |
|------|------|
| 言語 | TypeScript |
| フレームワーク | React 18 |
| ビルド | Vite |
| 状態管理 | TanStack Query |
| UIライブラリ | @mirel/ui (Radix UI + Tailwind CSS) |
| ルーティング | React Router v7 |

---

## 6. 用語定義

| 用語 | 定義 |
|------|------|
| モデル (Model) | データ構造の定義（テーブル定義に相当） |
| スキーマ (Schema) | モデルの別名、または複合スキーマ |
| レコード (Record) | モデルに基づいて登録された実データ |
| ディクショナリ (Dictionary) | モデルのフィールド定義情報 |
| フィールド (Field) | モデルを構成する項目（カラムに相当） |
| プリミティブ型 | 文字列、数値、日付など基本的なデータ型 |
| ウィジェット (Widget) | フィールドの入力形式（UI部品種別） |
| コードグループ | 選択肢のグループ（例: ステータス） |
| ファンクション | フィールドに設定する関数式 |

---

## 7. 関連文書

| 文書名 | 概要 |
|--------|------|
| [02_システム設計書](02_システム設計書.md) | アーキテクチャ、レイヤー構成 |
| [03_API設計書](03_API設計書.md) | エンドポイント、リクエスト/レスポンス仕様 |
| [04_データベース設計書](04_データベース設計書.md) | テーブル定義、ER図 |
| [05_画面設計書](05_画面設計書.md) | 画面一覧、モックアップ |
