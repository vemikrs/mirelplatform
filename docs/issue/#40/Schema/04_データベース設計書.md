# Mirel Schema データベース設計書

## 1. 文書情報

| 項目 | 内容 |
|------|------|
| システム名 | Mirel Schema（ミレル スキーマ） |
| 版数 | 3.0 |
| 作成日 | 2025年11月28日 |
| データベース | PostgreSQL |

---

## 2. テーブル一覧

| No. | テーブル名 | 論理名 | 概要 |
|-----|-----------|--------|------|
| 1 | sch_record | レコード | ユーザーデータ（JSONB格納） |
| 2 | sch_dic_model | モデル定義 | フィールド定義 |
| 3 | sch_dic_model_header | モデルヘッダー | モデルのメタ情報 |
| 4 | sch_dic_code | コードマスタ | 選択肢の値 |

### 2.1 設計方針

| 方針 | 説明 |
|------|------|
| 楽観的ロック | 全テーブルに `version` カラムを追加し更新競合を検出 |
| 論理削除 | ロール・コードマスタは `delete_flag` で論理削除、レコードは物理削除 |
| 監査カラム | 全テーブルに作成者/作成日時/更新者/更新日時を持つ |
| mirelplatform準拠 | `mir_role`, `mir_tenant` 等のplatformテーブルと命名・構造を統一 |

---

## 3. ER図

```
┌─────────────────────────┐          ┌────────────────────────────┐
│  sch_dic_model_header   │          │       sch_dic_code         │
├─────────────────────────┤          ├────────────────────────────┤
│ PK model_id             │          │ PK group_id                │
│    model_name           │          │ PK code                    │
│    description          │          │    group_text              │
│    is_hidden            │          │    text                    │
│    created_at           │          │    sort                    │
│    created_by           │          │    created_at              │
│    updated_at           │          │    created_by              │
│    updated_by           │          │    updated_at              │
└───────────┬─────────────┘          │    updated_by              │
            │                        └──────────────┬─────────────┘
            │ 1                                     │
            │                                       │
            │ n                                     │ n
            ▼                                       │
┌─────────────────────────┐                         │
│     sch_dic_model       │◄────────────────────────┘
├─────────────────────────┤    relation_code_group
│ PK model_id             │
│ PK field_id             │
│    is_key               │
│    field_name           │
│    widget_type          │
│    data_type            │◄─────────┐
│    description          │          │ data_type が
│    sort                 │          │ primitive 型でない場合
│    is_header            │          │ 他のモデルを参照
│    display_width        │──────────┘
│    format               │     自己参照（再帰）
│    constraint_id        │
│    max_digits           │
│    is_required          │
│    default_value        │
│    relation_code_group  │
│    function             │
│    regex_pattern        │
│    min_length           │
│    max_length           │
│    min_value            │
│    max_value            │
│    created_at           │
│    created_by           │
│    updated_at           │
│    updated_by           │
└───────────┬─────────────┘
            │
            │ model_id = schema
            │
            │ n
            ▼
┌─────────────────────────┐
│      sch_record         │
├─────────────────────────┤
│ PK id                   │
│    schema               │
│    record_data          │ ◄─── JSONB形式で
│    text                 │      モデル定義に基づく
│    created_at           │      可変構造データを格納
│    created_by           │
│    updated_at           │
│    updated_by           │
└─────────────────────────┘
```

---

## 4. テーブル詳細

### 4.1 sch_record（レコード）

#### 概要

ユーザーが登録したレコードデータを格納するテーブル。
データ本体はJSONB形式で格納され、柔軟なスキーマ変更に対応。

#### カラム定義

| No. | カラム名 | 論理名 | データ型 | PK | NOT NULL | デフォルト | 備考 |
|-----|----------|--------|----------|:--:|:--------:|------------|------|
| 1 | id | レコードID | VARCHAR(36) | ○ | ○ | - | UUID形式 |
| 2 | schema | スキーマID | VARCHAR(255) | - | - | - | モデルIDを参照 |
| 3 | record_data | レコードデータ | JSONB | - | - | - | 可変構造のデータ本体 |
| 4 | text | テキスト | VARCHAR(255) | - | - | - | 一覧表示用サマリーテキスト |
| 5 | version | バージョン | INTEGER | - | ○ | 1 | 楽観的ロック用 |
| 6 | created_at | 作成日時 | TIMESTAMP | - | ○ | CURRENT_TIMESTAMP | 監査用 |
| 7 | created_by | 作成者 | VARCHAR(255) | - | ○ | - | 監査用 |
| 8 | updated_at | 更新日時 | TIMESTAMP | - | ○ | CURRENT_TIMESTAMP | 監査用 |
| 9 | updated_by | 更新者 | VARCHAR(255) | - | ○ | - | 監査用 |

#### インデックス

| No. | インデックス名 | カラム | ユニーク | 備考 |
|-----|---------------|--------|:-------:|------|
| 1 | pk_sch_record | id | ○ | 主キー |
| 2 | idx_sch_record_schema | schema | - | モデル検索用 |
| 3 | idx_sch_record_updated | updated_at | - | 日付ソート用 |
| 4 | idx_sch_record_data_gin | record_data | - | JSONB GINインデックス（全文検索用） |

#### JSONB構造例

```json
{
  "orderId": "ORD-2024-001",
  "orderDate": "2024-01-15",
  "customerName": "株式会社サンプル",
  "totalAmount": 150000,
  "status": "confirmed",
  "items": [
    {
      "productId": "PROD-001",
      "quantity": 10,
      "unitPrice": 10000
    }
  ],
  "shippingAddress": {
    "postalCode": "100-0001",
    "city": "千代田区"
  }
}
```

---

### 4.2 sch_dic_model（モデル定義）

#### 概要

モデルのフィールド定義を格納するテーブル。
各フィールドの属性（型、必須、キー、バリデーションルールなど）を管理。

#### カラム定義

| No. | カラム名 | 論理名 | データ型 | PK | NOT NULL | デフォルト | 備考 |
|-----|----------|--------|----------|:--:|:--------:|------------|------|
| 1 | model_id | モデルID | VARCHAR(255) | ○ | ○ | - | 複合主キー |
| 2 | field_id | フィールドID | VARCHAR(255) | ○ | ○ | - | 複合主キー |
| 3 | is_key | キーフラグ | BOOLEAN | - | - | false | 主キー項目か |
| 4 | field_name | フィールド名 | VARCHAR(255) | - | - | - | 表示名 |
| 5 | widget_type | ウィジェット型 | VARCHAR(50) | - | - | - | UI部品種別 |
| 6 | data_type | データ型 | VARCHAR(50) | - | - | - | 内部データ型 |
| 7 | description | 説明 | TEXT | - | - | - | フィールドの説明 |
| 8 | sort | ソート順 | BIGINT | - | - | - | 表示順序 |
| 9 | is_header | 一覧表示フラグ | BOOLEAN | - | - | false | 一覧画面に表示するか |
| 10 | display_width | 表示幅 | BIGINT | - | - | - | 画面表示時の幅 |
| 11 | format | フォーマット | VARCHAR(255) | - | - | - | 表示フォーマット |
| 12 | constraint_id | 制約ID | VARCHAR(255) | - | - | - | 制約定義への参照 |
| 13 | max_digits | 最大桁数 | DECIMAL | - | - | - | 数値型の最大桁数 |
| 14 | is_required | 必須フラグ | BOOLEAN | - | - | false | 必須入力か |
| 15 | default_value | デフォルト値 | TEXT | - | - | - | 新規作成時のデフォルト |
| 16 | relation_code_group | 関連コードグループ | VARCHAR(255) | - | - | - | コードマスタ参照 |
| 17 | function | ファンクション | TEXT | - | - | - | 計算式・関数定義 |
| 18 | regex_pattern | 正規表現パターン | VARCHAR(500) | - | - | - | 入力値の正規表現チェック |
| 19 | min_length | 最小文字数 | INTEGER | - | - | - | 文字数制限（最小） |
| 20 | max_length | 最大文字数 | INTEGER | - | - | - | 文字数制限（最大） |
| 21 | min_value | 最小値 | DECIMAL | - | - | - | 数値範囲制限（最小） |
| 22 | max_value | 最大値 | DECIMAL | - | - | - | 数値範囲制限（最大） |
| 23 | version | バージョン | INTEGER | - | ○ | 1 | 楽観的ロック用 |
| 24 | created_at | 作成日時 | TIMESTAMP | - | ○ | CURRENT_TIMESTAMP | 監査用 |
| 25 | created_by | 作成者 | VARCHAR(255) | - | ○ | - | 監査用 |
| 26 | updated_at | 更新日時 | TIMESTAMP | - | ○ | CURRENT_TIMESTAMP | 監査用 |
| 27 | updated_by | 更新者 | VARCHAR(255) | - | ○ | - | 監査用 |

#### インデックス

| No. | インデックス名 | カラム | ユニーク | 備考 |
|-----|---------------|--------|:-------:|------|
| 1 | pk_sch_dic_model | model_id, field_id | ○ | 複合主キー |
| 2 | idx_sch_dic_model_model | model_id | - | モデル検索用 |

---

### 4.3 sch_dic_model_header（モデルヘッダー）

#### 概要

モデルのヘッダー情報を格納するテーブル。
モデル名や表示制御情報を管理。

#### カラム定義

| No. | カラム名 | 論理名 | データ型 | PK | NOT NULL | デフォルト | 備考 |
|-----|----------|--------|----------|:--:|:--------:|------------|------|
| 1 | model_id | モデルID | VARCHAR(255) | ○ | ○ | - | 主キー |
| 2 | model_name | モデル名 | VARCHAR(255) | - | - | - | 表示名 |
| 3 | description | 説明 | TEXT | - | - | - | モデルの説明 |
| 4 | is_hidden | 非表示フラグ | BOOLEAN | - | - | false | 一覧に表示しないか |
| 5 | version | バージョン | INTEGER | - | ○ | 1 | 楽観的ロック用 |
| 6 | created_at | 作成日時 | TIMESTAMP | - | ○ | CURRENT_TIMESTAMP | 監査用 |
| 7 | created_by | 作成者 | VARCHAR(255) | - | ○ | - | 監査用 |
| 8 | updated_at | 更新日時 | TIMESTAMP | - | ○ | CURRENT_TIMESTAMP | 監査用 |
| 9 | updated_by | 更新者 | VARCHAR(255) | - | ○ | - | 監査用 |

#### インデックス

| No. | インデックス名 | カラム | ユニーク | 備考 |
|-----|---------------|--------|:-------:|------|
| 1 | pk_sch_dic_model_header | model_id | ○ | 主キー |

---

### 4.4 sch_dic_code（コードマスタ）

#### 概要

選択肢などに使用するコード値を格納するマスタテーブル。
グループ単位でコード値を管理。

#### カラム定義

| No. | カラム名 | 論理名 | データ型 | PK | NOT NULL | デフォルト | 備考 |
|-----|----------|--------|----------|:--:|:--------:|------------|------|
| 1 | group_id | グループID | VARCHAR(255) | ○ | ○ | - | 複合主キー |
| 2 | code | コード | VARCHAR(255) | ○ | ○ | - | 複合主キー |
| 3 | group_text | グループ表示名 | VARCHAR(255) | - | - | - | グループの表示名 |
| 4 | text | 表示テキスト | VARCHAR(255) | - | - | - | コード値の表示名 |
| 5 | sort | ソート順 | BIGINT | - | - | - | 表示順序 |
| 6 | delete_flag | 削除フラグ | BOOLEAN | - | ○ | false | 論理削除フラグ |
| 7 | version | バージョン | INTEGER | - | ○ | 1 | 楽観的ロック用 |
| 8 | created_at | 作成日時 | TIMESTAMP | - | ○ | CURRENT_TIMESTAMP | 監査用 |
| 9 | created_by | 作成者 | VARCHAR(255) | - | ○ | - | 監査用 |
| 10 | updated_at | 更新日時 | TIMESTAMP | - | ○ | CURRENT_TIMESTAMP | 監査用 |
| 11 | updated_by | 更新者 | VARCHAR(255) | - | ○ | - | 監査用 |

#### インデックス

| No. | インデックス名 | カラム | ユニーク | 備考 |
|-----|---------------|--------|:-------:|------|
| 1 | pk_sch_dic_code | group_id, code | ○ | 複合主キー |
| 2 | idx_sch_dic_code_group | group_id | - | グループ検索用 |

---

## 5. データ型マッピング

### 5.1 プリミティブデータ型

| 論理型 | Java | PostgreSQL | 説明 |
|--------|------|------------|------|
| string | String | VARCHAR/TEXT | 文字列 |
| number | BigDecimal/Long | NUMERIC/BIGINT | 数値 |
| date | LocalDate | DATE | 日付 |
| time | LocalTime | TIME | 時刻 |
| datetime | LocalDateTime | TIMESTAMP | 日時 |
| boolean | Boolean | BOOLEAN | 真偽値 |
| file | String | VARCHAR | ファイルパス |
| html | String | TEXT | HTMLコンテンツ |

### 5.2 ウィジェットタイプ

| ウィジェット | データ型 | 格納形式 |
|-------------|---------|---------|
| text | string | VARCHAR |
| textarea | string | TEXT |
| text_date | date | DATE文字列 |
| text_time | time | TIME文字列 |
| checkbox | boolean | true/false |
| selectbox | string | コード値 |
| tag | string[] | JSON配列 |
| treeselect | string | コード値 |
| htmleditor | html | HTML文字列 |
| file | file | ファイルパス |
| embedded | model | JSONオブジェクト |
| detail | model[] | JSON配列 |

---

## 6. Javaエンティティ

### 6.1 SchRecord

```java
@Entity
@Table(name = "sch_record")
@EntityListeners(AuditingEntityListener.class)
public class SchRecord {
    
    @Id
    @Column(name = "id", length = 36)
    private String id;
    
    @Column(name = "schema")
    private String schema;
    
    @Type(JsonBinaryType.class)
    @Column(name = "record_data", columnDefinition = "jsonb")
    private Map<String, Object> recordData;
    
    @Column(name = "text")
    private String text;
    
    @Version
    @Column(name = "version")
    private Integer version;
    
    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    @CreatedBy
    @Column(name = "created_by", nullable = false, updatable = false)
    private String createdBy;
    
    @LastModifiedDate
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @LastModifiedBy
    @Column(name = "updated_by", nullable = false)
    private String updatedBy;
}
```

### 6.2 SchDicModel

```java
@Entity
@Table(name = "sch_dic_model")
@EntityListeners(AuditingEntityListener.class)
public class SchDicModel {
    
    @EmbeddedId
    private PK pk;
    
    @Column(name = "is_key")
    private Boolean isKey;
    
    @Column(name = "field_name")
    private String fieldName;
    
    @Column(name = "widget_type")
    private String widgetType;
    
    @Column(name = "data_type")
    private String dataType;
    
    @Column(name = "description")
    private String description;
    
    @Column(name = "sort")
    @OrderBy("ASC")
    private Long sort;
    
    @Column(name = "is_header")
    private Boolean isHeader;
    
    @Column(name = "display_width")
    private Long displayWidth;
    
    @Column(name = "format")
    private String format;
    
    @Column(name = "constraint_id")
    private String constraintId;
    
    @Column(name = "max_digits")
    private BigDecimal maxDigits;
    
    @Column(name = "is_required")
    private Boolean isRequired;
    
    @Column(name = "default_value")
    private String defaultValue;
    
    @Column(name = "relation_code_group")
    private String relationCodeGroup;
    
    @Column(name = "function")
    private String function;
    
    // バリデーション属性
    @Column(name = "regex_pattern", length = 500)
    private String regexPattern;
    
    @Column(name = "min_length")
    private Integer minLength;
    
    @Column(name = "max_length")
    private Integer maxLength;
    
    @Column(name = "min_value")
    private BigDecimal minValue;
    
    @Column(name = "max_value")
    private BigDecimal maxValue;
    
    // 楽観的ロック
    @Version
    @Column(name = "version")
    private Integer version;
    
    // 監査カラム
    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    @CreatedBy
    @Column(name = "created_by", nullable = false, updatable = false)
    private String createdBy;
    
    @LastModifiedDate
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @LastModifiedBy
    @Column(name = "updated_by", nullable = false)
    private String updatedBy;
    
    @Embeddable
    public static class PK implements Serializable {
        @Column(name = "model_id")
        private String modelId;
        
        @Column(name = "field_id")
        private String fieldId;
    }
}
```

### 6.3 SchDicModelHeader

```java
@Entity
@Table(name = "sch_dic_model_header")
@EntityListeners(AuditingEntityListener.class)
public class SchDicModelHeader {
    
    @Id
    @Column(name = "model_id")
    private String modelId;
    
    @Column(name = "model_name")
    private String modelName;
    
    @Column(name = "description")
    private String description;
    
    @Column(name = "is_hidden")
    private Boolean isHidden;
    
    @Version
    @Column(name = "version")
    private Integer version;
    
    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    @CreatedBy
    @Column(name = "created_by", nullable = false, updatable = false)
    private String createdBy;
    
    @LastModifiedDate
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @LastModifiedBy
    @Column(name = "updated_by", nullable = false)
    private String updatedBy;
}
```

### 6.4 SchDicCode

```java
@Entity
@Table(name = "sch_dic_code")
@EntityListeners(AuditingEntityListener.class)
public class SchDicCode {
    
    @EmbeddedId
    private PK pk;
    
    @Column(name = "group_text")
    private String groupText;
    
    @Column(name = "text")
    private String text;
    
    @Column(name = "sort")
    private Long sort;
    
    @Column(name = "delete_flag")
    private Boolean deleteFlag;
    
    @Version
    @Column(name = "version")
    private Integer version;
    
    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    @CreatedBy
    @Column(name = "created_by", nullable = false, updatable = false)
    private String createdBy;
    
    @LastModifiedDate
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @LastModifiedBy
    @Column(name = "updated_by", nullable = false)
    private String updatedBy;
    
    @Embeddable
    public static class PK implements Serializable {
        @Column(name = "group_id")
        private String groupId;
        
        @Column(name = "code")
        private String code;
    }
}
```

---

## 7. DDL

```sql
-- レコードテーブル
CREATE TABLE sch_record (
    id VARCHAR(36) PRIMARY KEY,
    schema VARCHAR(255),
    record_data JSONB,
    text VARCHAR(255),
    version INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(255) NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(255) NOT NULL
);

CREATE INDEX idx_sch_record_schema ON sch_record(schema);
CREATE INDEX idx_sch_record_updated ON sch_record(updated_at DESC);

-- JSONB GINインデックス（全文検索用）
CREATE INDEX idx_sch_record_data_gin ON sch_record USING GIN (record_data);

-- モデル定義テーブル
CREATE TABLE sch_dic_model (
    model_id VARCHAR(255) NOT NULL,
    field_id VARCHAR(255) NOT NULL,
    is_key BOOLEAN DEFAULT FALSE,
    field_name VARCHAR(255),
    widget_type VARCHAR(50),
    data_type VARCHAR(50),
    description TEXT,
    sort BIGINT,
    is_header BOOLEAN DEFAULT FALSE,
    display_width BIGINT,
    format VARCHAR(255),
    constraint_id VARCHAR(255),
    max_digits DECIMAL,
    is_required BOOLEAN DEFAULT FALSE,
    default_value TEXT,
    relation_code_group VARCHAR(255),
    function TEXT,
    regex_pattern VARCHAR(500),
    min_length INTEGER,
    max_length INTEGER,
    min_value DECIMAL,
    max_value DECIMAL,
    version INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(255) NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(255) NOT NULL,
    PRIMARY KEY (model_id, field_id)
);

CREATE INDEX idx_sch_dic_model_model ON sch_dic_model(model_id);

-- モデルヘッダーテーブル
CREATE TABLE sch_dic_model_header (
    model_id VARCHAR(255) PRIMARY KEY,
    model_name VARCHAR(255),
    description TEXT,
    is_hidden BOOLEAN DEFAULT FALSE,
    version INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(255) NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(255) NOT NULL
);

-- コードマスタテーブル
CREATE TABLE sch_dic_code (
    group_id VARCHAR(255) NOT NULL,
    code VARCHAR(255) NOT NULL,
    group_text VARCHAR(255),
    text VARCHAR(255),
    sort BIGINT,
    delete_flag BOOLEAN NOT NULL DEFAULT FALSE,
    version INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(255) NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(255) NOT NULL,
    PRIMARY KEY (group_id, code)
);

CREATE INDEX idx_sch_dic_code_group ON sch_dic_code(group_id);
CREATE INDEX idx_sch_dic_code_active ON sch_dic_code(group_id) WHERE delete_flag = FALSE;
```

---

## 8. トリガー（監査カラム自動更新）

```sql
-- 更新日時自動更新用トリガー関数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- 各テーブルへのトリガー適用
CREATE TRIGGER update_sch_record_updated_at
    BEFORE UPDATE ON sch_record
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_sch_dic_model_updated_at
    BEFORE UPDATE ON sch_dic_model
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_sch_dic_model_header_updated_at
    BEFORE UPDATE ON sch_dic_model_header
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_sch_dic_code_updated_at
    BEFORE UPDATE ON sch_dic_code
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

---

## 9. JSONBクエリ例

### 9.1 キーワード検索

```sql
-- 全フィールドからキーワード検索
SELECT * FROM sch_record
WHERE schema = 'order'
  AND record_data::text ILIKE '%サンプル%';
```

### 9.2 特定フィールドのフィルタリング

```sql
-- ステータスが"confirmed"のレコード
SELECT * FROM sch_record
WHERE schema = 'order'
  AND record_data->>'status' = 'confirmed';

-- 金額が10000以上のレコード
SELECT * FROM sch_record
WHERE schema = 'order'
  AND (record_data->>'totalAmount')::numeric >= 10000;

-- 日付範囲検索
SELECT * FROM sch_record
WHERE schema = 'order'
  AND record_data->>'orderDate' >= '2024-01-01'
  AND record_data->>'orderDate' <= '2024-12-31';
```

### 9.3 ネストしたJSONBの検索

```sql
-- 配送先都市で検索
SELECT * FROM sch_record
WHERE schema = 'order'
  AND record_data->'shippingAddress'->>'city' = '千代田区';

-- 明細に特定商品を含む注文
SELECT * FROM sch_record
WHERE schema = 'order'
  AND record_data->'items' @> '[{"productId": "PROD-001"}]';
```

---

## 10. マイグレーション

Flywayを使用したマイグレーション例:

```
backend/src/main/resources/db/migration/
├── V1__create_schema_tables.sql
├── V2__add_validation_columns.sql
├── V3__add_audit_columns.sql
├── V4__add_jsonb_gin_index.sql
├── V5__create_audit_triggers.sql
├── V6__add_tenant_columns.sql
├── V7__create_permission_tables.sql
├── V8__create_audit_log_table.sql
├── V9__create_webhook_tables.sql
└── V10__create_rls_policies.sql
```

---

## 11. マルチテナント設計

### 11.1 テナントカラム追加

全テーブルに `tenant_id` カラムを追加し、Row Level Security (RLS) で分離を強制します。

```sql
-- テナントカラム追加
ALTER TABLE sch_record ADD COLUMN tenant_id VARCHAR(50) NOT NULL;
ALTER TABLE sch_dic_model ADD COLUMN tenant_id VARCHAR(50) NOT NULL;
ALTER TABLE sch_dic_model_header ADD COLUMN tenant_id VARCHAR(50) NOT NULL;
ALTER TABLE sch_dic_code ADD COLUMN tenant_id VARCHAR(50) NOT NULL;

-- テナント用インデックス
CREATE INDEX idx_sch_record_tenant ON sch_record(tenant_id);
CREATE INDEX idx_sch_dic_model_tenant ON sch_dic_model(tenant_id);
CREATE INDEX idx_sch_dic_model_header_tenant ON sch_dic_model_header(tenant_id);
CREATE INDEX idx_sch_dic_code_tenant ON sch_dic_code(tenant_id);
```

### 11.2 Row Level Security (RLS)

```sql
-- RLS有効化
ALTER TABLE sch_record ENABLE ROW LEVEL SECURITY;
ALTER TABLE sch_dic_model ENABLE ROW LEVEL SECURITY;
ALTER TABLE sch_dic_model_header ENABLE ROW LEVEL SECURITY;
ALTER TABLE sch_dic_code ENABLE ROW LEVEL SECURITY;

-- テナント分離ポリシー
CREATE POLICY tenant_isolation_record ON sch_record
    USING (tenant_id = current_setting('app.tenant_id'));

CREATE POLICY tenant_isolation_dic_model ON sch_dic_model
    USING (tenant_id = current_setting('app.tenant_id'));

CREATE POLICY tenant_isolation_dic_model_header ON sch_dic_model_header
    USING (tenant_id = current_setting('app.tenant_id'));

CREATE POLICY tenant_isolation_dic_code ON sch_dic_code
    USING (tenant_id = current_setting('app.tenant_id'));
```

### 11.3 テナントテーブル

```sql
CREATE TABLE sch_tenant (
    tenant_id       VARCHAR(50) PRIMARY KEY,
    tenant_name     VARCHAR(200) NOT NULL,
    status          VARCHAR(20) NOT NULL DEFAULT 'active',  -- active, suspended, deleted
    plan            VARCHAR(50) NOT NULL DEFAULT 'standard',
    settings        JSONB,
    created_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by      VARCHAR(100) NOT NULL,
    updated_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by      VARCHAR(100) NOT NULL
);
```

---

## 12. 権限管理テーブル

### 12.1 ER図

```
┌─────────────────┐     ┌──────────────────┐     ┌──────────────────────┐
│   sch_user      │     │    sch_role      │     │   sch_permission     │
├─────────────────┤     ├──────────────────┤     ├──────────────────────┤
│ PK user_id      │     │ PK role_id       │     │ PK permission_id     │
│    tenant_id    │     │    tenant_id     │     │    role_id (FK)      │
│    email        │     │    role_name     │     │    resource_type     │
│    display_name │     │    description   │     │    resource_id       │
└────────┬────────┘     └────────┬─────────┘     │    action            │
         │                       │               └──────────────────────┘
         │                       │
         └─────────┬─────────────┘
                   ▼
         ┌──────────────────┐
         │  sch_user_role   │
         ├──────────────────┤
         │ PK user_id (FK)  │
         │ PK role_id (FK)  │
         └──────────────────┘
```

### 12.2 テーブル定義

```sql
-- ロールテーブル（mirelplatform mir_role準拠）
CREATE TABLE sch_role (
    role_id         VARCHAR(50) PRIMARY KEY,
    tenant_id       VARCHAR(50) NOT NULL,
    role_name       VARCHAR(100) NOT NULL,
    description     TEXT,
    is_system       BOOLEAN NOT NULL DEFAULT FALSE,  -- システム定義ロール
    delete_flag     BOOLEAN NOT NULL DEFAULT FALSE,  -- 論理削除フラグ
    version         INTEGER NOT NULL DEFAULT 1,      -- 楽観的ロック
    created_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by      VARCHAR(100) NOT NULL,
    updated_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by      VARCHAR(100) NOT NULL
);

CREATE INDEX idx_sch_role_tenant ON sch_role(tenant_id);
CREATE INDEX idx_sch_role_active ON sch_role(tenant_id) WHERE delete_flag = FALSE;

-- ユーザー・ロール関連（mirelplatform mir_user_role準拠）
CREATE TABLE sch_user_role (
    user_id         VARCHAR(100) NOT NULL,
    role_id         VARCHAR(50) NOT NULL,
    tenant_id       VARCHAR(50) NOT NULL,
    version         INTEGER NOT NULL DEFAULT 1,
    created_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by      VARCHAR(100) NOT NULL,
    PRIMARY KEY (user_id, role_id)
);

CREATE INDEX idx_sch_user_role_tenant ON sch_user_role(tenant_id);

-- 権限テーブル
CREATE TABLE sch_permission (
    permission_id   SERIAL PRIMARY KEY,
    role_id         VARCHAR(50) NOT NULL REFERENCES sch_role(role_id) ON DELETE CASCADE,
    resource_type   VARCHAR(50) NOT NULL,   -- 'model', 'code', 'all'
    resource_id     VARCHAR(100),           -- NULL = 全リソース
    action          VARCHAR(20) NOT NULL,   -- 'read', 'create', 'update', 'delete', 'admin'
    version         INTEGER NOT NULL DEFAULT 1,
    created_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by      VARCHAR(100) NOT NULL
);

CREATE INDEX idx_sch_permission_role ON sch_permission(role_id);
CREATE UNIQUE INDEX idx_sch_permission_unique ON sch_permission(role_id, resource_type, COALESCE(resource_id, ''), action);
```

### 12.3 初期データ

```sql
-- システム定義ロール
INSERT INTO sch_role (role_id, tenant_id, role_name, description, is_system) VALUES
('admin', 'system', '管理者', 'すべての操作が可能', TRUE),
('editor', 'system', '編集者', 'レコードの参照・作成・更新が可能', TRUE),
('viewer', 'system', '閲覧者', 'レコードの参照のみ可能', TRUE);

-- 管理者権限
INSERT INTO sch_permission (role_id, resource_type, resource_id, action, created_by) VALUES
('admin', 'all', NULL, 'admin', 'system');

-- 編集者権限
INSERT INTO sch_permission (role_id, resource_type, resource_id, action, created_by) VALUES
('editor', 'model', NULL, 'read', 'system'),
('editor', 'model', NULL, 'create', 'system'),
('editor', 'model', NULL, 'update', 'system');

-- 閲覧者権限
INSERT INTO sch_permission (role_id, resource_type, resource_id, action, created_by) VALUES
('viewer', 'model', NULL, 'read', 'system');
```

---

## 13. 監査ログテーブル

### 13.1 テーブル定義

```sql
CREATE TABLE sch_audit_log (
    audit_id        BIGSERIAL PRIMARY KEY,
    tenant_id       VARCHAR(50) NOT NULL,
    user_id         VARCHAR(100) NOT NULL,
    action          VARCHAR(20) NOT NULL,       -- CREATE, UPDATE, DELETE, READ
    resource_type   VARCHAR(50) NOT NULL,       -- record, model, code
    resource_id     VARCHAR(100) NOT NULL,
    old_value       JSONB,                       -- 変更前の値（UPDATEのみ）
    new_value       JSONB,                       -- 変更後の値（CREATEとUPDATE）
    diff            JSONB,                       -- 差分情報
    ip_address      INET,
    user_agent      TEXT,
    trace_id        VARCHAR(100),                -- リクエストトレースID
    created_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 検索用インデックス
CREATE INDEX idx_audit_log_tenant ON sch_audit_log(tenant_id);
CREATE INDEX idx_audit_log_user ON sch_audit_log(tenant_id, user_id);
CREATE INDEX idx_audit_log_resource ON sch_audit_log(tenant_id, resource_type, resource_id);
CREATE INDEX idx_audit_log_action ON sch_audit_log(tenant_id, action);
CREATE INDEX idx_audit_log_created ON sch_audit_log(tenant_id, created_at DESC);

-- パーティショニング（大量ログ対応）
-- 月次パーティションの例
CREATE TABLE sch_audit_log_y2024m01 PARTITION OF sch_audit_log
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

### 13.2 監査ログ例

```json
{
  "audit_id": 12345,
  "tenant_id": "tenant-001",
  "user_id": "user-123",
  "action": "UPDATE",
  "resource_type": "record",
  "resource_id": "order-456",
  "old_value": {
    "status": "draft",
    "totalAmount": 10000
  },
  "new_value": {
    "status": "confirmed",
    "totalAmount": 12000
  },
  "diff": {
    "status": { "from": "draft", "to": "confirmed" },
    "totalAmount": { "from": 10000, "to": 12000 }
  },
  "ip_address": "192.168.1.100",
  "trace_id": "abc-123-def-456",
  "created_at": "2024-11-28T10:30:00"
}
```

---

## 14. Webhookテーブル

### 14.1 Webhook登録テーブル

```sql
CREATE TABLE sch_webhook_subscription (
    subscription_id VARCHAR(50) PRIMARY KEY,
    tenant_id       VARCHAR(50) NOT NULL,
    name            VARCHAR(100) NOT NULL,
    url             TEXT NOT NULL,
    secret          VARCHAR(100) NOT NULL,       -- HMAC署名用シークレット
    events          TEXT[] NOT NULL,             -- ['record.created', 'record.updated']
    model_ids       TEXT[],                      -- 対象モデル（NULLなら全モデル）
    is_active       BOOLEAN NOT NULL DEFAULT TRUE,
    headers         JSONB,                       -- カスタムヘッダー
    created_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by      VARCHAR(100) NOT NULL,
    updated_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by      VARCHAR(100) NOT NULL
);

CREATE INDEX idx_webhook_sub_tenant ON sch_webhook_subscription(tenant_id);
CREATE INDEX idx_webhook_sub_events ON sch_webhook_subscription USING GIN(events);
```

### 14.2 Webhook配信履歴テーブル

```sql
CREATE TABLE sch_webhook_delivery (
    delivery_id     BIGSERIAL PRIMARY KEY,
    subscription_id VARCHAR(50) NOT NULL REFERENCES sch_webhook_subscription(subscription_id),
    tenant_id       VARCHAR(50) NOT NULL,
    event_type      VARCHAR(50) NOT NULL,
    payload         JSONB NOT NULL,
    response_status INTEGER,
    response_body   TEXT,
    duration_ms     INTEGER,
    attempt         INTEGER NOT NULL DEFAULT 1,
    status          VARCHAR(20) NOT NULL,        -- pending, success, failed, retrying
    error_message   TEXT,
    created_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    delivered_at    TIMESTAMP
);

CREATE INDEX idx_webhook_delivery_sub ON sch_webhook_delivery(subscription_id);
CREATE INDEX idx_webhook_delivery_status ON sch_webhook_delivery(status) WHERE status IN ('pending', 'retrying');
CREATE INDEX idx_webhook_delivery_created ON sch_webhook_delivery(created_at DESC);
```

### 14.3 Webhookペイロード例

```json
{
  "event": "record.created",
  "timestamp": "2024-11-28T10:30:00Z",
  "tenant_id": "tenant-001",
  "data": {
    "id": "rec-789",
    "schema": "order",
    "record_data": {
      "customerName": "株式会社サンプル",
      "orderDate": "2024-11-28",
      "status": "draft"
    },
    "created_at": "2024-11-28T10:30:00Z",
    "created_by": "user-123"
  }
}
```

---

## 15. 更新されたテーブル一覧

| テーブル名 | 用途 | 拡張性 |
|-----------|------|--------|
| sch_tenant | テナント管理 | ✅ マルチテナント |
| sch_record | レコードデータ | ✅ tenant_id, version追加 |
| sch_dic_model | モデル定義 | ✅ tenant_id, version追加 |
| sch_dic_model_header | モデルヘッダー | ✅ tenant_id, version追加 |
| sch_dic_code | コードマスタ | ✅ tenant_id, version, delete_flag追加 |
| sch_role | ロール定義 | ✅ RBAC, version, delete_flag追加 |
| sch_user_role | ユーザー・ロール関連 | ✅ RBAC, version追加 |
| sch_permission | 権限定義 | ✅ RBAC, version追加 |
| sch_audit_log | 監査ログ | ✅ トレーサビリティ |
| sch_webhook_subscription | Webhook登録 | ✅ 外部連携 |
| sch_webhook_delivery | Webhook配信履歴 | ✅ 外部連携 |

### 15.1 設計原則まとめ

| 原則 | 実装 |
|------|------|
| 楽観的ロック | 全テーブルに `version` カラム（@Version） |
| 論理削除 | ロール・コードは `delete_flag`、モデルは `is_hidden` |
| 物理削除 | レコードは物理削除（ユーザーデータ完全削除原則） |
| 監査カラム | `created_at`, `created_by`, `updated_at`, `updated_by` |
| mirelplatform準拠 | `mir_role`, `mir_tenant` と同等構造 |
