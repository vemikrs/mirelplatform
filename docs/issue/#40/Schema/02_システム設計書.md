# Mirel Schema システム設計書

## 1. 文書情報

| 項目 | 内容 |
|------|------|
| システム名 | Mirel Schema（ミレル スキーマ） |
| 版数 | 3.0 |
| 作成日 | 2025年11月28日 |

---

## 2. システム全体構成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              クライアント層                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   Webブラウザ    │  │  モバイルアプリ   │  │   外部システム   │             │
│  │  (React SPA)    │  │                 │  │   (REST Client) │             │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘             │
└───────────┼────────────────────┼────────────────────┼───────────────────────┘
            │                    │                    │
            ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           REST API (HTTP/JSON)                              │
│                          /apps/schema/api/{path}                            │
└─────────────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           アプリケーション層                                   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     SchemaApiController                              │   │
│  │                   (汎用APIコントローラー)                               │   │
│  └──────────────────────────────┬──────────────────────────────────────┘   │
│                                 │                                          │
│                                 ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Service Layer                               │   │
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐              │   │
│  │  │ Record        │ │ Model         │ │ Code          │              │   │
│  │  │ Service       │ │ Service       │ │ Service       │              │   │
│  │  └───────┬───────┘ └───────┬───────┘ └───────┬───────┘              │   │
│  └──────────┼─────────────────┼─────────────────┼──────────────────────┘   │
│             │                 │                 │                          │
│             ▼                 ▼                 ▼                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Facade Layer                                 │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                      SchemaEngine                            │   │   │
│  │  │  ・レコード管理（CRUD）                                        │   │   │
│  │  │  ・ディクショナリ取得（再帰的スキーマ解決）                      │   │   │
│  │  │  ・バリデーション（必須チェック、キー重複チェック）              │   │   │
│  │  │  ・ファンクション解決                                         │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │  ┌────────────────────────────┐  ┌────────────────────────────┐   │   │
│  │  │ DictionaryMaintenance      │  │  CodeMaintenance           │   │   │
│  │  │ Engine                     │  │  Engine                    │   │   │
│  │  └────────────────────────────┘  └────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            データアクセス層                                   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Repository Layer (JPA)                         │   │
│  │  ┌──────────────────┐ ┌─────────────────┐ ┌─────────────────────┐  │   │
│  │  │SchRecord         │ │SchDicModel      │ │SchDicCode           │  │   │
│  │  │Repository        │ │Repository       │ │Repository           │  │   │
│  │  └──────────────────┘ └─────────────────┘ └─────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            データベース層                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        PostgreSQL                                    │   │
│  │  ・sch_record (JSONB)                                               │   │
│  │  ・sch_dic_model                                                    │   │
│  │  ・sch_dic_model_header                                             │   │
│  │  ・sch_dic_code                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. レイヤー構成

### 3.1 プレゼンテーション層

```
jp.vemi.mirel.apps.schema.application
│
└── controller/
    └── SchemaApiController.java
```

| クラス | 責務 |
|--------|------|
| SchemaApiController | HTTPリクエスト受付、ルーティング、レスポンス返却 |

**特徴:**
- 動的APIルーティング: `/{path}` パラメータでAPI解決
- OpenAPI対応: `@Tag`, `@Operation`アノテーション

### 3.2 サービス層

```
jp.vemi.mirel.apps.schema.domain.service
│
├── SchemaRecordService.java       # レコード操作
├── SchemaModelService.java        # モデル定義操作
└── SchemaCodeService.java         # コードマスタ操作
```

| クラス | 責務 |
|--------|------|
| SchemaRecordService | レコードのCRUD、一覧取得 |
| SchemaModelService | モデル定義の取得・保存・削除 |
| SchemaCodeService | コードマスタの取得・保存・削除 |

**特徴:**
- `@Transactional`によるトランザクション管理
- Facadeへの委譲

### 3.3 ファサード層

```
jp.vemi.mirel.apps.schema.domain.facade
│
├── SchemaEngine.java                    # メインエンジン
├── DictionaryMaintenanceEngine.java     # ディクショナリ管理
└── CodeMaintenanceEngine.java           # コード管理
```

| クラス | 主要メソッド | 責務 |
|--------|------------|------|
| SchemaEngine | getSchemaRecursive | 階層スキーマの再帰的取得 |
| | save | レコード保存（バリデーション含む） |
| | get | レコード詳細取得 |
| | getAll | レコード一覧取得 |
| | getCodeList | 関連コードリスト取得 |
| DictionaryMaintenanceEngine | getList | スキーマ定義一覧取得 |
| | save | スキーマ定義保存 |
| | delete | モデル削除 |
| CodeMaintenanceEngine | save | コード保存 |
| | delete | コードグループ削除 |

### 3.4 データアクセス層

```
jp.vemi.mirel.apps.schema.domain.repository
│
├── SchRecordRepository.java
├── SchDicModelRepository.java
├── SchDicModelHeaderRepository.java
└── SchDicCodeRepository.java
```

| リポジトリ | 対応エンティティ |
|-----------|----------------|
| SchRecordRepository | SchRecord |
| SchDicModelRepository | SchDicModel |
| SchDicModelHeaderRepository | SchDicModelHeader |
| SchDicCodeRepository | SchDicCode |

---

## 4. ドメインモデル

### 4.1 ディクショナリ・ツリーモデル

モデル定義は階層的なツリー構造として表現されます。

```
                    AbstractSchemaDictionaryTreeNode
                              ▲
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
HierarchicalTopNode    SchemaElement       PrimitiveElement
  (ROOT)              (ABSTRACT_SCHEMA)    (PRIMITIVE_TYPE)
  モデルの             複合スキーマ          プリミティブ要素
  ルートノード          のノード              のノード

        │                     │                     
        └──────────┬──────────┘                     
                   │                                
              ┌────┴────┐                           
              │ childs  │ ◄── 子ノードを再帰的に保持
              │ (List)  │
              └─────────┘
```

### 4.2 ノードタイプ

```java
enum SchemaDictionaryTreeNodeType {
    ROOT(0),            // ルートノード（HierarchicalTopNode）
    ABSTRACT_SCHEMA(1), // 抽象スキーマ（SchemaElement）
    SCHEMA(2),          // 具体スキーマ（将来拡張）
    TYPE(8),            // 型（将来拡張）
    PRIMITIVE_TYPE(9)   // プリミティブ型（PrimitiveElement）
}
```

### 4.3 クラス図

```
┌───────────────────────────────────────────────────┐
│      AbstractSchemaDictionaryTreeNode             │
├───────────────────────────────────────────────────┤
│ # childs: List<AbstractSchemaDictionaryTreeNode>  │
├───────────────────────────────────────────────────┤
│ + getNodeType(): SchemaDictionaryTreeNodeType     │
│ + addChild(node): void                            │
│ + getModelId(): String                            │
│ + getChilds(): List                               │
└───────────────────────────────────────────────────┘
        △
        │
        ├──────────────────────┬───────────────────────┐
        │                      │                       │
┌───────┴───────┐      ┌───────┴───────┐      ┌───────┴───────────┐
│HierarchicalTop│      │ SchemaElement │      │ PrimitiveElement  │
│    Node       │      │               │      │                   │
├───────────────┤      ├───────────────┤      ├───────────────────┤
│ modelId       │      │ schemaId      │      │ modelId           │
│               │      │ fieldId       │      │ fieldId           │
│ nodeType=ROOT │      │ fieldName     │      │ fieldName         │
└───────────────┘      │               │      │ widgetType        │
                       │ nodeType=     │      │ dataType          │
                       │ ABSTRACT_     │      │ isKey             │
                       │ SCHEMA        │      │ isRequired        │
                       └───────────────┘      │ isHeader          │
                                              │ sort              │
                                              │ relationCodeGroup │
                                              │ defaultValue      │
                                              │ function          │
                                              │ displayWidth      │
                                              │ format            │
                                              │ maxDigits         │
                                              │ description       │
                                              │ regexPattern      │
                                              │ minLength         │
                                              │ maxLength         │
                                              │ minValue          │
                                              │ maxValue          │
                                              │                   │
                                              │ nodeType=         │
                                              │ PRIMITIVE_TYPE    │
                                              └───────────────────┘
```

---

## 5. 処理フロー

### 5.1 スキーマ解決フロー（再帰的）

```
getSchemaRecursive("order")
        │
        ▼
┌───────────────────────────────────────────────────────────────────┐
│ SchDicModelから model_id="order" のレコードを取得                  │
└───────────────────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────────┐
│ 各フィールドの dataType を判定                                     │
│                                                                   │
│ if (PRIMITIVE_TYPES.contains(dataType)) {                        │
│     → PrimitiveElement として追加                                 │
│ } else {                                                          │
│     → 再帰呼び出し: getSchemaRecursive(dataType)                  │
│     → SchemaElement として追加                                    │
│ }                                                                 │
└───────────────────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────────┐
│ 結果: 階層的なディクショナリツリー構造                              │
│                                                                   │
│ HierarchicalTopNode(order)                                        │
│   ├── PrimitiveElement(orderId, string)                          │
│   ├── PrimitiveElement(orderDate, date)                          │
│   └── SchemaElement(customer)                                    │
│         ├── PrimitiveElement(customerId, string)                 │
│         └── PrimitiveElement(customerName, string)               │
└───────────────────────────────────────────────────────────────────┘
```

**制約:**
- 無限ループ防止: 最大100階層

### 5.2 レコード保存フロー

```
┌─────────┐    POST /apps/schema/api/save    ┌─────────────────┐
│ Client  │ ──────────────────────────────► │SchemaApiController│
└─────────┘                                 └────────┬────────┘
                                                    │
                                                    ▼
                                           ┌─────────────────┐
                                           │ Record          │
                                           │ Service         │
                                           └────────┬────────┘
                                                    │
                                                    ▼
                                           ┌─────────────────────────┐
                                           │      SchemaEngine       │
                                           ├─────────────────────────┤
                                           │ 1. ディクショナリ取得    │
                                           │ 2. データ変換           │
                                           │ 3. 必須バリデーション    │
                                           │ 4. 正規表現バリデーション │
                                           │ 5. 範囲バリデーション    │
                                           │ 6. キー重複チェック      │
                                           │ 7. ファンクション解決    │
                                           └────────┬────────────────┘
                                                    │
                                                    ▼
                                           ┌─────────────────┐
                                           │SchRecord        │
                                           │Repository       │
                                           └────────┬────────┘
                                                    │
                                                    ▼
                                           ┌─────────────────┐
                                           │   PostgreSQL    │
                                           │   sch_record    │
                                           │   (JSONB)       │
                                           └─────────────────┘
```

---

## 6. データ型マッピング

### 6.1 プリミティブデータ型

| 論理型 | Javaデータ型 | PostgreSQL | 説明 |
|--------|-------------|------------|------|
| string | String | VARCHAR/TEXT | 文字列 |
| number | BigDecimal/Long | NUMERIC/BIGINT | 数値 |
| date | LocalDate | DATE | 日付 |
| time | LocalTime | TIME | 時刻 |
| datetime | LocalDateTime | TIMESTAMP | 日時 |
| file | String (パス) | VARCHAR | ファイルパス |
| html | String | TEXT | HTMLコンテンツ |
| break | - | - | 区切り（表示用） |
| none | - | - | 非表示 |

### 6.2 ウィジェットタイプとデータ型の関係

| ウィジェット | 対応データ型 | 備考 |
|-------------|-------------|------|
| text | string | 単一行テキスト |
| textarea | string | 複数行テキスト |
| text_date | date | カレンダー選択 |
| text_time | time | 時刻選択 |
| checkbox | boolean | true/false |
| selectbox | string | コードマスタ連携 |
| tag | string[] | 複数値選択 |
| treeselect | string | 階層選択 |
| htmleditor | html | WYSIWYG |
| file | file | アップロード |
| embedded | (model) | 1:1 埋め込み |
| detail | (model[]) | 1:N 明細 |
| break | break | 区切り線 |
| title | none | 見出し |

---

## 7. ファンクション解決

### 7.1 アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                    FunctionResolver                             │
├─────────────────────────────────────────────────────────────────┤
│  入力: "${_functionName(arg1, arg2)}"                          │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1. ステートメント解析                                     │   │
│  │    → 関数名と引数を抽出                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 2. ApiResolver                                          │   │
│  │    → プラグインから対応するハンドラを検索                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 3. ApiPluginAbstract                                    │   │
│  │    → 関数を実行し結果を返却                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  出力: 解決された値                                             │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 プラグイン拡張

```java
public abstract class ApiPluginAbstract {
    // 対象判定
    public abstract boolean is(ApiResolverCondition condition);
    
    // 関数実行
    public abstract Object resolve(ApiResolverCondition condition);
    
    // 優先度
    public int priority() { return 0; }
}
```

---

## 8. ディレクトリ構成

### 8.1 バックエンド

```
backend/src/main/java/jp/vemi/mirel/apps/schema/
├── application/
│   └── controller/
│       └── SchemaApiController.java
│
└── domain/
    ├── entity/
    │   ├── SchRecord.java
    │   ├── SchDicModel.java
    │   ├── SchDicModelHeader.java
    │   └── SchDicCode.java
    │
    ├── repository/
    │   ├── SchRecordRepository.java
    │   ├── SchDicModelRepository.java
    │   ├── SchDicModelHeaderRepository.java
    │   └── SchDicCodeRepository.java
    │
    ├── service/
    │   ├── SchemaRecordService.java
    │   ├── SchemaModelService.java
    │   └── SchemaCodeService.java
    │
    ├── facade/
    │   ├── SchemaEngine.java
    │   ├── DictionaryMaintenanceEngine.java
    │   └── CodeMaintenanceEngine.java
    │
    └── dto/
        ├── request/
        ├── response/
        └── model/
            └── dictionary/
                ├── AbstractSchemaDictionaryTreeNode.java
                ├── HierarchicalTopNode.java
                ├── SchemaElement.java
                └── PrimitiveElement.java
```

### 8.2 フロントエンド

```
apps/frontend-v3/src/features/schema/
├── pages/
│   ├── SchemaHomePage.tsx
│   ├── SchemaRecordListPage.tsx
│   ├── SchemaRecordDetailPage.tsx
│   ├── SchemaModelDefinePage.tsx
│   └── SchemaCodeMasterPage.tsx
│
├── components/
│   ├── DynamicForm.tsx
│   ├── WidgetRenderer.tsx
│   ├── ModelSelector.tsx
│   ├── RecordGrid.tsx
│   └── FieldEditor.tsx
│
├── hooks/
│   ├── useModelList.ts
│   ├── useRecordList.ts
│   ├── useRecordDetail.ts
│   ├── useSaveRecord.ts
│   └── useCodeMaster.ts
│
└── types/
    └── schema.ts
```

---

## 9. 例外処理設計

### 9.1 例外クラス階層

```
RuntimeException
    └── MessagingException（メッセージリスト保持）
            ├── MirelApplicationException（業務例外）
            └── MirelSystemException（システム例外）
```

### 9.2 例外クラス詳細

| 例外クラス | 用途 | ログレベル | ユーザーメッセージ |
|-----------|------|-----------|------------------|
| MirelApplicationException | 業務エラー（バリデーション、権限不足等） | WARN | 例外メッセージをそのまま表示 |
| MirelSystemException | システムエラー（DB接続、外部連携等） | ERROR | 「システムエラーが発生しました。管理者に連絡してください。」 |

### 9.3 例外ハンドリングフロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Exception Handling Flow                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    GlobalExceptionHandler                            │    │
│  │                    (@ControllerAdvice)                               │    │
│  │                                                                      │    │
│  │  @ExceptionHandler(MirelApplicationException.class)                  │    │
│  │  public ResponseEntity<ApiResponse<?>> handleBusinessException() {   │    │
│  │      log.warn("Business error: {}", e.getMessage(), e);             │    │
│  │      return ApiResponse.builder()                                    │    │
│  │          .errors(e.getMessages())                                    │    │
│  │          .errorCode(e.getErrorCode())                                │    │
│  │          .build();                                                   │    │
│  │  }                                                                   │    │
│  │                                                                      │    │
│  │  @ExceptionHandler(MirelSystemException.class)                       │    │
│  │  public ResponseEntity<ApiResponse<?>> handleSystemException() {     │    │
│  │      log.error("System error: {}", e.getMessage(), e);              │    │
│  │      return ApiResponse.builder()                                    │    │
│  │          .errors(List.of("システムエラーが発生しました。"))            │    │
│  │          .errorCode("SCH-S-001")                                     │    │
│  │          .build();                                                   │    │
│  │  }                                                                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.4 エラーコード設計

| コード | カテゴリ | 説明 |
|--------|----------|------|
| SCH-V-001 | Validation | 必須項目未入力 |
| SCH-V-002 | Validation | 正規表現パターン不一致 |
| SCH-V-003 | Validation | 文字数制限違反 |
| SCH-V-004 | Validation | 数値範囲違反 |
| SCH-D-001 | Data | キー重複 |
| SCH-D-002 | Data | 参照先レコード未存在 |
| SCH-D-003 | Data | モデル定義未存在 |
| SCH-D-004 | Data | 循環参照検出 |
| SCH-D-005 | Data | 楽観的ロックエラー（バージョン不一致） |
| SCH-A-001 | Authorization | 認証エラー |
| SCH-A-002 | Authorization | 権限不足 |
| SCH-A-003 | Authorization | テナント不一致 |
| SCH-S-001 | System | データベース接続エラー |
| SCH-S-002 | System | 外部サービス連携エラー |
| SCH-S-003 | System | 予期しないエラー |

### 9.5 ロギング設計

Lombokの `@Slf4j` アノテーションを使用し、クラスごとにLoggerを自動生成します。

```java
@Slf4j  // ← Lombokによる自動生成
@Service
public class SchemaRecordService {
    
    public void save(RecordDto dto) {
        log.info("Saving record: modelId={}, recordId={}", dto.getModelId(), dto.getRecordId());
        
        try {
            // 処理
        } catch (MirelApplicationException e) {
            log.warn("Business error during save: {}", e.getMessage(), e);
            throw e;
        } catch (Exception e) {
            log.error("Unexpected error during save", e);
            throw new MirelSystemException("レコード保存中にエラーが発生しました", e);
        }
    }
}
```

#### ログレベル使い分け

| レベル | 用途 |
|--------|------|
| ERROR | システムエラー、回復不能なエラー |
| WARN | 業務エラー、想定内の例外 |
| INFO | 処理開始・終了、主要イベント |
| DEBUG | 詳細なデバッグ情報 |
| TRACE | 最も詳細なトレース情報 |

---

## 10. マルチテナント設計

### 10.1 テナント識別

```
┌─────────────────────────────────────────────────────────────┐
│                    Request Flow                              │
├─────────────────────────────────────────────────────────────┤
│  HTTP Request                                                │
│       │                                                      │
│       ▼                                                      │
│  ┌─────────────────┐                                        │
│  │ TenantFilter    │ ← X-Tenant-ID ヘッダー or JWT claim    │
│  └────────┬────────┘                                        │
│           │                                                  │
│           ▼                                                  │
│  ┌─────────────────┐                                        │
│  │ TenantContext   │ ThreadLocal でテナントID保持           │
│  └────────┬────────┘                                        │
│           │                                                  │
│           ▼                                                  │
│  ┌─────────────────┐                                        │
│  │ Repository      │ 自動的にテナント条件付与               │
│  └─────────────────┘                                        │
└─────────────────────────────────────────────────────────────┘
```

### 10.2 テナント分離レイヤー

| レイヤー | 実装方式 |
|----------|----------|
| アプリケーション層 | TenantContextによるテナントID自動付与 |
| データアクセス層 | JPA Entity Listenerでテナント条件自動追加 |
| データベース層 | Row Level Security (RLS) ポリシー |

### 10.3 主要クラス

| クラス名 | 責務 |
|----------|------|
| `TenantContext` | ThreadLocalでテナントIDを保持 |
| `TenantFilter` | リクエストからテナントを特定しContextに設定 |
| `TenantAwareRepository` | 全クエリにテナント条件を自動付与 |
| `TenantEntityListener` | エンティティ保存時にテナントID自動設定 |

---

## 11. 権限管理設計

### 11.1 RBACモデル（mirelplatform連携）

mirelplatformの認可基盤（`mir_role`, `mir_user_role`）と連携したRBAC設計です。

```
┌──────────────┐     ┌─────────────────┐     ┌──────────────────┐
│  mir_user    │     │  mir_user_role  │     │    mir_role      │
│  (platform)  │────▶│  (platform)     │◄────│    (platform)    │
└──────────────┘     └─────────────────┘     └────────┬─────────┘
                                                       │
                                                       ▼
                                              ┌──────────────────┐
                                              │ sch_permission   │
                                              │ (Schema固有)     │
                                              └──────────────────┘
```

### 11.2 ロールエンティティ設計（mirelplatform準拠）

| カラム | 型 | 説明 |
|--------|-----|------|
| role_id | VARCHAR(50) | ロールID（主キー） |
| role_name | VARCHAR(100) | ロール名 |
| version | INTEGER | 楽観的ロック用バージョン |
| delete_flag | BOOLEAN | 論理削除フラグ |
| create_user_id | VARCHAR(100) | 作成者 |
| create_date | TIMESTAMP | 作成日時 |
| update_user_id | VARCHAR(100) | 更新者 |
| update_date | TIMESTAMP | 更新日時 |

### 11.3 権限種別

| 権限 | 説明 |
|------|------|
| `READ` | レコード参照 |
| `CREATE` | レコード作成 |
| `UPDATE` | レコード更新 |
| `DELETE` | レコード削除 |
| `ADMIN` | モデル定義変更、ロール管理 |

### 11.4 権限チェックフロー

```java
@Slf4j
@Service
public class PermissionService {
    
    @PreAuthorize("@permissionService.hasPermission(#modelId, 'READ')")
    public List<Record> findByModelId(String modelId) {
        log.debug("Permission check passed for modelId={}", modelId);
        // ...
    }
    
    public boolean hasPermission(String modelId, String action) {
        String userId = SecurityContextHolder.getContext().getAuthentication().getName();
        String tenantId = TenantContext.getCurrentTenantId();
        
        log.debug("Checking permission: userId={}, tenantId={}, modelId={}, action={}", 
                  userId, tenantId, modelId, action);
        
        // mir_user_role → mir_role → sch_permission の連携で権限チェック
        return permissionRepository.hasPermission(tenantId, userId, modelId, action);
    }
}
```

### 11.5 主要クラス

| クラス名 | 責務 |
|----------|------|
| `PermissionService` | 権限チェックロジック |
| `PermissionEvaluator` | SpEL式での権限評価 |
| `RoleRepository` | mirelplatformのmir_roleと連携 |
| `PermissionRepository` | Schema固有の権限情報管理 |

---

## 12. 監査ログ設計

### 12.1 監査イベントフロー

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Controller     │───▶│  AuditAspect    │───▶│  AuditLogService│
└─────────────────┘    └─────────────────┘    └────────┬────────┘
                                                       │
                                              ┌────────▼────────┐
                                              │  sch_audit_log  │
                                              └─────────────────┘
```

### 12.2 記録内容

| 項目 | 説明 |
|------|------|
| アクション | CREATE, UPDATE, DELETE |
| 対象 | リソース種別、リソースID |
| 操作者 | ユーザーID |
| 変更内容 | 変更前/変更後のJSON差分 |
| コンテキスト | IPアドレス、User-Agent、トレースID |

### 12.3 主要クラス

| クラス名 | 責務 |
|----------|------|
| `AuditAspect` | AOPによる監査イベント捕捉 |
| `AuditLogService` | 監査ログの記録 |
| `AuditLogRepository` | ログの永続化 |
| `AuditEvent` | 監査イベントDTO |

---

## 13. イベント・Webhook設計

### 13.1 イベントアーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Domain Event   │───▶│  EventPublisher │───▶│  EventListener  │
│  (RecordCreated)│    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └────────┬────────┘
                                                       │
                              ┌────────────────────────┼────────────────────────┐
                              │                        │                        │
                              ▼                        ▼                        ▼
                    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
                    │  AuditListener  │    │  CacheListener  │    │  WebhookListener│
                    └─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 13.2 イベント種別

| イベント | トリガー |
|----------|----------|
| `RecordCreatedEvent` | レコード作成時 |
| `RecordUpdatedEvent` | レコード更新時 |
| `RecordDeletedEvent` | レコード削除時 |
| `ModelUpdatedEvent` | モデル定義変更時 |

### 13.3 Webhook配信

| 項目 | 仕様 |
|------|------|
| 配信方式 | 非同期（@Async） |
| リトライ | 3回（指数バックオフ） |
| 署名 | HMAC-SHA256 |
| タイムアウト | 30秒 |

### 13.4 主要クラス

| クラス名 | 責務 |
|----------|------|
| `DomainEventPublisher` | ドメインイベント発行 |
| `WebhookService` | Webhook配信管理 |
| `WebhookSubscription` | Webhook登録情報 |
| `WebhookDelivery` | 配信履歴・リトライ管理 |

---

## 14. キャッシュ設計

### 14.1 キャッシュ構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌───────────────┐     ┌───────────────┐                   │
│   │ ModelCache    │     │ CodeCache     │                   │
│   │ @Cacheable    │     │ @Cacheable    │                   │
│   └───────┬───────┘     └───────┬───────┘                   │
│           │                     │                            │
│           └──────────┬──────────┘                            │
│                      ▼                                       │
│           ┌───────────────────┐                              │
│           │   Redis Cluster   │                              │
│           │   (Cache Store)   │                              │
│           └───────────────────┘                              │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 14.2 キャッシュ対象

| 対象 | キーパターン | TTL | 無効化トリガー |
|------|--------------|-----|----------------|
| モデル定義 | `model:{tenantId}:{modelId}` | 1時間 | モデル更新時 |
| コードマスタ | `code:{tenantId}:{codeId}` | 1時間 | コード更新時 |
| 権限情報 | `perm:{tenantId}:{userId}:{modelId}` | 15分 | 権限変更時 |

### 14.3 キャッシュ無効化

```java
@CacheEvict(value = "model", key = "#tenantId + ':' + #modelId")
public void updateModel(String tenantId, String modelId, ModelDto dto) {
    // ...
}
```

### 14.4 主要設定

| 設定項目 | 値 |
|----------|-----|
| キャッシュプロバイダ | Redis |
| シリアライズ | JSON |
| 接続プール | Lettuce |
| クラスター対応 | 有効 |

---

## 15. 設計原則

- **単一責任の原則**: 各クラスは一つの責務のみを持つ
- **依存性逆転の原則**: 上位モジュールは抽象に依存
- **テナント透過性**: テナント分離ロジックはインフラ層で吸収
- **イベント駆動**: 状態変更は全てイベントとして発行
- **キャッシュファースト**: メタデータは積極的にキャッシュ
- **Lombok活用**: `@Slf4j`, `@Data`, `@Builder` でボイラープレートコード削減
- **例外の一貫性**: 業務例外は`MirelApplicationException`、システム例外は`MirelSystemException`

---

## 16. 楽観的ロック設計

### 16.1 概要

全エンティティにバージョンカラムを追加し、更新時の競合を検出します。

### 16.2 実装

```java
@Slf4j
@Entity
@Table(name = "sch_record")
public class SchRecord {
    
    @Id
    private String id;
    
    @Version
    @Column(name = "version")
    private Integer version;
    
    // ... other fields
}
```

### 16.3 競合時の処理

```java
@Slf4j
@Service
public class SchemaRecordService {
    
    public void update(RecordDto dto) {
        try {
            repository.save(entity);
        } catch (OptimisticLockingFailureException e) {
            log.warn("Optimistic lock conflict: recordId={}, version={}", 
                     dto.getRecordId(), dto.getVersion(), e);
            throw new MirelApplicationException(
                "SCH-D-005",
                "他のユーザーにより更新されました。再読み込みしてください。"
            );
        }
    }
}
```
