# 401エラーハンドリング改善 - 手動テストガイド

## 概要

このドキュメントは、実装した401エラーハンドリング機能の手動テスト手順を記載しています。
ブラウザで実際に動作を確認し、UX、セキュリティ、パフォーマンスを検証します。

## 前提条件

- Backend: `http://localhost:3000` で起動中
- Frontend: `http://localhost:5173` で起動中
- テストアカウント: `admin`/`admin123` または `user`/`user123`

## テストシナリオ

### 1. 基本的なログインフロー

#### 1.1 通常ログイン
1. `http://localhost:5173/login` にアクセス
2. `admin`/`admin123` でログイン
3. **期待結果**: ホームページ(`/`)にリダイレクト

#### 1.2 ログアウト
1. ログイン後、右上のユーザーメニューから「ログアウト」をクリック
2. **期待結果**: 
   - 即座にログイン画面(`/login`)にリダイレクト
   - Zustand storeがクリアされる（DevToolsで確認）

### 2. returnUrl機構のテスト

#### 2.1 未認証状態で保護されたページにアクセス
1. ログアウト状態で `http://localhost:5173/promarker` に直接アクセス
2. **期待結果**: 
   - ログインページにリダイレクト
   - URL: `/login?returnUrl=%2Fpromarker`
3. ログイン後、**期待結果**: `/promarker` にリダイレクト

#### 2.2 authLoaderによる事前検証
1. ログイン状態で `/promarker` にアクセス
2. **ネットワークタブ確認**:
   - `GET /mapi/users/me` が呼ばれる（初回のみ）
   - 5秒以内の再アクセスではキャッシュが使用される（API呼び出しなし）
3. **期待結果**: ページが即座に表示される

### 3. 401エラーハンドリング

#### 3.1 セッション切れシミュレーション
**方法1: Zustand永続化ストレージを手動削除**
1. ログイン後、DevTools → Application → Storage → Session Storage
2. `auth-storage` キーを削除
3. ページをリフレッシュ
4. **期待結果**: ログインページにリダイレクト

**方法2: バックエンドを再起動してセッションをクリア**
1. ログイン後、バックエンドを停止・再起動
2. 任意のAPI呼び出しが発生する操作を実行（例: ページリフレッシュ）
3. **期待結果**: 
   - 401エラーが発生
   - Interceptorが即座にログアウト処理を実行
   - ログインページにリダイレクト
   - URLに`returnUrl`パラメータが含まれる

#### 3.2 JWT有効期限切れシミュレーション
**方法: DevToolsでトークンのexpを過去に変更**
1. ログイン後、DevTools → Application → Session Storage → `auth-storage`
2. JSON内の`tokens.accessToken`を以下のように変更:
   - JWTデコーダー（https://jwt.io/）でpayloadの`exp`を過去の日時に変更
   - 変更後のJWTを`accessToken`に設定
3. 保護されたページにアクセス
4. **期待結果**: 
   - `ProtectedRoute`でトークン期限切れを検出
   - ログインページにリダイレクト

**注意**: この方法はJWT署名が無効になるため、実際のAPI呼び出しは401エラーになります。

### 4. エラーページの表示とナビゲーション

#### 4.1 404 Not Found
1. 存在しないURL（例: `http://localhost:5173/nonexistent`）にアクセス
2. **期待結果**:
   - 404エラーページが表示される
   - 「ページが見つかりません」メッセージ
   - 「ホームに戻る」ボタンと「前のページに戻る」ボタンが機能する

#### 4.2 403 Forbidden
1. ブラウザのアドレスバーに `http://localhost:5173/403` を入力
2. **期待結果**:
   - 403エラーページが表示される
   - 「アクセス権限がありません」メッセージ
   - 現在のアカウント情報が表示される（ログイン中の場合）
   - ナビゲーションボタンが機能する

#### 4.3 500 Internal Server Error
1. ブラウザのアドレスバーに `http://localhost:5173/500` を入力
2. **期待結果**:
   - 500エラーページが表示される
   - 「サーバーエラー」メッセージ
   - 開発モード（`NODE_ENV=development`）の場合、エラー詳細とスタックトレースが表示される
   - 「ページを再読み込み」ボタンと「ホームに戻る」ボタンが機能する

### 5. アクセシビリティ検証

#### 5.1 キーボード操作
1. 404/403/500エラーページをTabキーで操作
2. **期待結果**:
   - フォーカスが見出しから始まる
   - すべてのボタンにフォーカスが移動できる
   - Enterキーでボタンが押せる

#### 5.2 スクリーンリーダー（推奨: NVDA/JAWS/VoiceOver）
1. エラーページにアクセス
2. **期待結果**:
   - 見出し「403」「404」「500」が読み上げられる
   - エラーメッセージが読み上げられる
   - ボタンの役割（`aria-label`）が読み上げられる
   - エラー詳細（500ページ）が`role="alert"`として通知される

### 6. パフォーマンス検証

#### 6.1 authLoaderキャッシュ効果
1. ログイン後、DevTools → Network タブを開く
2. `/promarker` にアクセス
3. **初回**:
   - `GET /mapi/users/me` が呼ばれる
   - レスポンスタイムを記録
4. **5秒以内に再アクセス**:
   - `GET /mapi/users/me` が呼ばれない（キャッシュヒット）
5. **5秒後に再アクセス**:
   - `GET /mapi/users/me` が再度呼ばれる（キャッシュ期限切れ）

**期待結果**: キャッシュにより初回以降のページロードが高速化

#### 6.2 無限ループ防止の確認
1. DevTools → Network タブを開く
2. ログアウト操作を実行
3. **期待結果**:
   - `/login` へのリダイレクトが1回のみ発生
   - `/login` ページで401エラーが発生しない

## トラブルシューティング

### Issue: ログイン後、画面が一瞬だけ表示される
**原因**: authLoaderが401を検出してリダイレクトしている可能性
**対処**: 
1. Network タブで `/mapi/users/me` のレスポンスを確認
2. 401が返っている場合、バックエンドのセッション管理を確認

### Issue: エラーページからホームに戻れない
**原因**: ナビゲーション機能の実装ミス
**対処**: 
1. Console タブでエラーを確認
2. `useNavigate()` のインポートとボタンのonClickハンドラーを確認

### Issue: キャッシュが効かない
**原因**: キャッシュ変数がグローバルスコープで適切に保持されていない
**対処**: 
1. `router.config.tsx` の `cachedProfile` と `cacheTimestamp` がモジュールスコープにあることを確認
2. Console で `Date.now()` と `cacheTimestamp` の差分を確認

## テスト結果記録テンプレート

### 実施日: YYYY-MM-DD
### 実施者: [名前]
### 環境: [OS, ブラウザ, バージョン]

| テストケース | 結果 | 備考 |
|-------------|------|------|
| 1.1 通常ログイン | ✅/❌ | |
| 1.2 ログアウト | ✅/❌ | |
| 2.1 returnUrl機構 | ✅/❌ | |
| 2.2 authLoaderキャッシュ | ✅/❌ | |
| 3.1 セッション切れ | ✅/❌ | |
| 3.2 JWT期限切れ | ✅/❌ | |
| 4.1 404ページ | ✅/❌ | |
| 4.2 403ページ | ✅/❌ | |
| 4.3 500ページ | ✅/❌ | |
| 5.1 キーボード操作 | ✅/❌ | |
| 5.2 スクリーンリーダー | ✅/❌ | |
| 6.1 パフォーマンス | ✅/❌ | |

---

**作成日**: 2025-11-24  
**作成者**: GitHub Copilot
