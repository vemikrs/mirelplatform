# PR#40 ç¾çŠ¶åˆ†æã¨æ®‹ä½œæ¥­è¨ˆç”»

**åˆ†ææ—¥**: 2025å¹´11æœˆ22æ—¥  
**å¯¾è±¡PR**: #40 Complete SaaS multi-tenant infrastructure  
**åˆ†æè€…**: GitHub Copilot ğŸ¤–

---

## ğŸ“Š ç¾çŠ¶åˆ†æã‚µãƒãƒªãƒ¼

### âœ… å®Œäº†æ¸ˆã¿å®Ÿè£…ï¼ˆPhase 1-3ï¼‰

#### **Phase 1: SystemUser/Useråˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ âœ…**
è¨ˆç”»æ›¸ã«ã¯è¨˜è¼‰ã•ã‚Œã¦ã„ãªã‹ã£ãŸãŒã€ã‚ˆã‚Šå„ªã‚ŒãŸè¨­è¨ˆã¨ã—ã¦å®Ÿè£…æ¸ˆã¿ï¼š

- **SystemUser ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£** - èªè¨¼æƒ…å ±ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯ï¼‰
- **User ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£** - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ï¼ˆdisplayName, firstName, lastName, emailç­‰ï¼‰
- **User.systemUserId** - SystemUserã¸ã®å‚ç…§ï¼ˆèªè¨¼ã¨æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ã®åˆ†é›¢ï¼‰
- **PasswordResetToken ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£** - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå°‚ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
- åˆ©ç‚¹: 
  - èªè¨¼ç³»DBã¨ã‚¢ãƒ—ãƒªç³»DBã®è«–ç†åˆ†é›¢ãŒå¯èƒ½
  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã«æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ã¸ã®å½±éŸ¿ãªã—
  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã®ç‹¬ç«‹ç®¡ç†

#### **Phase 2: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Œå…¨å®Ÿè£… âœ…**
è¨ˆç”»æ›¸é€šã‚Š + ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼š

- **PasswordResetService** - ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ»æ¤œè¨¼ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
- **APIå®Ÿè£…**: 
  - `POST /auth/password-reset-request` - ãƒ¡ãƒ¼ãƒ«é€ä¿¡æº–å‚™
  - `POST /auth/password-reset` - æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
  - `GET /auth/password-reset/verify` - ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æ€§ç¢ºèª
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: 
  - `/password-reset` - ãƒªã‚»ãƒƒãƒˆè¦æ±‚ç”»é¢
  - `/password-reset/confirm` - æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šç”»é¢
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**:
  - SHA-256ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒƒã‚·ãƒ¥ä¿å­˜
  - 1æ™‚é–“æœ‰åŠ¹æœŸé™
  - ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ä½¿ç”¨ï¼ˆisUsed ãƒ•ãƒ©ã‚°ï¼‰
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ—æŒ™æ”»æ’ƒå¯¾ç­–ï¼ˆå­˜åœ¨ã—ãªã„ãƒ¡ãƒ¼ãƒ«ã§ã‚‚æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰

#### **Phase 3: ç®¡ç†ç”»é¢ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API âœ…**
è¨ˆç”»æ›¸é€šã‚Šã®å®Ÿè£…å®Œäº†ï¼š

- **AdminUserController** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†API
  - `GET /admin/users` - ãƒšãƒ¼ã‚¸ãƒ³ã‚°å¯¾å¿œä¸€è¦§
  - `GET /admin/users/:id` - è©³ç´°å–å¾—
  - `PUT /admin/users/:id` - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°
- **èªå¯åˆ¶å¾¡**: `@PreAuthorize("hasRole('ADMIN')")` å®Ÿè£…æ¸ˆã¿
- **AdminUserService** - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…æ¸ˆã¿

#### **Phase 4: åŸºæœ¬èªè¨¼API âœ…**
è¨ˆç”»æ›¸é€šã‚Šã®åŸºç›¤å®Ÿè£…å®Œäº†ï¼š

- **AuthenticationServiceImpl** - login, signup, refresh, logout, switchTenant
- **AuthenticationController** - å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…
- **ExecutionContext** - ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¹ã‚³ãƒ¼ãƒ—Beanå®Ÿè£…æ¸ˆã¿
- **ExecutionContextFilter** - ãƒ†ãƒŠãƒ³ãƒˆè§£æ±ºã€ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å–å¾—

---

## âŒ æœªå®Œäº†é …ç›®ï¼ˆè¨ˆç”»æ›¸ã¨ã®å·®åˆ†ï¼‰

### **Phase 3-4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰UIï¼ˆæœªå®Ÿè£…ï¼‰**

è¨ˆç”»æ›¸ã§è¦æ±‚ã•ã‚Œã¦ã„ã‚‹ãŒæœªå®Ÿè£…ã®UIï¼š

#### 1. è¨­å®šç”»é¢ï¼ˆPriority: HIGHï¼‰
- [ ] `/settings/profile` - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
  - displayName, firstName, lastNameç·¨é›†
  - API: `GET /users/me`, `PUT /users/me`ï¼ˆ**Backendå®Ÿè£…å¿…è¦**ï¼‰
- [ ] `/settings/security` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
  - API: `PUT /users/me/password`ï¼ˆ**Backendå®Ÿè£…å¿…è¦**ï¼‰

#### 2. ç®¡ç†ç”»é¢UIï¼ˆPriority: MEDIUMï¼‰
- [ ] `/admin/users` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ç”»é¢
  - DataTable, æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ãƒšãƒ¼ã‚¸ãƒ³ã‚°
  - Backend APIå®Ÿè£…æ¸ˆã¿ï¼ˆAdminUserControllerï¼‰
- [ ] `/admin/tenants` - ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†ç”»é¢
  - **Backend APIæœªå®Ÿè£…**ï¼ˆAdminTenantControllerä¸åœ¨ï¼‰
- [ ] `/admin/licenses` - ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç®¡ç†ç”»é¢
  - **Backend APIæœªå®Ÿè£…**ï¼ˆAdminLicenseControllerä¸åœ¨ï¼‰

#### 3. ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆPriority: HIGHï¼‰
è¨ˆç”»æ›¸ã§ã¯å¿…é ˆã ãŒã€ç¾åœ¨ã¯éª¨æ ¼ã®ã¿ï¼š

- [ ] `TenantSwitcher` - ãƒ†ãƒŠãƒ³ãƒˆåˆ‡æ›¿UI
  - æ‰€å±ãƒ†ãƒŠãƒ³ãƒˆä¸€è¦§å–å¾—APIå¿…è¦: `GET /users/me/tenants`ï¼ˆ**Backendæœªå®Ÿè£…**ï¼‰
  - ç¾åœ¨ã¯éª¨æ ¼ã®ã¿ï¼ˆé™çš„ãƒ‡ãƒ¼ã‚¿ï¼‰
- [ ] `LicenseBadge` - ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è¡¨ç¤º
  - ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±å–å¾—APIå¿…è¦: `GET /users/me/licenses`ï¼ˆ**Backendæœªå®Ÿè£…**ï¼‰
  - ç¾åœ¨ã¯éª¨æ ¼ã®ã¿ï¼ˆé™çš„tierï¼‰
- [ ] `UserMenu` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼
  - å®Ÿè£…æ¸ˆã¿ã ãŒã€APIæœªé€£æºï¼ˆé™çš„useræƒ…å ±ï¼‰

#### 4. ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç”»é¢ï¼ˆPriority: HIGHï¼‰
- [ ] `/signup` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç”»é¢
  - Backend APIå®Ÿè£…æ¸ˆã¿ï¼ˆPOST /auth/signupï¼‰
  - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…æ¸ˆã¿ã ãŒã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°çµ±åˆå¿…è¦

---

### **Phase 5: ãƒ†ã‚¹ãƒˆï¼ˆæœªå®Ÿè£…ï¼‰**

#### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆPriority: HIGHï¼‰
- [ ] AuthenticationServiceImplãƒ†ã‚¹ãƒˆ
  - loginæ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»
  - signupé‡è¤‡ãƒã‚§ãƒƒã‚¯
  - switchTenantæ‰€å±ç¢ºèª
- [ ] PasswordResetServiceãƒ†ã‚¹ãƒˆ
  - ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ»æ¤œè¨¼
  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
  - æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
- [ ] AdminUserServiceãƒ†ã‚¹ãƒˆ
  - ãƒšãƒ¼ã‚¸ãƒ³ã‚°æ©Ÿèƒ½
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°

#### çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆPriority: MEDIUMï¼‰
- [ ] èªè¨¼ãƒ•ãƒ­ãƒ¼å…¨ä½“
  - signup â†’ login â†’ /auth/me â†’ logout
- [ ] ãƒ†ãƒŠãƒ³ãƒˆåˆ‡æ›¿ãƒ•ãƒ­ãƒ¼
  - switchTenant â†’ ExecutionContextæ›´æ–°ç¢ºèª
- [ ] ãƒ©ã‚¤ã‚»ãƒ³ã‚¹é©ç”¨ãƒ•ãƒ­ãƒ¼
  - @RequireLicenseå‹•ä½œç¢ºèª

#### E2Eãƒ†ã‚¹ãƒˆï¼ˆSmokeãƒ†ã‚¹ãƒˆå„ªå…ˆï¼‰ï¼ˆPriority: HIGHï¼‰
è¨ˆç”»æ›¸: ã€Œãƒ†ã‚¹ãƒˆã¯ã€ä¸€æ—¦Smokeã§å®Ÿæ–½ã—ãã‚Šã¾ã—ã‚‡ã†ã€ã«åŸºã¥ãã€æœ€å°é™ã®å‹•ä½œç¢ºèªï¼š

- [ ] **Smoke Test 1: èªè¨¼åŸºæœ¬ãƒ•ãƒ­ãƒ¼**
  - `/login` â†’ ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› â†’ `/` ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç¢ºèª
  - `/auth/me` APIå‘¼ã³å‡ºã—æˆåŠŸç¢ºèª
- [ ] **Smoke Test 2: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ**
  - `/password-reset` â†’ ãƒ¡ãƒ¼ãƒ«å…¥åŠ›
  - `/password-reset/confirm?token=xxx` â†’ æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
  - ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸç¢ºèª
- [ ] **Smoke Test 3: ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹**
  - ADMINæ¨©é™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ `/admin/users` ã‚¢ã‚¯ã‚»ã‚¹
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤ºç¢ºèª
  - ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§403ã‚¨ãƒ©ãƒ¼ç¢ºèª

---

## ğŸ“‹ æ®‹ä½œæ¥­ã®å„ªå…ˆé †ä½ä»˜ã‘è¨ˆç”»

### **ãƒ•ã‚§ãƒ¼ã‚º1: æœ€å°é™ã®å‹•ä½œç¢ºèªï¼ˆSmoke Testå„ªå…ˆï¼‰** â±ï¸ 2-3æ—¥

#### 1.1 Backend APIè£œå®Œï¼ˆ1æ—¥ï¼‰
- [ ] UserProfileControllerå®Ÿè£…
  - `GET /users/me` - ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
  - `PUT /users/me` - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
  - `PUT /users/me/password` - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
- [ ] UserTenantAPIå®Ÿè£…
  - `GET /users/me/tenants` - æ‰€å±ãƒ†ãƒŠãƒ³ãƒˆä¸€è¦§
- [ ] UserLicenseAPIå®Ÿè£…
  - `GET /users/me/licenses` - æœ‰åŠ¹ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä¸€è¦§

#### 1.2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰åŸºæœ¬UIå®Ÿè£…ï¼ˆ1æ—¥ï¼‰
- [ ] `/settings/profile` ãƒšãƒ¼ã‚¸å®Ÿè£…
- [ ] `/settings/security` ãƒšãƒ¼ã‚¸å®Ÿè£…
- [ ] ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆAPIé€£æº
  - TenantSwitcherå®ŸAPIé€£æº
  - LicenseBadgeå®ŸAPIé€£æº
  - UserMenuå®ŸAPIé€£æº

#### 1.3 Smokeãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆ1æ—¥ï¼‰
- [ ] `packages/e2e/tests/specs/saas/smoke.spec.ts` ä½œæˆ
  - èªè¨¼åŸºæœ¬ãƒ•ãƒ­ãƒ¼
  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ•ãƒ­ãƒ¼
  - ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

---

### **ãƒ•ã‚§ãƒ¼ã‚º2: ç®¡ç†ç”»é¢UIå®Œæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰** â±ï¸ 3-4æ—¥

#### 2.1 Backend Admin APIè£œå®Œï¼ˆ1-2æ—¥ï¼‰
- [ ] AdminTenantControllerå®Ÿè£…
  - CRUD APIä¸€å¼
- [ ] AdminLicenseControllerå®Ÿè£…
  - CRUD APIä¸€å¼

#### 2.2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç®¡ç†ç”»é¢å®Ÿè£…ï¼ˆ2æ—¥ï¼‰
- [ ] `/admin/users` å®Œå…¨å®Ÿè£…
  - DataTable, SearchBar, FilterPanel
  - CRUDæ“ä½œ
- [ ] `/admin/tenants` å®Ÿè£…
- [ ] `/admin/licenses` å®Ÿè£…

---

### **ãƒ•ã‚§ãƒ¼ã‚º3: ãƒ†ã‚¹ãƒˆå……å®Ÿï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰** â±ï¸ 2-3æ—¥

#### 3.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆ1æ—¥ï¼‰
- [ ] ä¸»è¦ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆ

#### 3.2 çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆ1æ—¥ï¼‰
- [ ] èªè¨¼ãƒ•ãƒ­ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] ãƒ†ãƒŠãƒ³ãƒˆåˆ‡æ›¿çµ±åˆãƒ†ã‚¹ãƒˆ

#### 3.3 E2Eæ‹¡å¼µï¼ˆ1æ—¥ï¼‰
- [ ] å…¨æ©Ÿèƒ½ã®E2Eãƒ†ã‚¹ãƒˆ

---

## ğŸ¯ Smokeãƒ†ã‚¹ãƒˆä»•æ§˜ï¼ˆè©³ç´°ï¼‰

### Smoke Test Suite: SaaS Authentication & Admin

**ç›®çš„**: æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã§ã€èªè¨¼ãƒ»ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†ãƒ»ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç®¡ç†ã®åŸºæœ¬å‹•ä½œã‚’ç¢ºèª

**å‰ææ¡ä»¶**:
- Backendèµ·å‹•: `./gradlew :backend:bootRun`
- Frontendèµ·å‹•: `pnpm --filter frontend-v3 dev`
- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿: 
  - ADMINæ¨©é™ãƒ¦ãƒ¼ã‚¶ãƒ¼: `admin@example.com` / `password123`
  - ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼: `user@example.com` / `password123`

### Test 1: èªè¨¼åŸºæœ¬ãƒ•ãƒ­ãƒ¼
```typescript
test('should login and access /auth/me', async ({ page }) => {
  // 1. ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹
  await page.goto('http://localhost:5173/login');
  
  // 2. ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
  await page.fill('input[type="email"]', 'user@example.com');
  await page.fill('input[type="password"]', 'password123');
  await page.click('button[type="submit"]');
  
  // 3. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç¢ºèª
  await page.waitForURL('http://localhost:5173/');
  
  // 4. /auth/me APIå‘¼ã³å‡ºã—æˆåŠŸç¢ºèªï¼ˆNetworkç›£è¦–ï¼‰
  const response = await page.waitForResponse(
    resp => resp.url().includes('/mapi/auth/me') && resp.status() === 200
  );
  const data = await response.json();
  expect(data.user.email).toBe('user@example.com');
});
```

### Test 2: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
```typescript
test('should reset password', async ({ page }) => {
  // 1. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚
  await page.goto('http://localhost:5173/password-reset');
  await page.fill('input[type="email"]', 'user@example.com');
  await page.click('button:has-text("Send reset instructions")');
  
  // 2. æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¢ºèª
  await expect(page.locator('text=Check your email')).toBeVisible();
  
  // æ³¨: ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã¯é–‹ç™ºç’°å¢ƒã®ã¿ï¼ˆæœ¬ç•ªã§ã¯ãƒ¡ãƒ¼ãƒ«çµŒç”±ï¼‰
  // å®Ÿéš›ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã‹ã‚‰å–å¾—ã¾ãŸã¯ç›´æ¥DBç¢ºèª
});
```

### Test 3: ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
```typescript
test('should allow admin to access /admin/users', async ({ page }) => {
  // 1. ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
  await page.goto('http://localhost:5173/login');
  await page.fill('input[type="email"]', 'admin@example.com');
  await page.fill('input[type="password"]', 'password123');
  await page.click('button[type="submit"]');
  
  // 2. ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹
  await page.goto('http://localhost:5173/admin/users');
  
  // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤ºç¢ºèª
  await expect(page.locator('table')).toBeVisible();
});

test('should deny regular user access to /admin/users', async ({ page }) => {
  // 1. ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³
  await page.goto('http://localhost:5173/login');
  await page.fill('input[type="email"]', 'user@example.com');
  await page.fill('input[type="password"]', 'password123');
  await page.click('button[type="submit"]');
  
  // 2. ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
  await page.goto('http://localhost:5173/admin/users');
  
  // 3. 403ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç¢ºèª
  await expect(page.locator('text=403')).toBeVisible();
});
```

---

## ğŸ“ å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹

### Backend
- **UserProfileController**: ExecutionContextæ´»ç”¨ã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªå‹•å–å¾—
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´**: BCryptå†ãƒãƒƒã‚·ãƒ¥ã€SystemUser.passwordUpdatedAtæ›´æ–°
- **ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å–å¾—**: ApplicationLicenseRepository.findEffectiveLicensesæ´»ç”¨

### Frontend
- **APIé€£æº**: `/mapi/*` çµŒç”±ã€authStore.tokens.accessTokenã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä»˜ä¸
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: 401 â†’ `/login`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã€403 â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
- **ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹**: TanStack Queryã®isLoadingæ´»ç”¨

### E2E
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿**: `backend/src/test/resources/data.sql` ã§ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ä½œæˆ
- **èªè¨¼çŠ¶æ…‹**: Playwrightã®context.storageStateæ´»ç”¨ã§å†åˆ©ç”¨
- **ä¸¦åˆ—å®Ÿè¡Œ**: Smokeãƒ†ã‚¹ãƒˆã¯ç›´åˆ—å®Ÿè¡Œï¼ˆèªè¨¼çŠ¶æ…‹ã®ç«¶åˆå›é¿ï¼‰

---

## âœ… æˆæœç‰©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆæ›´æ–°ç‰ˆï¼‰

### Phase 1å®Œäº†æ™‚ï¼ˆSmokeãƒ†ã‚¹ãƒˆé€šéï¼‰
- [ ] UserProfileControllerå®Ÿè£…
- [ ] UserTenantAPIå®Ÿè£…
- [ ] UserLicenseAPIå®Ÿè£…
- [ ] `/settings/profile` UIå®Ÿè£…
- [ ] `/settings/security` UIå®Ÿè£…
- [ ] ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆAPIé€£æº
- [ ] Smokeãƒ†ã‚¹ãƒˆ3ä»¶å®Ÿè£…ãƒ»é€šé

### Phase 2å®Œäº†æ™‚ï¼ˆç®¡ç†ç”»é¢UIå®Œæˆï¼‰
- [ ] AdminTenantControllerå®Ÿè£…
- [ ] AdminLicenseControllerå®Ÿè£…
- [ ] `/admin/users` å®Œå…¨å®Ÿè£…
- [ ] `/admin/tenants` å®Ÿè£…
- [ ] `/admin/licenses` å®Ÿè£…

### Phase 3å®Œäº†æ™‚ï¼ˆãƒ†ã‚¹ãƒˆå……å®Ÿï¼‰
- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ20ä»¶ä»¥ä¸Š
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆ10ä»¶ä»¥ä¸Š
- [ ] E2Eãƒ†ã‚¹ãƒˆ10ä»¶ä»¥ä¸Š

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **å³åº§ã«å®Ÿæ–½**: ãƒ•ã‚§ãƒ¼ã‚º1ï¼ˆSmokeãƒ†ã‚¹ãƒˆå„ªå…ˆï¼‰ã®å®Ÿè£…
2. **PR#40ã®æ›´æ–°**: ç¾çŠ¶åˆ†æã‚’åæ˜ ã—ãŸèª¬æ˜æ–‡æ›´æ–°
3. **Issueåˆ†å‰²**: ãƒ•ã‚§ãƒ¼ã‚º2ã€ãƒ•ã‚§ãƒ¼ã‚º3ã¯åˆ¥Issueã¨ã—ã¦åˆ‡ã‚Šå‡ºã—

---

**ä½œæˆè€…**: GitHub Copilot ğŸ¤–  
**æœ€çµ‚æ›´æ–°**: 2025å¹´11æœˆ22æ—¥
