# MUST機能 全体鳥瞰図

## 概要

SaaSとして最低限必要な必須機能群。これらが不足していると、セキュリティリスク・運用困難・ビジネス継続性の問題が生じる。

---

## 1. MUST機能カテゴリ一覧

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           MUST機能 5カテゴリ                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 1. ユーザー管理基盤                                        優先度: P1   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │パスワード    │ │メール認証    │ │2要素認証     │ │セッション  │  │     │
│  │    │リセット      │ │(Signup時)    │ │(TOTP/2FA)    │ │管理UI      │  │     │
│  │    │⚠️一部実装    │ │❌未実装      │ │❌未実装      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 2. テナント管理                                            優先度: P1   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │テナント作成  │ │招待機能      │ │データ分離    │ │テナント    │  │     │
│  │    │ワークフロー  │ │(メール送信)  │ │検証          │ │削除/退会   │  │     │
│  │    │❌未実装      │ │⚠️Entity有    │ │❌未検証      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 3. ライセンス・課金管理                                    優先度: P2   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │有効期限管理  │ │使用量制限    │ │課金連携準備  │ │プラン変更  │  │     │
│  │    │(Expiry)      │ │(Quota)       │ │(Stripe)      │ │ワークフロー│  │     │
│  │    │⚠️Entity有    │ │❌未実装      │ │❌未実装      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 4. セキュリティ・コンプライアンス                          優先度: P1   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │APIレート制限 │ │CSRF完全実装  │ │監査ログ永続化│ │GDPR対応    │  │     │
│  │    │(全API)       │ │(prod必須)    │ │(レポート)    │ │(削除要求)  │  │     │
│  │    │⚠️OTPのみ     │ │⚠️設定依存    │ │⚠️Entity有    │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 5. 運用・監視                                              優先度: P1   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │ヘルスチェック│ │メトリクス    │ │エラー通知    │ │バックアップ│  │     │
│  │    │強化          │ │収集          │ │(Slack/Mail)  │ │リストア    │  │     │
│  │    │⚠️基本のみ    │ │❌未実装      │ │❌未実装      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  凡例: ❌ 未実装  ⚠️ 一部実装/Entity存在  ✅ 完了                              │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 実装状況詳細

### 2.1 ユーザー管理基盤

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| パスワードリセット | ⚠️ 一部 | `PasswordResetToken` Entity, `/password-reset` UI | API実装、メール送信統合 |
| メール認証 | ❌ 未実装 | `emailVerified` フィールド | 認証フロー、トークン管理 |
| 2要素認証 | ❌ 未実装 | - | TOTP実装、QRコード生成 |
| セッション管理UI | ❌ 未実装 | `RefreshToken` Entity | 一覧表示、強制失効 |

### 2.2 テナント管理

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| テナント作成 | ❌ 未実装 | `Tenant` Entity | ワークフロー、オーナー設定 |
| 招待機能 | ⚠️ Entity有 | `InvitationToken` Entity | Service実装、メール送信 |
| データ分離 | ❌ 未検証 | `tenantId` フィールド | 検証テスト、Row-Level Security検討 |
| テナント削除 | ❌ 未実装 | - | 退会ワークフロー、データアーカイブ |

### 2.3 ライセンス・課金管理

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| 有効期限管理 | ⚠️ Entity有 | `expiresAt` フィールド | 期限切れ処理、通知 |
| 使用量制限 | ❌ 未実装 | - | クォータ管理、超過処理 |
| 課金連携 | ❌ 未実装 | - | Stripe SDK統合、Webhook |
| プラン変更 | ❌ 未実装 | - | アップグレード/ダウングレード |

### 2.4 セキュリティ・コンプライアンス

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| APIレート制限 | ⚠️ OTPのみ | `RateLimitService` | 全API適用、ティア別制限 |
| CSRF | ⚠️ 設定依存 | `WebSecurityConfig` | 本番設定確認、テスト |
| 監査ログ | ⚠️ Entity有 | `AuditLog` Entity | 自動記録AOP、レポートUI |
| GDPR | ❌ 未実装 | - | データエクスポート、削除要求 |

### 2.5 運用・監視

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| ヘルスチェック | ⚠️ 基本 | `/actuator/health` | カスタム指標追加 |
| メトリクス | ❌ 未実装 | Micrometer依存追加済み | Prometheus設定、カスタムメトリクス |
| エラー通知 | ❌ 未実装 | - | Slack/メール通知 |
| バックアップ | ❌ 未実装 | - | DB自動バックアップ、リストア手順 |

---

## 3. 依存関係図

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          MUST機能 依存関係                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────┐                                                        │
│  │   1. ユーザー管理   │◀────────────────────────────────────┐                  │
│  │   (パスワードリセット,│                                     │                  │
│  │    2FA, セッション)  │                                     │                  │
│  └──────────┬──────────┘                                     │                  │
│             │ 依存                                            │                  │
│             ▼                                                 │                  │
│  ┌─────────────────────┐      ┌─────────────────────┐        │                  │
│  │   2. テナント管理   │◀────▶│ 3. ライセンス管理   │        │                  │
│  │   (招待, 作成, 削除) │      │ (有効期限, 課金)    │        │                  │
│  └──────────┬──────────┘      └──────────┬──────────┘        │                  │
│             │                            │                    │                  │
│             └──────────────┬─────────────┘                    │                  │
│                            │ 依存                              │                  │
│                            ▼                                   │                  │
│             ┌─────────────────────┐                           │                  │
│             │ 4. セキュリティ      │───────────────────────────┘                  │
│             │ (レート制限, 監査)   │                                              │
│             └──────────┬──────────┘                                              │
│                        │ 依存                                                    │
│                        ▼                                                         │
│             ┌─────────────────────┐                                              │
│             │   5. 運用・監視     │                                              │
│             │ (ヘルスチェック,    │                                              │
│             │  メトリクス, 通知)  │                                              │
│             └─────────────────────┘                                              │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 推奨実装順序

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          実装ロードマップ                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Week 1-2: 🔴 セキュリティ基盤                                                   │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ □ APIレート制限の全API適用                                               │   │
│  │ □ CSRF設定の本番確認・テスト                                             │   │
│  │ □ ヘルスチェック強化（DB, Redis接続確認）                                │   │
│  │ □ 基本的なE2Eテスト整備                                                  │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  Week 3-4: 🟠 ユーザー管理完成                                                   │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ □ パスワードリセットAPI完成                                              │   │
│  │ □ メール認証フロー実装                                                   │   │
│  │ □ セッション管理UI実装                                                   │   │
│  │ □ Admin Users UI実装                                                     │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  Week 5-6: 🟡 テナント管理                                                       │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ □ テナント作成ワークフロー                                               │   │
│  │ □ 招待機能（メール送信統合）                                             │   │
│  │ □ AdminTenantController実装                                              │   │
│  │ □ データ分離検証テスト                                                   │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  Week 7-8: 🟢 運用・監視                                                         │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ □ Prometheusメトリクス設定                                               │   │
│  │ □ 監査ログ自動記録（AOP）                                                │   │
│  │ □ エラー通知（Slack Webhook）                                            │   │
│  │ □ バックアップ手順ドキュメント                                           │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  Month 2+: 🔵 ライセンス・課金                                                   │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ □ 有効期限切れ通知                                                       │   │
│  │ □ 使用量制限（クォータ）                                                 │   │
│  │ □ Stripe連携（Webhook, Checkout）                                        │   │
│  │ □ プラン変更ワークフロー                                                 │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. ディレクトリ構成

```
MUST/
├── 00_overview.md                 (本ファイル)
├── 01_user-management.md          ユーザー管理基盤
├── 02_tenant-management.md        テナント管理
├── 03_license-billing.md          ライセンス・課金管理
├── 04_security-compliance.md      セキュリティ・コンプライアンス
└── 05_operations-monitoring.md    運用・監視
```

---

**作成日**: 2025年11月28日  
**作成者**: GitHub Copilot 🤖
