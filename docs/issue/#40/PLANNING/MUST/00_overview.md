# MUST機能 全体鳥瞰図

## 概要

SaaSとして最低限必要な必須機能群。これらが不足していると、セキュリティリスク・運用困難・ビジネス継続性の問題が生じる。

---

## 1. MUST機能カテゴリ一覧

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           MUST機能 11カテゴリ                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ══════════════════ 基盤機能 (01-05) ══════════════════                          │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 1. ユーザー管理基盤                                        優先度: P1   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │パスワード    │ │メール認証    │ │2要素認証     │ │セッション  │  │     │
│  │    │リセット      │ │(Signup時)    │ │(TOTP/2FA)    │ │管理UI      │  │     │
│  │    │⚠️一部実装    │ │❌未実装      │ │❌未実装      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 2. テナント管理                                            優先度: P1   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │テナント作成  │ │招待機能      │ │データ分離    │ │テナント    │  │     │
│  │    │ワークフロー  │ │(メール送信)  │ │検証          │ │削除/退会   │  │     │
│  │    │❌未実装      │ │⚠️Entity有    │ │❌未検証      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 3. ライセンス・課金管理                                    優先度: P2   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │有効期限管理  │ │使用量制限    │ │課金連携準備  │ │プラン変更  │  │     │
│  │    │(Expiry)      │ │(Quota)       │ │(Stripe)      │ │ワークフロー│  │     │
│  │    │⚠️Entity有    │ │❌未実装      │ │❌未実装      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 4. セキュリティ・コンプライアンス                          優先度: P1   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │APIレート制限 │ │CSRF完全実装  │ │監査ログ永続化│ │GDPR対応    │  │     │
│  │    │(全API)       │ │(prod必須)    │ │(レポート)    │ │(削除要求)  │  │     │
│  │    │⚠️OTPのみ     │ │⚠️設定依存    │ │⚠️Entity有    │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 5. 運用・監視                                              優先度: P1   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │ヘルスチェック│ │メトリクス    │ │エラー通知    │ │バックアップ│  │     │
│  │    │強化          │ │収集          │ │(Slack/Mail)  │ │リストア    │  │     │
│  │    │⚠️基本のみ    │ │❌未実装      │ │❌未実装      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ══════════════════ アクセス制御・組織 (06-07) ══════════════════                │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 6. 認可（RBAC）                                            優先度: P1   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │システム      │ │テナント      │ │権限チェック  │ │権限継承    │  │     │
│  │    │ロール        │ │ロール        │ │アノテーション│ │ポリシー    │  │     │
│  │    │⚠️Entity有    │ │⚠️Entity有    │ │⚠️一部のみ    │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 7. 組織管理                                                優先度: P2   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │組織ツリー    │ │ユーザー所属  │ │承認ルート    │ │組織UI      │  │     │
│  │    │構造          │ │管理          │ │解決          │ │(Admin)     │  │     │
│  │    │❌未実装      │ │❌未実装      │ │❌未実装      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ══════════════════ 運用支援機能 (08-10) ══════════════════                      │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 8. お知らせ機能                                            優先度: P2   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │お知らせ      │ │配信スケジュール│ │既読管理      │ │/home連携   │  │     │
│  │    │Entity        │ │(publishAt)   │ │(read状態)    │ │(Widget)    │  │     │
│  │    │❌未実装      │ │❌未実装      │ │❌未実装      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 9. 閉塞機能                                                優先度: P1   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │閉塞レベル    │ │閉塞Filter    │ │スケジュール  │ │管理UI      │  │     │
│  │    │(5段階)       │ │(Redis連携)   │ │閉塞          │ │(Admin)     │  │     │
│  │    │❌未実装      │ │❌未実装      │ │❌未実装      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 10. ジョブスケジューラ                                     優先度: P2   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │ジョブ定義    │ │スケジュール  │ │実行履歴      │ │即時実行    │  │     │
│  │    │(JobDefinition)│ │(Cron対応)    │ │(JobExecution)│ │(手動起動)  │  │     │
│  │    │❌未実装      │ │❌未実装      │ │❌未実装      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  ══════════════════ UI基盤 (11) ══════════════════                               │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │ 11. メニュー管理                                           優先度: P2   │     │
│  │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐  │     │
│  │    │メニューDB管理│ │認可に基づく  │ │テナント別    │ │管理UI      │  │     │
│  │    │(MenuItem)    │ │メニュー配信  │ │カスタム      │ │(CRUD)      │  │     │
│  │    │❌未実装      │ │❌未実装      │ │❌未実装      │ │❌未実装    │  │     │
│  │    └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘  │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
│  凡例: ❌ 未実装  ⚠️ 一部実装/Entity存在  ✅ 完了                              │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 実装状況詳細

### 2.1 ユーザー管理基盤 (01)

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| パスワードリセット | ⚠️ 一部 | `PasswordResetToken` Entity, `/password-reset` UI | API実装、メール送信統合 |
| メール認証 | ❌ 未実装 | `emailVerified` フィールド | 認証フロー、トークン管理 |
| 2要素認証 | ❌ 未実装 | - | TOTP実装、QRコード生成 |
| セッション管理UI | ❌ 未実装 | `RefreshToken` Entity | 一覧表示、強制失効 |

### 2.2 テナント管理 (02)

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| テナント作成 | ❌ 未実装 | `Tenant` Entity | ワークフロー、オーナー設定 |
| 招待機能 | ⚠️ Entity有 | `InvitationToken` Entity | Service実装、メール送信 |
| データ分離 | ❌ 未検証 | `tenantId` フィールド | 検証テスト、Row-Level Security検討 |
| テナント削除 | ❌ 未実装 | - | 退会ワークフロー、データアーカイブ |

### 2.3 ライセンス・課金管理 (03)

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| 有効期限管理 | ⚠️ Entity有 | `expiresAt` フィールド | 期限切れ処理、通知 |
| 使用量制限 | ❌ 未実装 | - | クォータ管理、超過処理 |
| 課金連携 | ❌ 未実装 | - | Stripe SDK統合、Webhook |
| プラン変更 | ❌ 未実装 | - | アップグレード/ダウングレード |

### 2.4 セキュリティ・コンプライアンス (04)

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| APIレート制限 | ⚠️ OTPのみ | `RateLimitService` | 全API適用、ティア別制限 |
| CSRF | ⚠️ 設定依存 | `WebSecurityConfig` | 本番設定確認、テスト |
| 監査ログ | ⚠️ Entity有 | `AuditLog` Entity | 自動記録AOP、レポートUI |
| GDPR | ❌ 未実装 | - | データエクスポート、削除要求 |

### 2.5 運用・監視 (05)

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| ヘルスチェック | ⚠️ 基本 | `/actuator/health` | カスタム指標追加 |
| メトリクス | ❌ 未実装 | Micrometer依存追加済み | Prometheus設定、カスタムメトリクス |
| エラー通知 | ❌ 未実装 | - | Slack/メール通知 |
| バックアップ | ❌ 未実装 | - | DB自動バックアップ、リストア手順 |

### 2.6 認可（RBAC）(06)

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| システムロール | ⚠️ Entity有 | `User.roles` | SystemRole enum統一 |
| テナントロール | ⚠️ Entity有 | `UserTenant.roleInTenant` | TenantRole enum統一 |
| 権限チェック | ⚠️ 一部のみ | `@PreAuthorize` 一部 | AuthorizationService実装 |
| 権限継承 | ❌ 未実装 | - | ロール階層ポリシー |

### 2.7 組織管理 (07)

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| 組織ツリー | ❌ 未実装 | - | OrganizationUnit Entity |
| ユーザー所属 | ❌ 未実装 | - | UserOrganization Entity |
| 承認ルート | ❌ 未実装 | - | 上長解決ロジック |
| 組織UI | ❌ 未実装 | - | 管理画面 |

### 2.8 お知らせ機能 (08)

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| お知らせEntity | ❌ 未実装 | - | Announcement Entity |
| 配信スケジュール | ❌ 未実装 | - | publishAt/expireAt |
| 既読管理 | ❌ 未実装 | - | AnnouncementRead Entity |
| /home連携 | ❌ 未実装 | - | Widget実装 |

### 2.9 閉塞機能 (09)

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| 閉塞レベル | ❌ 未実装 | - | 5段階レベル定義 |
| 閉塞Filter | ❌ 未実装 | - | LockdownFilter実装 |
| スケジュール閉塞 | ❌ 未実装 | - | ScheduledLockdown |
| 管理UI | ❌ 未実装 | - | Admin画面 |

### 2.10 ジョブスケジューラ (10)

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| ジョブ定義 | ❌ 未実装 | - | JobDefinition Entity |
| スケジュール | ❌ 未実装 | - | JobSchedule + Cron |
| 実行履歴 | ❌ 未実装 | - | JobExecution Entity |
| 即時実行 | ❌ 未実装 | - | 手動トリガーAPI |

### 2.11 メニュー管理 (11)

| 機能 | 現状 | 既存実装 | 必要作業 |
|------|------|----------|----------|
| メニューDB管理 | ❌ 未実装 | `/mock/navigation.json` | MenuItem Entity |
| 認可配信 | ❌ 未実装 | - | 権限に基づくフィルタリング |
| テナント別カスタム | ❌ 未実装 | - | テナント固有メニュー |
| 管理UI | ❌ 未実装 | - | CRUD + ドラッグ並替 |

---

## 3. 依存関係図

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          MUST機能 依存関係                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────┐                                                        │
│  │   1. ユーザー管理   │◀────────────────────────────────────┐                  │
│  │   (パスワードリセット,│                                     │                  │
│  │    2FA, セッション)  │                                     │                  │
│  └──────────┬──────────┘                                     │                  │
│             │ 依存                                            │                  │
│             ▼                                                 │                  │
│  ┌─────────────────────┐      ┌─────────────────────┐        │                  │
│  │   2. テナント管理   │◀────▶│ 3. ライセンス管理   │        │                  │
│  │   (招待, 作成, 削除) │      │ (有効期限, 課金)    │        │                  │
│  └──────────┬──────────┘      └──────────┬──────────┘        │                  │
│             │                            │                    │                  │
│             └──────────────┬─────────────┘                    │                  │
│                            │ 依存                              │                  │
│                            ▼                                   │                  │
│             ┌─────────────────────┐                           │                  │
│             │ 4. セキュリティ      │───────────────────────────┘                  │
│             │ (レート制限, 監査)   │                                              │
│             └──────────┬──────────┘                                              │
│                        │ 依存                                                    │
│                        ▼                                                         │
│  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐  │
│  │   5. 運用・監視     │◀───│   6. 認可(RBAC)     │───▶│  7. 組織管理        │  │
│  │ (ヘルスチェック,    │    │ (システム/テナント  │    │ (ツリー構造,        │  │
│  │  メトリクス, 通知)  │    │  ロール)            │    │  承認ルート)        │  │
│  └─────────────────────┘    └──────────┬──────────┘    └─────────────────────┘  │
│                                        │                                         │
│             ┌──────────────────────────┼──────────────────────────┐             │
│             │                          ▼                          │             │
│             │            ┌─────────────────────┐                  │             │
│             │            │  11. メニュー管理   │                  │             │
│             │            │ (認可に基づく配信)  │                  │             │
│             │            └─────────────────────┘                  │             │
│             │                                                     │             │
│  ┌──────────▼──────────┐    ┌─────────────────────┐    ┌─────────▼───────────┐  │
│  │ 8. お知らせ機能     │    │  9. 閉塞機能        │◀───│ 10. ジョブスケジューラ│ │
│  │ (/home Widget)      │    │ (メンテナンス制御)  │    │ (閉塞ジョブ等)      │  │
│  └─────────────────────┘    └─────────────────────┘    └─────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 推奨実装順序

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          実装ロードマップ                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Week 1-2: 🔴 セキュリティ・認可基盤                                             │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ □ APIレート制限の全API適用                                               │   │
│  │ □ CSRF設定の本番確認・テスト                                             │   │
│  │ □ 認可(RBAC)基盤: AuthorizationService, カスタムアノテーション           │   │
│  │ □ ヘルスチェック強化（DB, Redis接続確認）                                │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  Week 3-4: 🟠 ユーザー管理・閉塞機能                                             │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ □ パスワードリセットAPI完成                                              │   │
│  │ □ メール認証フロー実装                                                   │   │
│  │ □ セッション管理UI実装                                                   │   │
│  │ □ 閉塞機能(LockdownFilter, Redis連携, 管理UI)                            │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  Week 5-6: 🟡 テナント管理・組織管理                                             │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ □ テナント作成ワークフロー                                               │   │
│  │ □ 招待機能（メール送信統合）                                             │   │
│  │ □ 組織ツリー構造(OrganizationUnit)                                       │   │
│  │ □ データ分離検証テスト                                                   │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  Week 7-8: 🟢 運用・監視・お知らせ                                               │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ □ Prometheusメトリクス設定                                               │   │
│  │ □ 監査ログ自動記録（AOP）                                                │   │
│  │ □ お知らせ機能(Announcement Entity, /home Widget)                        │   │
│  │ □ エラー通知（Slack Webhook）                                            │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  Week 9-10: 🔵 ジョブスケジューラ・メニュー管理                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ □ ジョブスケジューラ基盤(JobHandler, Spring Batch統合)                   │   │
│  │ □ メニュー管理(MenuItem Entity, 認可配信, mock.json移行)                 │   │
│  │ □ 管理UI(ドラッグ並べ替え)                                               │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  Month 2+: 🔵 ライセンス・課金                                                   │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ □ 有効期限切れ通知                                                       │   │
│  │ □ 使用量制限（クォータ）                                                 │   │
│  │ □ Stripe連携（Webhook, Checkout）                                        │   │
│  │ □ プラン変更ワークフロー                                                 │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. ディレクトリ構成

```
MUST/
├── 00_overview.md                 (本ファイル)
├── 01_user-management.md          ユーザー管理基盤
├── 02_tenant-management.md        テナント管理
├── 03_license-billing.md          ライセンス・課金管理
├── 04_security-compliance.md      セキュリティ・コンプライアンス
├── 05_operations-monitoring.md    運用・監視
├── 06_authorization.md            認可（RBAC）
├── 07_organization.md             組織管理
├── 08_announcement.md             お知らせ機能
├── 09_lockdown.md                 閉塞機能
├── 10_job-scheduler.md            ジョブスケジューラ
└── 11_menu-management.md          メニュー管理
```

---

## 6. 工数サマリー

| カテゴリ | 見積もり | 優先度 |
|----------|----------|--------|
| 01. ユーザー管理基盤 | 15日 | P1 |
| 02. テナント管理 | 12日 | P1 |
| 03. ライセンス・課金管理 | 20日 | P2 |
| 04. セキュリティ・コンプライアンス | 15日 | P1 |
| 05. 運用・監視 | 10日 | P1 |
| 06. 認可（RBAC） | 10日 | P1 |
| 07. 組織管理 | 17日 | P2 |
| 08. お知らせ機能 | 12日 | P2 |
| 09. 閉塞機能 | 11日 | P1 |
| 10. ジョブスケジューラ | 16日 | P2 |
| 11. メニュー管理 | 13日 | P2 |
| **合計** | **151日** | - |

※ P1機能のみ: 01+02+04+05+06+09 = 73日 (約3.5ヶ月)

---

**作成日**: 2025年11月28日  
**更新日**: 2025年11月28日  
**作成者**: GitHub Copilot 🤖
