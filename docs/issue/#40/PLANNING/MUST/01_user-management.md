# ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†åŸºç›¤ æ©Ÿèƒ½è¨­è¨ˆæ›¸

## 1. æ¦‚è¦

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ï¼ˆç™»éŒ²ã€èªè¨¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰ã«é–¢ã™ã‚‹æ©Ÿèƒ½ç¾¤ã€‚

---

## 2. æ©Ÿèƒ½ä¸€è¦§ã¨å®Ÿè£…çŠ¶æ³

| # | æ©Ÿèƒ½å | èª¬æ˜ | ç¾çŠ¶ | å„ªå…ˆåº¦ |
|---|--------|------|------|--------|
| 1.1 | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ | ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š | âš ï¸ ä¸€éƒ¨ | P1 |
| 1.2 | ãƒ¡ãƒ¼ãƒ«èªè¨¼ | ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèª | âŒ æœª | P1 |
| 1.3 | 2è¦ç´ èªè¨¼ (2FA) | TOTP (Google Authenticatorç­‰) | âŒ æœª | P2 |
| 1.4 | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†UI | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºãƒ»å¤±åŠ¹ | âŒ æœª | P2 |
| 1.5 | ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³æ‹¡å¼µ | Google, Microsoftè¿½åŠ  | âŒ æœª | P3 |

---

## 3. æ©Ÿèƒ½è©³ç´°è¨­è¨ˆ

### 3.1 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ

#### 3.1.1 ç¾çŠ¶åˆ†æ

```
ã€æ—¢å­˜å®Ÿè£…ã€‘
âœ… PasswordResetToken Entity
   - id, token, userId, expiresAt, usedAt, createdAt
âœ… PasswordResetTokenRepository
   - findByToken(), findByUserId()
âœ… Frontend UI
   - /password-reset (ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”»é¢)
   - /password-reset/confirm (ç¢ºèªç”»é¢)
   - /auth/password-reset (OTPæ–¹å¼)

ã€æœªå®Ÿè£…ã€‘
âŒ PasswordResetService (ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œãƒ»æ¤œè¨¼ãƒ»æ›´æ–°)
âŒ AuthenticationControlleræ‹¡å¼µ (APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ)
âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡çµ±åˆ (EmailServiceé€£æº)
```

#### 3.1.2 APIè¨­è¨ˆ

```yaml
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚
POST /auth/password-reset/request
Request:
  email: string (required, email format)
Response:
  200: { message: "ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ" }
  404: { error: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" }
  429: { error: "é€ä¿¡å›æ•°ä¸Šé™ã«é”ã—ã¾ã—ãŸ" } # Rate Limit

# ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
GET /auth/password-reset/verify?token={token}
Response:
  200: { valid: true, email: "masked@example.com" }
  400: { valid: false, reason: "EXPIRED" | "USED" | "INVALID" }

# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
POST /auth/password-reset
Request:
  token: string (required)
  newPassword: string (required, min 8 chars)
Response:
  200: { message: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ" }
  400: { error: "ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™" }
```

#### 3.1.3 å®Ÿè£…ã‚¿ã‚¹ã‚¯

```
â–¡ PasswordResetService.java å®Ÿè£…
  - requestPasswordReset(email): ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡
  - verifyToken(token): ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æ€§ç¢ºèª
  - resetPassword(token, newPassword): ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°

â–¡ AuthenticationController æ‹¡å¼µ
  - POST /auth/password-reset/request
  - GET /auth/password-reset/verify
  - POST /auth/password-reset

â–¡ EmailService çµ±åˆ
  - sendPasswordResetEmail(email, resetUrl)
  - FreeMarkerãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ

â–¡ ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¿½åŠ 
  - 5åˆ†é–“ã«3å›ã¾ã§
```

---

### 3.2 ãƒ¡ãƒ¼ãƒ«èªè¨¼

#### 3.2.1 ç¾çŠ¶åˆ†æ

```
ã€æ—¢å­˜å®Ÿè£…ã€‘
âœ… User.emailVerified ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
âœ… OtpToken Entity (èªè¨¼ç”¨ã«è»¢ç”¨å¯èƒ½)
âœ… EmailService åŸºç›¤

ã€æœªå®Ÿè£…ã€‘
âŒ èªè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆSignupæ™‚ã®è‡ªå‹•é€ä¿¡ï¼‰
âŒ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
âŒ UIï¼ˆèªè¨¼å¾…ã¡ç”»é¢ã€å†é€ä¿¡ï¼‰
```

#### 3.2.2 ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ãƒ¡ãƒ¼ãƒ«èªè¨¼ãƒ•ãƒ­ãƒ¼                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Signup   â”‚â”€â”€â”€â–¶â”‚ ãƒˆãƒ¼ã‚¯ãƒ³ â”‚â”€â”€â”€â–¶â”‚ ãƒ¡ãƒ¼ãƒ«   â”‚â”€â”€â”€â–¶â”‚ èªè¨¼å¾…ã¡ â”‚             â”‚
â”‚  â”‚ å®Œäº†     â”‚    â”‚ ç”Ÿæˆ     â”‚    â”‚ é€ä¿¡     â”‚    â”‚ çŠ¶æ…‹     â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                       â”‚                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                    â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚ ãƒ¡ãƒ¼ãƒ«   â”‚â”€â”€â”€â–¶â”‚ ãƒªãƒ³ã‚¯   â”‚â”€â”€â”€â–¶â”‚ èªè¨¼     â”‚                              â”‚
â”‚  â”‚ å—ä¿¡     â”‚    â”‚ ã‚¯ãƒªãƒƒã‚¯ â”‚    â”‚ å®Œäº†     â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                             â”‚
â”‚  ã€åˆ¶ç´„ã€‘                                                                   â”‚
â”‚  - ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™: 24æ™‚é–“                                                  â”‚
â”‚  - å†é€ä¿¡ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³: 60ç§’                                                  â”‚
â”‚  - æœªèªè¨¼æ™‚ã®æ©Ÿèƒ½åˆ¶é™: ä¸€éƒ¨æ©Ÿèƒ½ã®ã¿åˆ©ç”¨å¯èƒ½                                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2.3 APIè¨­è¨ˆ

```yaml
# èªè¨¼ãƒ¡ãƒ¼ãƒ«å†é€ä¿¡
POST /auth/email-verification/resend
Headers:
  Authorization: Bearer <token>
Response:
  200: { message: "èªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ" }
  429: { error: "ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã§ã™", retryAfter: 45 }

# ãƒ¡ãƒ¼ãƒ«èªè¨¼å®Œäº†
GET /auth/email-verification/verify?token={token}
Response:
  302: Redirect to /login?verified=true
  400: { error: "ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™" }
```

#### 3.2.4 å®Ÿè£…ã‚¿ã‚¹ã‚¯

```
â–¡ EmailVerificationService.java å®Ÿè£…
  - sendVerificationEmail(userId)
  - verifyEmail(token)

â–¡ AuthenticationController æ‹¡å¼µ
  - POST /auth/email-verification/resend
  - GET /auth/email-verification/verify

â–¡ Signupå‡¦ç†ä¿®æ­£
  - èªè¨¼ãƒ¡ãƒ¼ãƒ«è‡ªå‹•é€ä¿¡
  - emailVerified = false ã§Userä½œæˆ

â–¡ Frontend UI
  - /auth/verify-pending (èªè¨¼å¾…ã¡ç”»é¢)
  - å†é€ä¿¡ãƒœã‚¿ãƒ³
```

---

### 3.3 2è¦ç´ èªè¨¼ (2FA/TOTP)

#### 3.3.1 è¨­è¨ˆæ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        2FA (TOTP) ãƒ•ãƒ­ãƒ¼                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ã€è¨­å®šãƒ•ãƒ­ãƒ¼ã€‘                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ 2FAè¨­å®š  â”‚â”€â”€â”€â–¶â”‚ Secret   â”‚â”€â”€â”€â–¶â”‚ QRã‚³ãƒ¼ãƒ‰ â”‚â”€â”€â”€â–¶â”‚ ç¢ºèª     â”‚             â”‚
â”‚  â”‚ é–‹å§‹     â”‚    â”‚ ç”Ÿæˆ     â”‚    â”‚ è¡¨ç¤º     â”‚    â”‚ ã‚³ãƒ¼ãƒ‰   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                       â”‚                     â”‚
â”‚                                                       â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ 2FAæœ‰åŠ¹åŒ–â”‚â—€â”€â”€â”€â”‚ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆ8å€‹ï¼‰          â”‚                  â”‚
â”‚  â”‚ å®Œäº†     â”‚    â”‚ â€»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰/ã‚³ãƒ”ãƒ¼å¿…é ˆ              â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                             â”‚
â”‚  ã€èªè¨¼ãƒ•ãƒ­ãƒ¼ã€‘                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Login    â”‚â”€â”€â”€â–¶â”‚ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰â”‚â”€â”€â”€â–¶â”‚ TOTP     â”‚â”€â”€â”€â–¶â”‚ JWTç™ºè¡Œ  â”‚             â”‚
â”‚  â”‚ (email)  â”‚    â”‚ èªè¨¼æˆåŠŸ â”‚    â”‚ å…¥åŠ›     â”‚    â”‚          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3.2 ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

```java
@Entity
@Table(name = "mir_user_totp")
public class UserTotp {
    @Id
    private UUID id;
    
    @Column(name = "user_id", nullable = false, unique = true)
    private String userId;
    
    @Column(name = "secret", nullable = false, length = 64)
    private String secret; // Base32ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿
    
    @Column(name = "is_enabled", nullable = false)
    private Boolean isEnabled = false;
    
    @Column(name = "backup_codes", columnDefinition = "TEXT")
    private String backupCodes; // JSONé…åˆ—ã€SHA-256ãƒãƒƒã‚·ãƒ¥
    
    @Column(name = "last_used_at")
    private Instant lastUsedAt;
    
    @CreationTimestamp
    private Instant createdAt;
}
```

#### 3.3.3 APIè¨­è¨ˆ

```yaml
# 2FAè¨­å®šé–‹å§‹
POST /auth/2fa/setup
Headers:
  Authorization: Bearer <token>
Response:
  200:
    secret: "JBSWY3DPEHPK3PXP"
    qrCodeUrl: "otpauth://totp/mirelplatform:user@example.com?secret=..."
    qrCodeImage: "data:image/png;base64,..." # QRã‚³ãƒ¼ãƒ‰PNG

# 2FAæœ‰åŠ¹åŒ–
POST /auth/2fa/enable
Headers:
  Authorization: Bearer <token>
Request:
  code: "123456" # 6æ¡TOTP
Response:
  200:
    enabled: true
    backupCodes: ["abc12345", "def67890", ...] # 8å€‹

# 2FAç„¡åŠ¹åŒ–
POST /auth/2fa/disable
Request:
  code: "123456" # TOTPã¾ãŸã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰
Response:
  200: { disabled: true }

# 2FAãƒ­ã‚°ã‚¤ãƒ³æ¤œè¨¼
POST /auth/2fa/verify
Request:
  userId: "user-123"
  code: "123456"
Response:
  200: AuthenticationResponse (JWTç™ºè¡Œ)
  401: { error: "ã‚³ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã§ã™" }
```

#### 3.3.4 å®Ÿè£…ã‚¿ã‚¹ã‚¯

```
â–¡ ä¾å­˜é–¢ä¿‚è¿½åŠ 
  - com.warrenstrange:googleauth:1.5.0 (TOTPå®Ÿè£…)
  - com.google.zxing:core:3.5.2 (QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ)

â–¡ UserTotp Entity/Repository ä½œæˆ

â–¡ TotpService.java å®Ÿè£…
  - generateSecret(): Secretç”Ÿæˆ
  - generateQrCode(secret, email): QRã‚³ãƒ¼ãƒ‰ç”»åƒ
  - verifyCode(secret, code): TOTPæ¤œè¨¼
  - generateBackupCodes(): ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
  - useBackupCode(userId, code): ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ä½¿ç”¨

â–¡ AuthenticationServiceImpl æ‹¡å¼µ
  - loginæ™‚ã®2FAåˆ¤å®š
  - 2FAè¨­å®šæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä¸€æ™‚ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œâ†’2FAæ¤œè¨¼å¾ŒJWTç™ºè¡Œ

â–¡ Frontend UI
  - /settings/security/2fa (è¨­å®šç”»é¢)
  - QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰è¡¨ç¤º
  - /auth/2fa-verify (èªè¨¼ç”»é¢)
```

---

### 3.4 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†UI

#### 3.4.1 ç¾çŠ¶åˆ†æ

```
ã€æ—¢å­˜å®Ÿè£…ã€‘
âœ… RefreshToken Entity
   - id, userId, tokenHash, deviceInfo, expiresAt, revokedAt
âœ… RefreshTokenRepository
   - findValidTokensByUserId()

ã€æœªå®Ÿè£…ã€‘
âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§å–å¾—API
âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤±åŠ¹API
âŒ Frontend UI
```

#### 3.4.2 APIè¨­è¨ˆ

```yaml
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§å–å¾—
GET /auth/sessions
Headers:
  Authorization: Bearer <token>
Response:
  200:
    sessions:
      - id: "session-1"
        deviceInfo: "Chrome on Windows"
        ipAddress: "192.168.1.1"
        lastActiveAt: "2025-11-28T10:00:00Z"
        isCurrent: true
      - id: "session-2"
        deviceInfo: "Safari on macOS"
        ipAddress: "10.0.0.1"
        lastActiveAt: "2025-11-27T15:30:00Z"
        isCurrent: false

# ç‰¹å®šã‚»ãƒƒã‚·ãƒ§ãƒ³å¤±åŠ¹
DELETE /auth/sessions/{sessionId}
Response:
  200: { revoked: true }
  403: { error: "ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å¤±åŠ¹ã§ãã¾ã›ã‚“" } # ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å ´åˆ

# å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤±åŠ¹ï¼ˆç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³é™¤ãï¼‰
POST /auth/sessions/revoke-all
Response:
  200: { revokedCount: 3 }
```

#### 3.4.3 å®Ÿè£…ã‚¿ã‚¹ã‚¯

```
â–¡ RefreshToken æ‹¡å¼µ
  - ipAddress, userAgent ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ï¼ˆæ—¢å­˜ï¼Ÿç¢ºèªï¼‰

â–¡ SessionService.java å®Ÿè£…
  - listSessions(userId): ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§
  - revokeSession(sessionId): å€‹åˆ¥å¤±åŠ¹
  - revokeAllExceptCurrent(userId, currentTokenHash): ä¸€æ‹¬å¤±åŠ¹

â–¡ AuthenticationController æ‹¡å¼µ
  - GET /auth/sessions
  - DELETE /auth/sessions/{sessionId}
  - POST /auth/sessions/revoke-all

â–¡ Frontend UI
  - /settings/security (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šç”»é¢ã«ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ )
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«
  - ã€Œãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ãƒœã‚¿ãƒ³ï¼ˆå„ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰
  - ã€Œã™ã¹ã¦ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ãƒœã‚¿ãƒ³
```

---

## 4. ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¿½åŠ ãƒ»å¤‰æ›´

```sql
-- 2FAç”¨ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE mir_user_totp (
    id UUID PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL UNIQUE,
    secret VARCHAR(64) NOT NULL,
    is_enabled BOOLEAN NOT NULL DEFAULT FALSE,
    backup_codes TEXT, -- JSON array of hashed codes
    last_used_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES mir_user(user_id)
);

-- RefreshTokenæ‹¡å¼µï¼ˆæ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«å¤‰æ›´ï¼‰
ALTER TABLE mir_refresh_token
ADD COLUMN ip_address VARCHAR(45),
ADD COLUMN user_agent TEXT,
ADD COLUMN last_active_at TIMESTAMP;
```

---

## 5. ãƒ†ã‚¹ãƒˆè¨ˆç”»

### 5.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```
â–¡ PasswordResetServiceTest
  - requestPasswordReset_æ­£å¸¸ç³»
  - requestPasswordReset_å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼
  - verifyToken_æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³
  - verifyToken_æœŸé™åˆ‡ã‚Œ
  - resetPassword_æ­£å¸¸ç³»

â–¡ TotpServiceTest
  - generateSecret_ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèª
  - verifyCode_æ­£å¸¸ç³»ï¼ˆæ™‚é–“åŒæœŸï¼‰
  - verifyCode_ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰
  - useBackupCode_æ­£å¸¸ç³»
  - useBackupCode_ä½¿ç”¨æ¸ˆã¿
```

### 5.2 E2Eãƒ†ã‚¹ãƒˆ

```
â–¡ password-reset.spec.ts
  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚â†’ãƒ¡ãƒ¼ãƒ«ç¢ºèªâ†’ãƒªã‚»ãƒƒãƒˆå®Œäº†
  - æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã§ã‚¨ãƒ©ãƒ¼

â–¡ 2fa.spec.ts
  - 2FAè¨­å®šãƒ•ãƒ­ãƒ¼
  - 2FAæœ‰åŠ¹æ™‚ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼
  - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã§ã®ãƒ­ã‚°ã‚¤ãƒ³
```

---

## 6. å·¥æ•°è¦‹ç©ã‚‚ã‚Š

| æ©Ÿèƒ½ | è¦‹ç©ã‚‚ã‚Š | å‚™è€ƒ |
|------|----------|------|
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Œæˆ | 2æ—¥ | Entityæ¸ˆã¿ã€APIãƒ»ãƒ¡ãƒ¼ãƒ«çµ±åˆã®ã¿ |
| ãƒ¡ãƒ¼ãƒ«èªè¨¼ | 3æ—¥ | ãƒ•ãƒ­ãƒ¼å…¨ä½“å®Ÿè£… |
| 2FA (TOTP) | 5æ—¥ | æ–°è¦å®Ÿè£…ã€QRã‚³ãƒ¼ãƒ‰å«ã‚€ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†UI | 2æ—¥ | APIãƒ»UIå®Ÿè£… |
| **åˆè¨ˆ** | **12æ—¥** | |

---

**ä½œæˆæ—¥**: 2025å¹´11æœˆ28æ—¥  
**ä½œæˆè€…**: GitHub Copilot ğŸ¤–
