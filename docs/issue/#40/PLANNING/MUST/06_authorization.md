# RBACï¼ˆãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼‰è¨­è¨ˆæ›¸

## 1. æ¦‚è¦

SaaSãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆç’°å¢ƒã«ãŠã‘ã‚‹ROLEæ¯ã®æ©Ÿèƒ½ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¨­è¨ˆã™ã‚‹ã€‚
ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«æ¨©é™ï¼‰ã¨ãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆãƒ†ãƒŠãƒ³ãƒˆå†…æ¨©é™ï¼‰ã®2å±¤æ§‹é€ ã§èªå¯ã‚’ç®¡ç†ã™ã‚‹ã€‚

---

## 2. é³¥ç°å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           RBAC èªå¯ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ æ¦‚è¦å›³                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         èªè¨¼æ¸ˆã¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆ                                       â”‚ â”‚
â”‚  â”‚                    (JWT: userId, systemRoles, tenantId, tenantRole)             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚                                               â”‚
â”‚                                      â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                        Spring Security Filter Chain                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ 1. JwtAuthenticationFilter                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    - JWTãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    - SecurityContextã¸ã®Authenticationè¨­å®š                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    - GrantedAuthority: ROLE_ADMIN, ROLE_USER, TENANT_OWNER, etc.        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                      â”‚                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ 2. Pre-Authorization Layer                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚ @PreAuthorize          â”‚  â”‚ Method Security SpEL                â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚ hasRole('ADMIN')       â”‚  â”‚ hasRole() AND hasTenantRole()       â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â”‚ hasAnyRole('X','Y')    â”‚  â”‚ @TenantOwner @TenantManager         â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                      â”‚                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ 3. Controller / Service Layer                                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    - èªå¯é€šéå¾Œã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ                                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    - ExecutionContext ã§ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒ†ãƒŠãƒ³ãƒˆå‚ç…§                        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ãƒ­ãƒ¼ãƒ«éšå±¤æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ãƒ­ãƒ¼ãƒ«éšå±¤æ§‹é€                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ« (User.roles)ã€‘                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚  ã‚°ãƒ­ãƒ¼ãƒãƒ«æ¨©é™ã€‚å…¨ãƒ†ãƒŠãƒ³ãƒˆã«è·¨ãŒã‚‹ç®¡ç†æ“ä½œã‚’åˆ¶å¾¡                                     â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                                              â”‚    â”‚
â”‚  â”‚   SYSTEM_ADMIN (æœ€é«˜æ¨©é™)                                                    â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ ã™ã¹ã¦ã®ãƒ†ãƒŠãƒ³ãƒˆãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç®¡ç†                                       â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ç®¡ç†                                                 â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç™ºè¡Œãƒ»å–æ¶ˆ                                                   â”‚    â”‚
â”‚  â”‚   â””â”€â”€ ç›£æŸ»ãƒ­ã‚°é–²è¦§                                                           â”‚    â”‚
â”‚  â”‚         â”‚                                                                    â”‚    â”‚
â”‚  â”‚         â–¼                                                                    â”‚    â”‚
â”‚  â”‚   ADMIN (é‹ç”¨ç®¡ç†è€…)                                                         â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§é–²è¦§ãƒ»åŸºæœ¬æ›´æ–°                                           â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°å‚ç…§                                                 â”‚    â”‚
â”‚  â”‚   â””â”€â”€ ç›£æŸ»ãƒ­ã‚°å‚ç…§ï¼ˆè‡ªãƒ†ãƒŠãƒ³ãƒˆåˆ†ï¼‰                                           â”‚    â”‚
â”‚  â”‚         â”‚                                                                    â”‚    â”‚
â”‚  â”‚         â–¼                                                                    â”‚    â”‚
â”‚  â”‚   USER (ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼)                                                        â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†                                                 â”‚    â”‚
â”‚  â”‚   â””â”€â”€ æ‰€å±ãƒ†ãƒŠãƒ³ãƒˆå†…ã®æ“ä½œï¼ˆãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã«ä¾å­˜ï¼‰                            â”‚    â”‚
â”‚  â”‚                                                                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                      â”‚
â”‚  ã€ãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ« (UserTenant.roleInTenant)ã€‘                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  ãƒ†ãƒŠãƒ³ãƒˆå†…æ¨©é™ã€‚å„ãƒ†ãƒŠãƒ³ãƒˆç‹¬ç«‹ã§è¨­å®šå¯èƒ½                                            â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                                              â”‚    â”‚
â”‚  â”‚   OWNER (ãƒ†ãƒŠãƒ³ãƒˆã‚ªãƒ¼ãƒŠãƒ¼)                                                   â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ ãƒ†ãƒŠãƒ³ãƒˆè¨­å®šã™ã¹ã¦å¤‰æ›´å¯                                               â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…ãƒ»å‰Šé™¤                                                     â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ ä»–ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ­ãƒ¼ãƒ«å¤‰æ›´                                                 â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ ãƒ†ãƒŠãƒ³ãƒˆå‰Šé™¤                                                           â”‚    â”‚
â”‚  â”‚   â””â”€â”€ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç®¡ç†ï¼ˆãƒ—ãƒ©ãƒ³å¤‰æ›´ç”³è«‹ï¼‰                                        â”‚    â”‚
â”‚  â”‚         â”‚                                                                    â”‚    â”‚
â”‚  â”‚         â–¼                                                                    â”‚    â”‚
â”‚  â”‚   MANAGER (ç®¡ç†è€…)                                                           â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…ï¼ˆMEMBERä»¥ä¸‹ã®ã¿ï¼‰                                          â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ ãƒ†ãƒŠãƒ³ãƒˆåŸºæœ¬è¨­å®šå¤‰æ›´                                                   â”‚    â”‚
â”‚  â”‚   â””â”€â”€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šå¤‰æ›´                                               â”‚    â”‚
â”‚  â”‚         â”‚                                                                    â”‚    â”‚
â”‚  â”‚         â–¼                                                                    â”‚    â”‚
â”‚  â”‚   MEMBER (ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼)                                                      â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é€šå¸¸åˆ©ç”¨                                               â”‚    â”‚
â”‚  â”‚   â””â”€â”€ è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†                                                       â”‚    â”‚
â”‚  â”‚         â”‚                                                                    â”‚    â”‚
â”‚  â”‚         â–¼                                                                    â”‚    â”‚
â”‚  â”‚   GUEST (é–²è¦§è€…)                                                             â”‚    â”‚
â”‚  â”‚   â””â”€â”€ èª­ã¿å–ã‚Šå°‚ç”¨ã‚¢ã‚¯ã‚»ã‚¹                                                   â”‚    â”‚
â”‚  â”‚                                                                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                      â”‚
â”‚  ã€ãƒ­ãƒ¼ãƒ«ç¶™æ‰¿å›³ã€‘                                                                    â”‚
â”‚  SYSTEM_ADMIN â”€â”€â”€â”€â–¶ ADMIN â”€â”€â”€â”€â–¶ USER                                                â”‚
â”‚  OWNER â”€â”€â”€â”€â–¶ MANAGER â”€â”€â”€â”€â–¶ MEMBER â”€â”€â”€â”€â–¶ GUEST                                       â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. æ©Ÿèƒ½åˆ¥ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒãƒˆãƒªã‚¯ã‚¹

### 4.1 ç®¡ç†ç³»API

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Admin API ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒãƒˆãƒªã‚¯ã‚¹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                  â”‚ SYSTEM_ADMIN â”‚ ADMIN â”‚ USER â”‚ å‚™è€ƒ              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ GET  /admin/users                â”‚      âœ…      â”‚   âœ…  â”‚  âŒ  â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§       â”‚
â”‚ GET  /admin/users/{id}           â”‚      âœ…      â”‚   âœ…  â”‚  âŒ  â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°       â”‚
â”‚ PUT  /admin/users/{id}           â”‚      âœ…      â”‚   âš ï¸  â”‚  âŒ  â”‚ ADMIN:è‡ªå·±æ›´æ–°ã®ã¿ â”‚
â”‚ DELETE /admin/users/{id}         â”‚      âœ…      â”‚   âŒ  â”‚  âŒ  â”‚ SYSTEM_ADMINã®ã¿   â”‚
â”‚                                  â”‚              â”‚       â”‚      â”‚                   â”‚
â”‚ GET  /admin/tenants              â”‚      âœ…      â”‚   âŒ  â”‚  âŒ  â”‚ ãƒ†ãƒŠãƒ³ãƒˆä¸€è¦§       â”‚
â”‚ POST /admin/tenants              â”‚      âœ…      â”‚   âŒ  â”‚  âŒ  â”‚ ãƒ†ãƒŠãƒ³ãƒˆä½œæˆ       â”‚
â”‚ PUT  /admin/tenants/{id}         â”‚      âœ…      â”‚   âŒ  â”‚  âŒ  â”‚ ãƒ†ãƒŠãƒ³ãƒˆæ›´æ–°       â”‚
â”‚ DELETE /admin/tenants/{id}       â”‚      âœ…      â”‚   âŒ  â”‚  âŒ  â”‚ ãƒ†ãƒŠãƒ³ãƒˆå‰Šé™¤       â”‚
â”‚                                  â”‚              â”‚       â”‚      â”‚                   â”‚
â”‚ GET  /admin/features             â”‚      âœ…      â”‚   âœ…  â”‚  âŒ  â”‚ ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ä¸€è¦§   â”‚
â”‚ POST /admin/features             â”‚      âœ…      â”‚   âŒ  â”‚  âŒ  â”‚ ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ä½œæˆ   â”‚
â”‚ PUT  /admin/features/{id}        â”‚      âœ…      â”‚   âŒ  â”‚  âŒ  â”‚ ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼æ›´æ–°   â”‚
â”‚ DELETE /admin/features/{id}      â”‚      âœ…      â”‚   âŒ  â”‚  âŒ  â”‚ ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼å‰Šé™¤   â”‚
â”‚                                  â”‚              â”‚       â”‚      â”‚                   â”‚
â”‚ GET  /admin/licenses             â”‚      âœ…      â”‚   âŒ  â”‚  âŒ  â”‚ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä¸€è¦§     â”‚
â”‚ POST /admin/licenses             â”‚      âœ…      â”‚   âŒ  â”‚  âŒ  â”‚ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç™ºè¡Œ     â”‚
â”‚ DELETE /admin/licenses/{id}      â”‚      âœ…      â”‚   âŒ  â”‚  âŒ  â”‚ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å–æ¶ˆ     â”‚
â”‚                                  â”‚              â”‚       â”‚      â”‚                   â”‚
â”‚ GET  /admin/audit-logs           â”‚      âœ…      â”‚   âš ï¸  â”‚  âŒ  â”‚ ADMIN:è‡ªãƒ†ãƒŠãƒ³ãƒˆ  â”‚
â”‚                                  â”‚              â”‚       â”‚      â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‡¡ä¾‹: âœ… è¨±å¯  âŒ æ‹’å¦  âš ï¸ æ¡ä»¶ä»˜ãè¨±å¯
```

### 4.2 ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†APIï¼ˆãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Tenant API ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒãƒˆãƒªã‚¯ã‚¹ (ãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                  â”‚ OWNER â”‚ MANAGER â”‚ MEMBER â”‚ GUEST â”‚ å‚™è€ƒ         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ GET  /tenants/{id}               â”‚   âœ…  â”‚    âœ…   â”‚   âœ…   â”‚   âœ…  â”‚ æƒ…å ±é–²è¦§     â”‚
â”‚ PUT  /tenants/{id}               â”‚   âœ…  â”‚    âš ï¸   â”‚   âŒ   â”‚   âŒ  â”‚ MGR:åŸºæœ¬ã®ã¿ â”‚
â”‚ DELETE /tenants/{id}             â”‚   âœ…  â”‚    âŒ   â”‚   âŒ   â”‚   âŒ  â”‚ å‰Šé™¤ç”³è«‹     â”‚
â”‚                                  â”‚       â”‚         â”‚        â”‚       â”‚              â”‚
â”‚ GET  /tenants/{id}/members       â”‚   âœ…  â”‚    âœ…   â”‚   âœ…   â”‚   âœ…  â”‚ ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ â”‚
â”‚ POST /tenants/{id}/members       â”‚   âœ…  â”‚    âš ï¸   â”‚   âŒ   â”‚   âŒ  â”‚ MGR:MEMBERâ†“  â”‚
â”‚ PUT  /tenants/{id}/members/{uid} â”‚   âœ…  â”‚    âš ï¸   â”‚   âŒ   â”‚   âŒ  â”‚ MGR:MEMBERâ†“  â”‚
â”‚ DELETE /tenants/{id}/members/{u} â”‚   âœ…  â”‚    âš ï¸   â”‚   âŒ   â”‚   âŒ  â”‚ MGR:MEMBERâ†“  â”‚
â”‚                                  â”‚       â”‚         â”‚        â”‚       â”‚              â”‚
â”‚ GET  /tenants/{id}/settings      â”‚   âœ…  â”‚    âœ…   â”‚   âŒ   â”‚   âŒ  â”‚ è¨­å®šé–²è¦§     â”‚
â”‚ PUT  /tenants/{id}/settings      â”‚   âœ…  â”‚    âœ…   â”‚   âŒ   â”‚   âŒ  â”‚ è¨­å®šå¤‰æ›´     â”‚
â”‚                                  â”‚       â”‚         â”‚        â”‚       â”‚              â”‚
â”‚ POST /tenants/{id}/invitations   â”‚   âœ…  â”‚    âš ï¸   â”‚   âŒ   â”‚   âŒ  â”‚ æ‹›å¾…é€ä¿¡     â”‚
â”‚ DELETE /tenants/{id}/invitations â”‚   âœ…  â”‚    âœ…   â”‚   âŒ   â”‚   âŒ  â”‚ æ‹›å¾…å–æ¶ˆ     â”‚
â”‚                                  â”‚       â”‚         â”‚        â”‚       â”‚              â”‚
â”‚ POST /tenants/{id}/transfer      â”‚   âœ…  â”‚    âŒ   â”‚   âŒ   â”‚   âŒ  â”‚ ã‚ªãƒ¼ãƒŠãƒ¼å§”è­² â”‚
â”‚                                  â”‚       â”‚         â”‚        â”‚       â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªå·±ç®¡ç†API

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       User Self-Service API ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                  â”‚ èªè¨¼æ¸ˆã¿ â”‚ æ¡ä»¶                                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ GET  /users/me                   â”‚    âœ…    â”‚ è‡ªåˆ†ã®æƒ…å ±ã®ã¿                         â”‚
â”‚ PUT  /users/me                   â”‚    âœ…    â”‚ è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿                 â”‚
â”‚ PUT  /users/me/password          â”‚    âœ…    â”‚ ç¾åœ¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿…é ˆ                     â”‚
â”‚ GET  /users/me/tenants           â”‚    âœ…    â”‚ è‡ªåˆ†ã®æ‰€å±ãƒ†ãƒŠãƒ³ãƒˆ                     â”‚
â”‚ GET  /users/me/licenses          â”‚    âœ…    â”‚ è‡ªåˆ†ã®æœ‰åŠ¹ãƒ©ã‚¤ã‚»ãƒ³ã‚¹                   â”‚
â”‚ GET  /users/me/sessions          â”‚    âœ…    â”‚ è‡ªåˆ†ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³             â”‚
â”‚ DELETE /users/me/sessions/{id}   â”‚    âœ…    â”‚ è‡ªåˆ†ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿                   â”‚
â”‚ POST /users/me/data-export       â”‚    âœ…    â”‚ GDPR: è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ         â”‚
â”‚ POST /users/me/data-deletion     â”‚    âœ…    â”‚ GDPR: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ç”³è«‹               â”‚
â”‚                                  â”‚          â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³APIï¼ˆProMarkerç­‰ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Application API ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒãƒˆãƒªã‚¯ã‚¹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                  â”‚ OWNER â”‚ MANAGER â”‚ MEMBER â”‚ GUEST â”‚ å‚™è€ƒ         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ GET  /apps/mste/stencils         â”‚   âœ…  â”‚    âœ…   â”‚   âœ…   â”‚   âœ…  â”‚ ä¸€è¦§é–²è¦§     â”‚
â”‚ POST /apps/mste/stencils         â”‚   âœ…  â”‚    âœ…   â”‚   âœ…   â”‚   âŒ  â”‚ ä½œæˆ         â”‚
â”‚ PUT  /apps/mste/stencils/{id}    â”‚   âœ…  â”‚    âœ…   â”‚   âš ï¸   â”‚   âŒ  â”‚ MBR:è‡ªåˆ†ã®ã¿ â”‚
â”‚ DELETE /apps/mste/stencils/{id}  â”‚   âœ…  â”‚    âœ…   â”‚   âš ï¸   â”‚   âŒ  â”‚ MBR:è‡ªåˆ†ã®ã¿ â”‚
â”‚                                  â”‚       â”‚         â”‚        â”‚       â”‚              â”‚
â”‚ POST /apps/mste/api/generate     â”‚   âœ…  â”‚    âœ…   â”‚   âœ…   â”‚   âŒ  â”‚ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è¦ â”‚
â”‚ POST /apps/mste/api/preview      â”‚   âœ…  â”‚    âœ…   â”‚   âœ…   â”‚   âœ…  â”‚ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼   â”‚
â”‚                                  â”‚       â”‚         â”‚        â”‚       â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â€» ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã«ã‚ˆã‚‹è¿½åŠ åˆ¶å¾¡
  - FREE: ç”Ÿæˆå›æ•°åˆ¶é™ã‚ã‚Šï¼ˆ10å›/æ—¥ï¼‰
  - TRIAL: ç”Ÿæˆå›æ•°åˆ¶é™ã‚ã‚Šï¼ˆ50å›/æ—¥ï¼‰ã€æœ‰åŠ¹æœŸé™ã‚ã‚Š
  - PRO/MAX: ç„¡åˆ¶é™ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®ã¿ï¼‰
```

---

## 5. å®Ÿè£…è¨­è¨ˆ

### 5.1 ç¾çŠ¶åˆ†æ

```
ã€æ—¢å­˜å®Ÿè£…ã€‘
âœ… User.roles: ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«æ ¼ç´ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šæ–‡å­—åˆ—ï¼‰
âœ… UserTenant.roleInTenant: ãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ ¼ç´
âœ… @PreAuthorize("hasRole('ADMIN')") ãŒ AdminUserController, AdminFeatureFlagController ã«é©ç”¨
âœ… JwtAuthenticationFilter ã§ roles â†’ GrantedAuthority å¤‰æ›

ã€æœªå®Ÿè£…ãƒ»èª²é¡Œã€‘
âŒ SYSTEM_ADMIN / ADMIN ã®åŒºåˆ¥ãŒãªã„ï¼ˆç¾åœ¨ADMINã®ã¿ï¼‰
âŒ ãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆOWNER/MANAGER/MEMBER/GUESTï¼‰ã®ãƒã‚§ãƒƒã‚¯æ©Ÿæ§‹
âŒ ãƒ­ãƒ¼ãƒ«éšå±¤ï¼ˆSYSTEM_ADMIN > ADMIN > USERï¼‰ã®å®Ÿè£…
âŒ ãƒ†ãƒŠãƒ³ãƒˆè·¨ãæ“ä½œã®åˆ¶å¾¡
âŒ ãƒªã‚½ãƒ¼ã‚¹æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ç·¨é›†å¯ï¼‰
```

### 5.2 ãƒ­ãƒ¼ãƒ«å®šç¾©

```java
// SystemRole.java
public enum SystemRole {
    SYSTEM_ADMIN("SYSTEM_ADMIN", 100),  // æœ€é«˜æ¨©é™
    ADMIN("ADMIN", 50),                  // é‹ç”¨ç®¡ç†è€…
    USER("USER", 10);                    // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼
    
    private final String name;
    private final int priority;
    
    // ãƒ­ãƒ¼ãƒ«éšå±¤åˆ¤å®š
    public boolean isHigherOrEqualTo(SystemRole other) {
        return this.priority >= other.priority;
    }
}

// TenantRole.java
public enum TenantRole {
    OWNER("OWNER", 100),
    MANAGER("MANAGER", 75),
    MEMBER("MEMBER", 50),
    GUEST("GUEST", 10);
    
    private final String name;
    private final int priority;
    
    public boolean isHigherOrEqualTo(TenantRole other) {
        return this.priority >= other.priority;
    }
    
    public boolean canManageRole(TenantRole targetRole) {
        // OWNERã¯ã™ã¹ã¦ç®¡ç†å¯èƒ½ã€MANAGERã¯MEMBERä»¥ä¸‹ã®ã¿
        if (this == OWNER) return true;
        if (this == MANAGER) return targetRole.priority <= MEMBER.priority;
        return false;
    }
}
```

### 5.3 ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

```java
// ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«è¦æ±‚
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@PreAuthorize("@authorizationService.hasSystemRole(authentication, #root)")
public @interface RequireSystemRole {
    SystemRole value();
    boolean allowHigher() default true;  // ä¸Šä½ãƒ­ãƒ¼ãƒ«ã‚‚è¨±å¯
}

// ãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¦æ±‚
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@PreAuthorize("@authorizationService.hasTenantRole(authentication, #root)")
public @interface RequireTenantRole {
    TenantRole value();
    boolean allowHigher() default true;
}

// ãƒªã‚½ãƒ¼ã‚¹æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@PreAuthorize("@authorizationService.isResourceOwner(authentication, #id, #root)")
public @interface RequireResourceOwner {
    String resourceType();
    String idParam() default "id";
}

// è¤‡åˆæ¡ä»¶ï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ã¾ãŸã¯ãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼‰
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireAnyRole {
    SystemRole[] systemRoles() default {};
    TenantRole[] tenantRoles() default {};
}
```

### 5.4 AuthorizationService

```java
@Service("authorizationService")
public class AuthorizationService {
    
    @Autowired
    private ExecutionContext executionContext;
    
    @Autowired
    private UserTenantRepository userTenantRepository;
    
    /**
     * ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
     */
    public boolean hasSystemRole(Authentication auth, MethodSecurityExpressionOperations root) {
        RequireSystemRole annotation = getAnnotation(root, RequireSystemRole.class);
        if (annotation == null) return true;
        
        SystemRole required = annotation.value();
        SystemRole current = getCurrentSystemRole(auth);
        
        if (annotation.allowHigher()) {
            return current.isHigherOrEqualTo(required);
        }
        return current == required;
    }
    
    /**
     * ãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
     */
    public boolean hasTenantRole(Authentication auth, MethodSecurityExpressionOperations root) {
        RequireTenantRole annotation = getAnnotation(root, RequireTenantRole.class);
        if (annotation == null) return true;
        
        TenantRole required = annotation.value();
        TenantRole current = getCurrentTenantRole();
        
        if (annotation.allowHigher()) {
            return current.isHigherOrEqualTo(required);
        }
        return current == required;
    }
    
    /**
     * ãƒªã‚½ãƒ¼ã‚¹æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯
     */
    public boolean isResourceOwner(Authentication auth, String resourceId, 
                                    MethodSecurityExpressionOperations root) {
        RequireResourceOwner annotation = getAnnotation(root, RequireResourceOwner.class);
        if (annotation == null) return true;
        
        String resourceType = annotation.resourceType();
        String currentUserId = executionContext.getCurrentUserId();
        
        // ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸæ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯
        return checkOwnership(resourceType, resourceId, currentUserId);
    }
    
    /**
     * ç¾åœ¨ã®ãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å–å¾—
     */
    public TenantRole getCurrentTenantRole() {
        String userId = executionContext.getCurrentUserId();
        String tenantId = executionContext.getCurrentTenantId();
        
        UserTenant ut = userTenantRepository.findByUserIdAndTenantId(userId, tenantId)
            .orElseThrow(() -> new AccessDeniedException("Not a member of this tenant"));
        
        return TenantRole.valueOf(ut.getRoleInTenant());
    }
}
```

### 5.5 ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼é©ç”¨ä¾‹

```java
// ç¾åœ¨ã®å®Ÿè£…
@RestController
@RequestMapping("/admin/users")
@PreAuthorize("hasRole('ADMIN')")  // ç¾çŠ¶
public class AdminUserController { ... }

// æ”¹å–„å¾Œ
@RestController
@RequestMapping("/admin/users")
@RequireSystemRole(SystemRole.ADMIN)  // ãƒ­ãƒ¼ãƒ«éšå±¤å¯¾å¿œ
public class AdminUserController {

    @GetMapping
    public ResponseEntity<UserListResponse> listUsers(...) { ... }
    
    @PutMapping("/{id}")
    @RequireSystemRole(SystemRole.SYSTEM_ADMIN)  // æ›´æ–°ã¯SYSTEM_ADMINã®ã¿
    public ResponseEntity<AdminUserDto> updateUser(...) { ... }
    
    @DeleteMapping("/{id}")
    @RequireSystemRole(SystemRole.SYSTEM_ADMIN)  // å‰Šé™¤ã¯SYSTEM_ADMINã®ã¿
    public ResponseEntity<Void> deleteUser(...) { ... }
}

// ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
@RestController
@RequestMapping("/tenants/{tenantId}/members")
public class TenantMemberController {

    @GetMapping
    @RequireTenantRole(TenantRole.GUEST)  // å…¨å“¡é–²è¦§å¯
    public ResponseEntity<List<MemberDto>> listMembers(...) { ... }
    
    @PostMapping
    @RequireTenantRole(TenantRole.MANAGER)  // MANAGERä»¥ä¸Š
    public ResponseEntity<MemberDto> addMember(...) { ... }
    
    @DeleteMapping("/{userId}")
    @RequireTenantRole(TenantRole.MANAGER)
    public ResponseEntity<Void> removeMember(
        @PathVariable String tenantId,
        @PathVariable String userId) {
        // è¿½åŠ ãƒã‚§ãƒƒã‚¯: MANAGERã¯MEMBERä»¥ä¸‹ã®ã¿å‰Šé™¤å¯
        TenantRole currentRole = authService.getCurrentTenantRole();
        TenantRole targetRole = getTargetUserRole(tenantId, userId);
        
        if (!currentRole.canManageRole(targetRole)) {
            throw new AccessDeniedException("Cannot remove user with higher role");
        }
        // ...
    }
}
```

---

## 6. JWTæ‹¡å¼µ

### 6.1 ç¾åœ¨ã®JWTã‚¯ãƒ¬ãƒ¼ãƒ 

```json
{
  "sub": "user-123",
  "email": "user@example.com",
  "roles": ["USER"],
  "tenantId": "tenant-abc",
  "iat": 1732780800,
  "exp": 1732784400
}
```

### 6.2 æ‹¡å¼µJWTã‚¯ãƒ¬ãƒ¼ãƒ 

```json
{
  "sub": "user-123",
  "email": "user@example.com",
  "systemRoles": ["USER"],
  "currentTenant": {
    "tenantId": "tenant-abc",
    "tenantName": "My Workspace",
    "roleInTenant": "OWNER"
  },
  "allTenants": [
    { "tenantId": "tenant-abc", "role": "OWNER" },
    { "tenantId": "tenant-xyz", "role": "MEMBER" }
  ],
  "iat": 1732780800,
  "exp": 1732784400
}
```

### 6.3 èªè¨¼æ™‚ã®GrantedAuthorityè¨­å®š

```java
// JwtAuthenticationFilterã§ã®æ¨©é™è¨­å®š
private Collection<GrantedAuthority> extractAuthorities(Claims claims) {
    List<GrantedAuthority> authorities = new ArrayList<>();
    
    // ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«
    List<String> systemRoles = claims.get("systemRoles", List.class);
    for (String role : systemRoles) {
        authorities.add(new SimpleGrantedAuthority("ROLE_" + role));
    }
    
    // ãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    Map<String, Object> currentTenant = claims.get("currentTenant", Map.class);
    if (currentTenant != null) {
        String tenantRole = (String) currentTenant.get("roleInTenant");
        authorities.add(new SimpleGrantedAuthority("TENANT_" + tenantRole));
    }
    
    return authorities;
}
```

---

## 7. å®Ÿè£…ã‚¿ã‚¹ã‚¯

```
ã€Phase 1: åŸºç›¤æ•´å‚™ (Week 1)ã€‘
â–¡ SystemRole, TenantRole enumä½œæˆ
â–¡ AuthorizationService å®Ÿè£…
â–¡ @RequireSystemRole, @RequireTenantRole ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
â–¡ æ—¢å­˜ @PreAuthorize ã‚’æ–°ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ç§»è¡Œ
  - AdminUserController
  - AdminFeatureFlagController

ã€Phase 2: JWTæ‹¡å¼µ (Week 1-2)ã€‘
â–¡ JWTç”Ÿæˆæ™‚ã«ãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å«ã‚ã‚‹
â–¡ JwtAuthenticationFilter ã§ã® GrantedAuthority æ‹¡å¼µ
â–¡ ExecutionContext ã«ãƒ†ãƒŠãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¿½åŠ 

ã€Phase 3: ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†API (Week 2)ã€‘
â–¡ TenantMemberController å®Ÿè£…
  - @RequireTenantRole é©ç”¨
  - ãƒ­ãƒ¼ãƒ«éšå±¤ãƒã‚§ãƒƒã‚¯

â–¡ TenantSettingsController å®Ÿè£…

ã€Phase 4: ãƒªã‚½ãƒ¼ã‚¹æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ (Week 3)ã€‘
â–¡ @RequireResourceOwner ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
â–¡ Stencilç­‰ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚½ãƒ¼ã‚¹ã«é©ç”¨

ã€Phase 5: ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼ (Week 3)ã€‘
â–¡ èªå¯ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ 
  - å„ãƒ­ãƒ¼ãƒ«ã§ã®ã‚¢ã‚¯ã‚»ã‚¹å¯å¦
  - ãƒ­ãƒ¼ãƒ«éšå±¤ã®å‹•ä½œç¢ºèª
  - ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®403ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª

â–¡ E2Eãƒ†ã‚¹ãƒˆ
  - Adminç”»é¢ã®æ¨©é™åˆ¥è¡¨ç¤ºç¢ºèª
```

---

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â–¡ æ¨©é™ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é˜²æ­¢                                                         â”‚
â”‚    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«ã‚’å¤‰æ›´ã§ããªã„ã“ã¨                                       â”‚
â”‚    - MANAGERãŒè‡ªåˆ†ã‚ˆã‚Šä¸Šä½ã®ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸ã§ããªã„ã“ã¨                                â”‚
â”‚                                                                                     â”‚
â”‚  â–¡ æ°´å¹³æ¨©é™æ˜‡æ ¼é˜²æ­¢                                                                 â”‚
â”‚    - ä»–ãƒ†ãƒŠãƒ³ãƒˆã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨                                     â”‚
â”‚    - tenantId ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¾¹åº•                                                  â”‚
â”‚                                                                                     â”‚
â”‚  â–¡ IDOR (Insecure Direct Object Reference) é˜²æ­¢                                    â”‚
â”‚    - ãƒªã‚½ãƒ¼ã‚¹IDã ã‘ã§ãªãæ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†                                       â”‚
â”‚    - UUIDæ¨æ¸¬å›°é›£æ€§ã ã‘ã«é ¼ã‚‰ãªã„                                                   â”‚
â”‚                                                                                     â”‚
â”‚  â–¡ èªå¯ãƒã‚¤ãƒ‘ã‚¹é˜²æ­¢                                                                 â”‚
â”‚    - ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ä»¥å¤–ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆç¢ºèª                                     â”‚
â”‚    - å†…éƒ¨APIã‹ã‚‰ã®å‘¼ã³å‡ºã—ã§ã‚‚èªå¯ãƒã‚§ãƒƒã‚¯                                          â”‚
â”‚                                                                                     â”‚
â”‚  â–¡ ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²                                                                     â”‚
â”‚    - æ¨©é™å¤‰æ›´æ“ä½œã¯å¿…ãšãƒ­ã‚°è¨˜éŒ²                                                     â”‚
â”‚    - èªå¯æ‹’å¦ã‚¤ãƒ™ãƒ³ãƒˆã‚‚ãƒ­ã‚°è¨˜éŒ²                                                     â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. å·¥æ•°è¦‹ç©ã‚‚ã‚Š

| æ©Ÿèƒ½ | è¦‹ç©ã‚‚ã‚Š | å‚™è€ƒ |
|------|----------|------|
| ãƒ­ãƒ¼ãƒ«å®šç¾©ãƒ»AuthorizationService | 2æ—¥ | enum + Service |
| ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ | 2æ—¥ | AOPå®Ÿè£…å«ã‚€ |
| JWTæ‹¡å¼µ | 1æ—¥ | ã‚¯ãƒ¬ãƒ¼ãƒ è¿½åŠ  |
| æ—¢å­˜Controllerç§»è¡Œ | 1æ—¥ | AdminUser, AdminFeatureFlag |
| ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†API | 3æ—¥ | Member, Settings |
| ãƒªã‚½ãƒ¼ã‚¹æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ | 2æ—¥ | @RequireResourceOwner |
| ãƒ†ã‚¹ãƒˆ | 2æ—¥ | å˜ä½“ + E2E |
| **åˆè¨ˆ** | **13æ—¥** | |

---

**ä½œæˆæ—¥**: 2025å¹´11æœˆ28æ—¥  
**ä½œæˆè€…**: GitHub Copilot ğŸ¤–


