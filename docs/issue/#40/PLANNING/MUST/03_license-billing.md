# ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ»èª²é‡‘ç®¡ç† æ©Ÿèƒ½è¨­è¨ˆæ›¸

## 1. æ¦‚è¦

SaaSãƒ“ã‚¸ãƒã‚¹ã®æ ¹å¹¹ã¨ãªã‚‹ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç®¡ç†ãƒ»èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ ã€‚
ãƒ†ã‚£ã‚¢åˆ¶ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ï¼ˆFREE/TRIAL/PRO/MAXï¼‰ã®æœ‰åŠ¹æœŸé™ç®¡ç†ã€ä½¿ç”¨é‡åˆ¶é™ã€èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ é€£æºã‚’å®Ÿç¾ã™ã‚‹ã€‚

---

## 2. æ©Ÿèƒ½ä¸€è¦§ã¨å®Ÿè£…çŠ¶æ³

| # | æ©Ÿèƒ½å | èª¬æ˜ | ç¾çŠ¶ | å„ªå…ˆåº¦ |
|---|--------|------|------|--------|
| 3.1 | ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æœ‰åŠ¹æœŸé™ç®¡ç† | æœŸé™åˆ‡ã‚Œæ¤œçŸ¥ãƒ»é€šçŸ¥ãƒ»ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ | âš ï¸ Entityæœ‰ | P1 |
| 3.2 | ä½¿ç”¨é‡åˆ¶é™ (Quota) | APIå‘¼ã³å‡ºã—æ•°ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆ¶é™ | âŒ æœª | P2 |
| 3.3 | èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ é€£æºæº–å‚™ | Stripeçµ±åˆã€Webhookå‡¦ç† | âŒ æœª | P2 |
| 3.4 | ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ | ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰/ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ | âŒ æœª | P2 |
| 3.5 | è«‹æ±‚æ›¸ç”Ÿæˆ | PDFè«‹æ±‚æ›¸ã€å±¥æ­´ç®¡ç† | âŒ æœª | P3 |
| 3.6 | Admin ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç®¡ç† | ç®¡ç†è€…å‘ã‘ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ“ä½œ | âŒ æœª | P2 |

---

## 3. æ©Ÿèƒ½è©³ç´°è¨­è¨ˆ

### 3.1 ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æœ‰åŠ¹æœŸé™ç®¡ç†

#### 3.1.1 ç¾çŠ¶åˆ†æ

```
ã€æ—¢å­˜å®Ÿè£…ã€‘
âœ… ApplicationLicense Entity
   - id, subjectType (USER/TENANT), subjectId, applicationId
   - tier (FREE/PRO/MAX), expiresAt, grantedAt, grantedBy
âœ… ApplicationLicenseRepository
   - findEffectiveLicenses(userId, tenantId, now)
   - findBySubjectAndApplication()
âœ… ExecutionContext.hasLicense(applicationId, tier)

ã€æœªå®Ÿè£…ã€‘
âŒ æœŸé™åˆ‡ã‚Œæ¤œçŸ¥ãƒãƒƒãƒ
âŒ æœŸé™åˆ‡ã‚Œäº‹å‰é€šçŸ¥ï¼ˆ7æ—¥å‰ã€1æ—¥å‰ï¼‰
âŒ è‡ªå‹•ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰å‡¦ç†
âŒ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ›´æ–°ãƒ•ãƒ­ãƒ¼
```

#### 3.1.2 ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æœ‰åŠ¹æœŸé™ç®¡ç†ãƒ•ãƒ­ãƒ¼                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ã€æœŸé™åˆ‡ã‚Œäº‹å‰é€šçŸ¥ã€‘                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ æ—¥æ¬¡     â”‚â”€â”€â”€â–¶â”‚ 7æ—¥å‰    â”‚â”€â”€â”€â–¶â”‚ 1æ—¥å‰    â”‚â”€â”€â”€â–¶â”‚ æœŸé™åˆ‡ã‚Œ â”‚             â”‚
â”‚  â”‚ ãƒãƒƒãƒ   â”‚    â”‚ é€šçŸ¥     â”‚    â”‚ é€šçŸ¥     â”‚    â”‚ å½“æ—¥é€šçŸ¥ â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                             â”‚
â”‚  ã€æœŸé™åˆ‡ã‚Œå‡¦ç†ã€‘                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ æœŸé™åˆ‡ã‚Œ â”‚â”€â”€â”€â–¶â”‚ çŒ¶äºˆæœŸé–“ï¼ˆ7æ—¥é–“ï¼‰                       â”‚                â”‚
â”‚  â”‚ æ¤œçŸ¥     â”‚    â”‚  â””â”€ çŒ¶äºˆæœŸé–“ä¸­: æ©Ÿèƒ½åˆ¶é™é€šçŸ¥           â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â””â”€ çŒ¶äºˆæœŸé–“å¾Œ: è‡ªå‹•ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰     â”‚                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                             â”‚
â”‚  ã€ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰å‡¦ç†ã€‘                                                      â”‚
â”‚  - PRO â†’ FREE: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åˆ¶é™é©ç”¨ã€ä¸€éƒ¨æ©Ÿèƒ½ç„¡åŠ¹åŒ–                           â”‚
â”‚  - MAX â†’ PRO: MAXã®ã¿ã®æ©Ÿèƒ½ç„¡åŠ¹åŒ–                                           â”‚
â”‚  - ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãªã—ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œï¼‰                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.1.3 ãƒãƒƒãƒå‡¦ç†è¨­è¨ˆ

```java
@Component
public class LicenseExpirationScheduler {
    
    @Scheduled(cron = "0 0 9 * * *") // æ¯æ—¥9:00
    public void processLicenseExpirations() {
        // 7æ—¥å‰é€šçŸ¥
        List<ApplicationLicense> expiringIn7Days = 
            licenseRepository.findExpiringBetween(now(), now().plusDays(7));
        expiringIn7Days.forEach(this::sendExpirationWarning);
        
        // 1æ—¥å‰é€šçŸ¥
        List<ApplicationLicense> expiringIn1Day = 
            licenseRepository.findExpiringBetween(now(), now().plusDays(1));
        expiringIn1Day.forEach(this::sendUrgentWarning);
        
        // çŒ¶äºˆæœŸé–“çµ‚äº†å¾Œã®ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰
        List<ApplicationLicense> expired = 
            licenseRepository.findExpiredBefore(now().minusDays(7));
        expired.forEach(this::processDowngrade);
    }
}
```

#### 3.1.4 APIè¨­è¨ˆ

```yaml
# ãƒ©ã‚¤ã‚»ãƒ³ã‚¹çŠ¶æ…‹å–å¾—
GET /licenses/status
Headers:
  Authorization: Bearer <token>
Response:
  200:
    licenses:
      - applicationId: "promarker"
        tier: "PRO"
        expiresAt: "2025-12-31T23:59:59Z"
        daysRemaining: 33
        status: "ACTIVE" | "EXPIRING_SOON" | "GRACE_PERIOD" | "EXPIRED"

# ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ›´æ–°ï¼ˆèª²é‡‘é€£æºå¾Œã«ä½¿ç”¨ï¼‰
POST /licenses/renew
Request:
  applicationId: string
  tier: string
  months: number (1, 6, 12)
Response:
  200:
    license: {...}
    newExpiresAt: "2026-12-31T23:59:59Z"
```

---

### 3.2 ä½¿ç”¨é‡åˆ¶é™ (Quota)

#### 3.2.1 è¨­è¨ˆæ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ãƒ†ã‚£ã‚¢åˆ¥ä½¿ç”¨é‡åˆ¶é™                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    ProMarker ä½¿ç”¨é‡åˆ¶é™                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ ãƒªã‚½ãƒ¼ã‚¹   â”‚ FREE     â”‚ TRIAL    â”‚ PRO      â”‚ MAX              â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚
â”‚  â”‚  â”‚ ç”Ÿæˆå›æ•°/æœˆâ”‚ 100      â”‚ 500      â”‚ 5,000    â”‚ ç„¡åˆ¶é™           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ â”‚ 100MB    â”‚ 1GB      â”‚ 10GB     â”‚ 100GB            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ã‚¹ãƒ†ãƒ³ã‚·ãƒ«æ•°â”‚ 5        â”‚ 20       â”‚ 100      â”‚ ç„¡åˆ¶é™           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ API Rate   â”‚ 10/min   â”‚ 30/min   â”‚ 100/min  â”‚ 1000/min         â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2.2 ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

```java
@Entity
@Table(name = "mir_usage_quota")
public class UsageQuota {
    @Id
    private UUID id;
    
    @Column(name = "subject_type", nullable = false)
    @Enumerated(EnumType.STRING)
    private SubjectType subjectType; // USER or TENANT
    
    @Column(name = "subject_id", nullable = false)
    private String subjectId;
    
    @Column(name = "application_id", nullable = false)
    private String applicationId;
    
    @Column(name = "quota_type", nullable = false)
    private String quotaType; // GENERATION_COUNT, STORAGE_BYTES, STENCIL_COUNT
    
    @Column(name = "period_start", nullable = false)
    private Instant periodStart;
    
    @Column(name = "period_end", nullable = false)
    private Instant periodEnd;
    
    @Column(name = "quota_limit", nullable = false)
    private Long quotaLimit;
    
    @Column(name = "current_usage", nullable = false)
    private Long currentUsage = 0L;
}
```

#### 3.2.3 APIè¨­è¨ˆ

```yaml
# ä½¿ç”¨é‡çŠ¶æ³å–å¾—
GET /usage/status
Headers:
  Authorization: Bearer <token>
Query:
  applicationId: string (optional)
Response:
  200:
    usage:
      - quotaType: "GENERATION_COUNT"
        current: 45
        limit: 100
        percentUsed: 45
        resetAt: "2025-12-01T00:00:00Z"
      - quotaType: "STORAGE_BYTES"
        current: 52428800  # 50MB
        limit: 104857600   # 100MB
        percentUsed: 50
        resetAt: null  # ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯ç´¯ç©

# ä½¿ç”¨é‡è¨˜éŒ²ï¼ˆå†…éƒ¨APIï¼‰
POST /internal/usage/record
Request:
  subjectId: string
  applicationId: string
  quotaType: string
  amount: number
Response:
  200: { recorded: true }
  429: { error: "ä½¿ç”¨é‡åˆ¶é™ã‚’è¶…éã—ã¾ã—ãŸ" }
```

#### 3.2.4 å®Ÿè£…ã‚¿ã‚¹ã‚¯

```
â–¡ UsageQuota Entity/Repository ä½œæˆ

â–¡ QuotaService.java å®Ÿè£…
  - checkQuota(subjectId, quotaType): åˆ¶é™ãƒã‚§ãƒƒã‚¯
  - recordUsage(subjectId, quotaType, amount): ä½¿ç”¨é‡è¨˜éŒ²
  - getUsageStatus(subjectId): ç¾åœ¨ã®ä½¿ç”¨çŠ¶æ³
  - resetMonthlyQuotas(): æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆï¼ˆãƒãƒƒãƒï¼‰

â–¡ @RequireQuota ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ + AOP
  - ãƒ¡ã‚½ãƒƒãƒ‰ãƒ¬ãƒ™ãƒ«ã§ã‚¯ã‚©ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
  - è¶…éæ™‚ã¯ QuotaExceededException

â–¡ ProMarker APIçµ±åˆ
  - /apps/mste/api/generate ã«ä½¿ç”¨é‡è¨˜éŒ²è¿½åŠ 
```

---

### 3.3 èª²é‡‘ã‚·ã‚¹ãƒ†ãƒ é€£æºæº–å‚™ (Stripe)

#### 3.3.1 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Stripeé€£æºã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Frontend â”‚â”€â”€â”€â–¶â”‚ Checkout â”‚â”€â”€â”€â–¶â”‚ Stripe   â”‚â”€â”€â”€â–¶â”‚ Webhook  â”‚             â”‚
â”‚  â”‚ è³¼å…¥ãƒœã‚¿ãƒ³â”‚    â”‚ Session  â”‚    â”‚ æ±ºæ¸ˆ     â”‚    â”‚ å—ä¿¡     â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                       â”‚                     â”‚
â”‚                                                       â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Webhookå‡¦ç†                                       â”‚  â”‚
â”‚  â”‚  checkout.session.completed â†’ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä»˜ä¸                          â”‚  â”‚
â”‚  â”‚  customer.subscription.updated â†’ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ›´æ–°                       â”‚  â”‚
â”‚  â”‚  customer.subscription.deleted â†’ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å¤±åŠ¹                       â”‚  â”‚
â”‚  â”‚  invoice.payment_succeeded â†’ è«‹æ±‚å±¥æ­´è¨˜éŒ²                             â”‚  â”‚
â”‚  â”‚  invoice.payment_failed â†’ æ”¯æ‰•ã„å¤±æ•—é€šçŸ¥                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  ã€ãƒ‡ãƒ¼ã‚¿é€£æºã€‘                                                             â”‚
â”‚  - User.stripeCustomerId: Stripeã‚«ã‚¹ã‚¿ãƒãƒ¼ç´ä»˜ã‘                           â”‚
â”‚  - Tenant.stripeSubscriptionId: ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç´ä»˜ã‘                   â”‚
â”‚  - ApplicationLicense.stripeProductId: Stripeå•†å“ç´ä»˜ã‘                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3.2 ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«æ‹¡å¼µ

```java
// Useræ‹¡å¼µ
@Column(name = "stripe_customer_id")
private String stripeCustomerId;

// Tenantæ‹¡å¼µ
@Column(name = "stripe_subscription_id")
private String stripeSubscriptionId;

// æ–°è¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
@Entity
@Table(name = "mir_payment_history")
public class PaymentHistory {
    @Id
    private UUID id;
    
    @Column(name = "subject_type", nullable = false)
    @Enumerated(EnumType.STRING)
    private SubjectType subjectType;
    
    @Column(name = "subject_id", nullable = false)
    private String subjectId;
    
    @Column(name = "stripe_payment_intent_id")
    private String stripePaymentIntentId;
    
    @Column(name = "stripe_invoice_id")
    private String stripeInvoiceId;
    
    @Column(name = "amount", nullable = false)
    private BigDecimal amount;
    
    @Column(name = "currency", nullable = false)
    private String currency; // JPY, USD
    
    @Column(name = "status", nullable = false)
    @Enumerated(EnumType.STRING)
    private PaymentStatus status; // PENDING, SUCCEEDED, FAILED, REFUNDED
    
    @Column(name = "paid_at")
    private Instant paidAt;
    
    @CreationTimestamp
    private Instant createdAt;
}
```

#### 3.3.3 APIè¨­è¨ˆ

```yaml
# ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
POST /billing/checkout
Headers:
  Authorization: Bearer <token>
Request:
  tier: "PRO" | "MAX"
  billingCycle: "MONTHLY" | "YEARLY"
  successUrl: string
  cancelUrl: string
Response:
  200:
    checkoutUrl: "https://checkout.stripe.com/..."
    sessionId: "cs_xxx"

# ãƒãƒ¼ã‚¿ãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰
POST /billing/portal
Response:
  200:
    portalUrl: "https://billing.stripe.com/..."

# Webhookå—ä¿¡
POST /billing/webhook
Headers:
  Stripe-Signature: <signature>
Body: Stripe Event JSON
Response:
  200: { received: true }

# æ”¯æ‰•ã„å±¥æ­´å–å¾—
GET /billing/history
Response:
  200:
    payments:
      - id: "pay-123"
        amount: 2980
        currency: "JPY"
        status: "SUCCEEDED"
        paidAt: "2025-11-01T10:00:00Z"
        invoiceUrl: "https://..."
```

#### 3.3.4 Stripeå•†å“æ§‹æˆ

```yaml
# Stripe Products
products:
  - id: prod_promarker_pro
    name: "ProMarker Pro"
    prices:
      - id: price_pro_monthly
        unit_amount: 2980
        currency: JPY
        recurring:
          interval: month
      - id: price_pro_yearly
        unit_amount: 29800
        currency: JPY
        recurring:
          interval: year
  
  - id: prod_promarker_max
    name: "ProMarker Max"
    prices:
      - id: price_max_monthly
        unit_amount: 9800
        currency: JPY
        recurring:
          interval: month
      - id: price_max_yearly
        unit_amount: 98000
        currency: JPY
        recurring:
          interval: year
```

---

### 3.4 ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

#### 3.4.1 ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ•ãƒ­ãƒ¼                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ (FREE â†’ PRO â†’ MAX)ã€‘                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ãƒ—ãƒ©ãƒ³   â”‚â”€â”€â”€â–¶â”‚ Checkout â”‚â”€â”€â”€â–¶â”‚ æ”¯æ‰•ã„   â”‚â”€â”€â”€â–¶â”‚ å³æ™‚     â”‚             â”‚
â”‚  â”‚ é¸æŠ     â”‚    â”‚ ã‚»ãƒƒã‚·ãƒ§ãƒ³â”‚    â”‚ å®Œäº†     â”‚    â”‚ æœ‰åŠ¹åŒ–   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                             â”‚
â”‚  ã€ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ (MAX â†’ PRO â†’ FREE)ã€‘                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ãƒ—ãƒ©ãƒ³   â”‚â”€â”€â”€â–¶â”‚ ç¢ºèª     â”‚â”€â”€â”€â–¶â”‚ ç¾æœŸé–“   â”‚â”€â”€â”€â–¶â”‚ æ¬¡å›æ›´æ–° â”‚             â”‚
â”‚  â”‚ é¸æŠ     â”‚    â”‚ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°â”‚    â”‚ çµ‚äº†ã¾ã§ â”‚    â”‚ æ™‚é©ç”¨   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                             â”‚
â”‚  ã€æ—¥å‰²ã‚Šè¨ˆç®—ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ™‚ï¼‰ã€‘                                          â”‚
â”‚  - ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã®æ®‹æ—¥æ•°ã‚’æ–°ãƒ—ãƒ©ãƒ³ã®æ—¥å‰²ã‚Šé¡ã‹ã‚‰å·®ã—å¼•ã                      â”‚
â”‚  - Stripeã® proration_behavior: 'create_prorations' ã‚’ä½¿ç”¨                  â”‚
â”‚                                                                             â”‚
â”‚  ã€ãƒ‡ãƒ¼ã‚¿ç§»è¡Œè€ƒæ…®ã€‘                                                          â”‚
â”‚  - ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰: å³åº§ã«æ–°æ©Ÿèƒ½åˆ©ç”¨å¯èƒ½                                      â”‚
â”‚  - ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰: åˆ¶é™è¶…éãƒ‡ãƒ¼ã‚¿ã¯èª­ã¿å–ã‚Šå°‚ç”¨                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.4.2 APIè¨­è¨ˆ

```yaml
# ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³å–å¾—
GET /billing/plan
Response:
  200:
    currentTier: "PRO"
    billingCycle: "MONTHLY"
    nextBillingDate: "2025-12-28T00:00:00Z"
    amount: 2980
    cancelAtPeriodEnd: false

# ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
POST /billing/plan/preview
Request:
  newTier: "MAX"
  billingCycle: "MONTHLY"
Response:
  200:
    currentTier: "PRO"
    newTier: "MAX"
    effectiveDate: "2025-11-28T00:00:00Z"  # ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯å³æ™‚
    proratedAmount: 6820  # æ—¥å‰²ã‚Šå·®é¡
    nextBillingAmount: 9800

# ãƒ—ãƒ©ãƒ³å¤‰æ›´å®Ÿè¡Œ
POST /billing/plan/change
Request:
  newTier: "MAX"
  billingCycle: "MONTHLY"
Response:
  200:
    success: true
    newLicense: {...}

# ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«
POST /billing/cancel
Request:
  reason: string (optional)
  feedback: string (optional)
Response:
  200:
    canceledAt: "2025-11-28T10:00:00Z"
    effectiveDate: "2025-12-28T00:00:00Z"  # æœŸé–“çµ‚äº†æ™‚
```

---

### 3.5 Admin ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç®¡ç†

#### 3.5.1 ç”»é¢è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Admin ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç®¡ç†ç”»é¢                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ã€/admin/licenses ä¸€è¦§ç”»é¢ã€‘                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ãƒ•ã‚£ãƒ«ã‚¿: [ã‚¢ãƒ—ãƒªâ–¼] [ãƒ†ã‚£ã‚¢â–¼] [çŠ¶æ…‹â–¼] [ã‚¿ã‚¤ãƒ—â–¼]                       â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚ â”‚ ID     â”‚ å¯¾è±¡         â”‚ ã‚¿ã‚¤ãƒ— â”‚ ãƒ†ã‚£ã‚¢   â”‚ æœ‰åŠ¹æœŸé™ â”‚ æ“ä½œ   â”‚    â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚  â”‚
â”‚  â”‚ â”‚ lic-1  â”‚ user@ex.com  â”‚ USER   â”‚ PRO      â”‚ 2025/12  â”‚ [...]  â”‚    â”‚  â”‚
â”‚  â”‚ â”‚ lic-2  â”‚ Team Alpha   â”‚ TENANT â”‚ MAX      â”‚ 2026/03  â”‚ [...]  â”‚    â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚ [+ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä»˜ä¸]                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  ã€ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä»˜ä¸ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã€‘                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ã‚¿ã‚¤ãƒ—: â—‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼  â— ãƒ†ãƒŠãƒ³ãƒˆ                                       â”‚  â”‚
â”‚  â”‚ å¯¾è±¡: [Team Alpha (tenant-abc123)    â–¼]                              â”‚  â”‚
â”‚  â”‚ ã‚¢ãƒ—ãƒª: [ProMarker                   â–¼]                              â”‚  â”‚
â”‚  â”‚ ãƒ†ã‚£ã‚¢: â—‹ FREE  â—‹ TRIAL  â— PRO  â—‹ MAX                               â”‚  â”‚
â”‚  â”‚ æœ‰åŠ¹æœŸé™: [2026-03-31]                                                â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚ [ã‚­ãƒ£ãƒ³ã‚»ãƒ«] [ä»˜ä¸]                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.5.2 Admin APIè¨­è¨ˆ

```yaml
# ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä¸€è¦§ï¼ˆç®¡ç†è€…ï¼‰
GET /admin/licenses
Query:
  page: number
  size: number
  applicationId: string
  tier: string
  subjectType: "USER" | "TENANT"
  status: "ACTIVE" | "EXPIRED" | "ALL"
Response:
  200: LicenseListResponse

# ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä»˜ä¸ï¼ˆç®¡ç†è€…ï¼‰
POST /admin/licenses
Request:
  subjectType: "USER" | "TENANT"
  subjectId: string
  applicationId: string
  tier: "FREE" | "TRIAL" | "PRO" | "MAX"
  expiresAt: string (ISO 8601)
Response:
  201: ApplicationLicense

# ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ›´æ–°ï¼ˆç®¡ç†è€…ï¼‰
PUT /admin/licenses/{licenseId}
Request:
  tier: string
  expiresAt: string
Response:
  200: ApplicationLicense

# ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å¤±åŠ¹ï¼ˆç®¡ç†è€…ï¼‰
DELETE /admin/licenses/{licenseId}
Response:
  200: { revoked: true }
```

---

## 4. å®Ÿè£…ã‚¿ã‚¹ã‚¯ã¾ã¨ã‚

```
ã€Phase 1: æœ‰åŠ¹æœŸé™ç®¡ç† (Week 1-2)ã€‘
â–¡ LicenseExpirationScheduler å®Ÿè£…
â–¡ æœŸé™åˆ‡ã‚Œé€šçŸ¥ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â–¡ è‡ªå‹•ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰å‡¦ç†
â–¡ /licenses/status API

ã€Phase 2: ä½¿ç”¨é‡åˆ¶é™ (Week 3-4)ã€‘
â–¡ UsageQuota Entity/Repository
â–¡ QuotaService å®Ÿè£…
â–¡ @RequireQuota AOP
â–¡ ProMarker APIçµ±åˆ

ã€Phase 3: Stripeé€£æº (Week 5-8)ã€‘
â–¡ stripe-java SDKçµ±åˆ
â–¡ CheckoutSessionä½œæˆAPI
â–¡ Webhookå—ä¿¡ãƒ»å‡¦ç†
â–¡ PaymentHistory Entity
â–¡ ãƒ—ãƒ©ãƒ³å¤‰æ›´API

ã€Phase 4: Adminæ©Ÿèƒ½ (Week 9-10)ã€‘
â–¡ AdminLicenseController
â–¡ Admin ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç®¡ç†UI
â–¡ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä»˜ä¸/å¤±åŠ¹æ©Ÿèƒ½
```

---

## 5. å·¥æ•°è¦‹ç©ã‚‚ã‚Š

| æ©Ÿèƒ½ | è¦‹ç©ã‚‚ã‚Š | å‚™è€ƒ |
|------|----------|------|
| æœ‰åŠ¹æœŸé™ç®¡ç† | 4æ—¥ | ãƒãƒƒãƒ + é€šçŸ¥ |
| ä½¿ç”¨é‡åˆ¶é™ | 5æ—¥ | Entity + AOP + çµ±åˆ |
| Stripeé€£æº | 10æ—¥ | SDKçµ±åˆ + Webhook |
| ãƒ—ãƒ©ãƒ³å¤‰æ›´ | 4æ—¥ | æ—¥å‰²ã‚Šè¨ˆç®—å«ã‚€ |
| Admin UI | 3æ—¥ | ä¸€è¦§ + CRUD |
| **åˆè¨ˆ** | **26æ—¥** | |

---

## 6. ç’°å¢ƒå¤‰æ•°ãƒ»è¨­å®š

```yaml
# .env.example è¿½åŠ 
STRIPE_API_KEY=sk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
STRIPE_PRO_MONTHLY_PRICE_ID=price_xxx
STRIPE_PRO_YEARLY_PRICE_ID=price_xxx
STRIPE_MAX_MONTHLY_PRICE_ID=price_xxx
STRIPE_MAX_YEARLY_PRICE_ID=price_xxx

# application.yml
stripe:
  api-key: ${STRIPE_API_KEY:}
  webhook-secret: ${STRIPE_WEBHOOK_SECRET:}
  enabled: ${STRIPE_ENABLED:false}
```

---

**ä½œæˆæ—¥**: 2025å¹´11æœˆ28æ—¥  
**ä½œæˆè€…**: GitHub Copilot ğŸ¤–
