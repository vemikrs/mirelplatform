# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ æ©Ÿèƒ½è¨­è¨ˆæ›¸

## 1. æ¦‚è¦

SaaSãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«å¿…è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¯¾å¿œã€‚
APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€CSRFå¯¾ç­–ã€ç›£æŸ»ãƒ­ã‚°ã€GDPRå¯¾å¿œãªã©ã‚’ç¶²ç¾…çš„ã«å®Ÿè£…ã™ã‚‹ã€‚

---

## 2. æ©Ÿèƒ½ä¸€è¦§ã¨å®Ÿè£…çŠ¶æ³

| # | æ©Ÿèƒ½å | èª¬æ˜ | ç¾çŠ¶ | å„ªå…ˆåº¦ |
|---|--------|------|------|--------|
| 4.1 | APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ | å…¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®åˆ¶é™é©ç”¨ | âš ï¸ OTPã®ã¿ | P1 |
| 4.2 | CSRFå¯¾ç­– | ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªé˜²æ­¢ | âš ï¸ è¨­å®šä¾å­˜ | P1 |
| 4.3 | ç›£æŸ»ãƒ­ã‚°æ°¸ç¶šåŒ– | æ“ä½œå±¥æ­´ã®è‡ªå‹•è¨˜éŒ²ãƒ»æ¤œç´¢ãƒ»ãƒ¬ãƒãƒ¼ãƒˆ | âš ï¸ Entityæœ‰ | P1 |
| 4.4 | GDPRå¯¾å¿œ | ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»å‰Šé™¤è¦æ±‚ | âŒ æœª | P2 |
| 4.5 | SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­– | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã®ç¶²ç¾…çš„æ¤œè¨¼ | âš ï¸ åŸºæœ¬å¯¾å¿œ | P1 |
| 4.6 | ãƒ‡ãƒ¼ã‚¿æš—å·åŒ– | å€‹äººæƒ…å ±ã®AES-256æš—å·åŒ– | âŒ æœª | P3 |

---

## 3. æ©Ÿèƒ½è©³ç´°è¨­è¨ˆ

### 4.1 APIãƒ¬ãƒ¼ãƒˆåˆ¶é™

#### 4.1.1 ç¾çŠ¶åˆ†æ

```
ã€æ—¢å­˜å®Ÿè£…ã€‘
âœ… OTPç”¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™
   - RateLimitService (OTP Request: 3/min, OTP Verify: 5/min)
   - Rediså¯¾å¿œ + In-Memoryãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
   - RateLimitProperties è¨­å®šç®¡ç†

ã€æœªå®Ÿè£…ã€‘
âŒ èªè¨¼API (login, signup, refresh) ã¸ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
âŒ ä¸€èˆ¬API ã¸ã®ãƒ†ã‚£ã‚¢åˆ¥ãƒ¬ãƒ¼ãƒˆåˆ¶é™
âŒ IP/ãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä½ã®è¤‡åˆåˆ¶é™
âŒ ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…éæ™‚ã®ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥
```

#### 4.1.2 ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒãƒªã‚·ãƒ¼è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒãƒªã‚·ãƒ¼                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ã€èªè¨¼ç³»APIã€‘ï¼ˆåŒ¿åã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãŸã‚å³æ ¼ï¼‰                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ POST /auth/login          5å›/åˆ†/IP    è¶…éæ™‚: 429 + 60ç§’ãƒ–ãƒ­ãƒƒã‚¯     â”‚  â”‚
â”‚  â”‚ POST /auth/signup         3å›/åˆ†/IP    è¶…éæ™‚: 429 + 300ç§’ãƒ–ãƒ­ãƒƒã‚¯    â”‚  â”‚
â”‚  â”‚ POST /auth/refresh       10å›/åˆ†/User  è¶…éæ™‚: 429 + 60ç§’ãƒ–ãƒ­ãƒƒã‚¯     â”‚  â”‚
â”‚  â”‚ POST /auth/password-reset  3å›/åˆ†/IP    è¶…éæ™‚: 429 + 300ç§’ãƒ–ãƒ­ãƒƒã‚¯    â”‚  â”‚
â”‚  â”‚ POST /auth/otp/request     3å›/åˆ†/IP    (å®Ÿè£…æ¸ˆã¿)                    â”‚  â”‚
â”‚  â”‚ POST /auth/otp/verify      5å›/åˆ†/IP    (å®Ÿè£…æ¸ˆã¿)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  ã€ä¸€èˆ¬APIã€‘ï¼ˆèªè¨¼æ¸ˆã¿ã€ãƒ†ã‚£ã‚¢åˆ¥ï¼‰                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           â”‚  FREE    â”‚  TRIAL   â”‚   PRO    â”‚   MAX                   â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚  â”‚
â”‚  â”‚ API å…¨èˆ¬  â”‚  10/min  â”‚  30/min  â”‚ 100/min  â”‚ 1000/min                â”‚  â”‚
â”‚  â”‚ ç”ŸæˆAPI   â”‚   3/min  â”‚  10/min  â”‚  30/min  â”‚  100/min                â”‚  â”‚
â”‚  â”‚ Admin API â”‚   N/A    â”‚   N/A    â”‚  20/min  â”‚   60/min                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€‘                                                              â”‚
â”‚  - 429 Too Many Requests                                                    â”‚
â”‚  - X-RateLimit-Limit: 100                                                   â”‚
â”‚  - X-RateLimit-Remaining: 0                                                 â”‚
â”‚  - X-RateLimit-Reset: 1732780800 (Unix timestamp)                          â”‚
â”‚  - Retry-After: 60                                                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.1.3 å®Ÿè£…è¨­è¨ˆ

```java
// ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RateLimit {
    int limit() default 100;           // ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸Šé™
    int window() default 60;           // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆç§’ï¼‰
    String key() default "USER";       // "IP" | "USER" | "TENANT"
    boolean tierBased() default false; // ãƒ†ã‚£ã‚¢åˆ¥åˆ¶é™
}

// AOPå®Ÿè£…
@Aspect
@Component
public class RateLimitAspect {
    
    @Autowired
    private RateLimitService rateLimitService;
    
    @Autowired
    private ExecutionContext executionContext;
    
    @Around("@annotation(rateLimit)")
    public Object checkRateLimit(ProceedingJoinPoint pjp, RateLimit rateLimit) throws Throwable {
        String key = resolveKey(rateLimit.key());
        int limit = rateLimit.tierBased() 
            ? getLimitByTier(executionContext.getLicenseTier())
            : rateLimit.limit();
        
        RateLimitResult result = rateLimitService.checkLimit(key, limit, rateLimit.window());
        
        if (!result.isAllowed()) {
            throw new RateLimitExceededException(result);
        }
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šï¼ˆResponseEntityã§è¿”ã™å ´åˆï¼‰
        addRateLimitHeaders(result);
        
        return pjp.proceed();
    }
}

// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼é©ç”¨ä¾‹
@RestController
@RequestMapping("/auth")
public class AuthenticationController {
    
    @PostMapping("/login")
    @RateLimit(limit = 5, window = 60, key = "IP")
    public ResponseEntity<AuthResponse> login(@RequestBody LoginRequest request) {
        // ...
    }
}
```

#### 4.1.4 å®Ÿè£…ã‚¿ã‚¹ã‚¯

```
â–¡ RateLimitService æ‹¡å¼µ
  - æ±ç”¨çš„ãªãƒã‚§ãƒƒã‚¯é–¢æ•°
  - ãƒ†ã‚£ã‚¢åˆ¥åˆ¶é™å¯¾å¿œ

â–¡ @RateLimit ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ + AOP å®Ÿè£…

â–¡ RateLimitExceededException + ExceptionHandler
  - 429ãƒ¬ã‚¹ãƒãƒ³ã‚¹ + ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š

â–¡ å…¨èªè¨¼APIã¸ã®é©ç”¨
  - /auth/login, /auth/signup, /auth/refresh, /auth/password-reset

â–¡ ä¸€èˆ¬APIã¸ã®é©ç”¨
  - @RateLimit(tierBased = true) ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«è¿½åŠ 

â–¡ ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…éã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  - åŒä¸€IPã‹ã‚‰ã®å¤§é‡ã‚¢ã‚¯ã‚»ã‚¹æ¤œçŸ¥
  - Slack/ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
```

---

### 4.2 CSRFå¯¾ç­–

#### 4.2.1 ç¾çŠ¶åˆ†æ

```
ã€æ—¢å­˜å®Ÿè£…ã€‘
âœ… WebSecurityConfig
   - CookieCsrfTokenRepositoryï¼ˆHttpOnly=false ã§JSèª­ã¿å–ã‚Šå¯èƒ½ï¼‰
   - csrfEnabled è¨­å®šãƒ•ãƒ©ã‚°
âœ… Mipla2SecurityProperties
   - csrfEnabled: true (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
âœ… application-dev.yml
   - csrf-enabled: false (é–‹ç™ºæ™‚ç„¡åŠ¹)

ã€èª²é¡Œã€‘
âŒ æœ¬ç•ªè¨­å®šã®ç¢ºèªãƒ»ãƒ†ã‚¹ãƒˆãŒæœªå®Ÿæ–½
âŒ SPAå‘ã‘CSRFãƒˆãƒ¼ã‚¯ãƒ³é€£æºï¼ˆAxios Interceptorç­‰ï¼‰
âŒ CSRFé™¤å¤–ãƒ‘ã‚¹ï¼ˆWebhookç­‰ï¼‰ã®æ˜ç¤ºçš„è¨­å®š
```

#### 4.2.2 SPAå‘ã‘CSRFå®Ÿè£…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SPA CSRF ãƒ•ãƒ­ãƒ¼                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ã€åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã€‘                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SPAèµ·å‹•  â”‚â”€â”€â”€â–¶â”‚ GET /api â”‚â”€â”€â”€â–¶â”‚ Set-Cookie: XSRF-TOKEN=abc...       â”‚  â”‚
â”‚  â”‚          â”‚    â”‚ (ä»»æ„)   â”‚    â”‚ (HttpOnly=false, SameSite=Strict)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  ã€POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã€‘                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Axios    â”‚â”€â”€â”€â–¶â”‚ Cookie: XSRF-TOKEN=abc...          â”‚                    â”‚
â”‚  â”‚ Interceptâ”‚    â”‚ X-XSRF-TOKEN: abc... (ãƒ˜ãƒƒãƒ€ãƒ¼)    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                             â”‚
â”‚  ã€é™¤å¤–ãƒ‘ã‚¹ã€‘                                                                â”‚
â”‚  - /auth/login, /auth/signupï¼ˆèªè¨¼å‰ã€CSRFä¸è¦ï¼‰                            â”‚
â”‚  - /billing/webhookï¼ˆStripeã‹ã‚‰ã®å‘¼ã³å‡ºã—ã€ç½²åæ¤œè¨¼ã§ä»£æ›¿ï¼‰                 â”‚
â”‚  - /actuator/**ï¼ˆå†…éƒ¨ç›£è¦–ç”¨ï¼‰                                               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¯¾å¿œ

```typescript
// apps/frontend-v3/src/lib/api/client.ts
import axios from 'axios';

const apiClient = axios.create({
  baseURL: '/mapi',
  withCredentials: true, // Cookieé€ä¿¡æœ‰åŠ¹åŒ–
});

// CSRFãƒˆãƒ¼ã‚¯ãƒ³è‡ªå‹•ä»˜ä¸
apiClient.interceptors.request.use((config) => {
  const csrfToken = getCookie('XSRF-TOKEN');
  if (csrfToken && config.method !== 'get') {
    config.headers['X-XSRF-TOKEN'] = csrfToken;
  }
  return config;
});

function getCookie(name: string): string | undefined {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) {
    return parts.pop()?.split(';').shift();
  }
  return undefined;
}
```

#### 4.2.4 å®Ÿè£…ã‚¿ã‚¹ã‚¯

```
â–¡ WebSecurityConfig æ›´æ–°
  - é™¤å¤–ãƒ‘ã‚¹ã®æ˜ç¤ºçš„è¨­å®š
  - SameSite=Strict è¨­å®š

â–¡ Frontend Axios Interceptor å®Ÿè£…
  - XSRF-TOKENã®è‡ªå‹•èª­ã¿å–ã‚Šãƒ»é€ä¿¡

â–¡ æœ¬ç•ªç’°å¢ƒãƒ†ã‚¹ãƒˆ
  - CSRFæœ‰åŠ¹æ™‚ã®å…¨POSTã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¢ºèª

â–¡ E2Eãƒ†ã‚¹ãƒˆ
  - CSRFç„¡åŠ¹ã§ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ403ã«ãªã‚‹ã“ã¨
```

---

### 4.3 ç›£æŸ»ãƒ­ã‚°æ°¸ç¶šåŒ–

#### 4.3.1 ç¾çŠ¶åˆ†æ

```
ã€æ—¢å­˜å®Ÿè£…ã€‘
âœ… AuditLog Entity
   - id, userId, tenantId, eventType, resourceType, resourceId
   - metadata (JSON), ipAddress, userAgent, createdAt
âœ… AuditLogRepository
   - findByUserId, findByTenantId, findByEventTypeAndDateRange

ã€æœªå®Ÿè£…ã€‘
âŒ è‡ªå‹•è¨˜éŒ²AOP (@Audited ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³)
âŒ ç›£æŸ»ãƒ­ã‚°æ¤œç´¢ãƒ»ãƒ¬ãƒãƒ¼ãƒˆUI
âŒ é•·æœŸä¿å­˜ãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æˆ¦ç•¥
âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆç‰¹åˆ¥å‡¦ç†ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ç­‰ï¼‰
```

#### 4.3.2 ç›£æŸ»å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç›£æŸ»å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ã€èªè¨¼ç³»ã€‘                                                                  â”‚
â”‚  AUTH_LOGIN_SUCCESS        ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ                                     â”‚
â”‚  AUTH_LOGIN_FAILED         ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼ˆè©³ç´°ç†ç”±ä»˜ãï¼‰                      â”‚
â”‚  AUTH_LOGOUT               ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ                                       â”‚
â”‚  AUTH_PASSWORD_RESET       ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ                                â”‚
â”‚  AUTH_2FA_ENABLED          2FAæœ‰åŠ¹åŒ–                                        â”‚
â”‚  AUTH_2FA_DISABLED         2FAç„¡åŠ¹åŒ–                                        â”‚
â”‚                                                                             â”‚
â”‚  ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã€‘                                                            â”‚
â”‚  USER_CREATED              ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ                                     â”‚
â”‚  USER_UPDATED              ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°                                 â”‚
â”‚  USER_DELETED              ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤                                     â”‚
â”‚  USER_ROLE_CHANGED         ãƒ­ãƒ¼ãƒ«å¤‰æ›´                                       â”‚
â”‚                                                                             â”‚
â”‚  ã€ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†ã€‘                                                            â”‚
â”‚  TENANT_CREATED            ãƒ†ãƒŠãƒ³ãƒˆä½œæˆ                                     â”‚
â”‚  TENANT_UPDATED            ãƒ†ãƒŠãƒ³ãƒˆæ›´æ–°                                     â”‚
â”‚  TENANT_DELETED            ãƒ†ãƒŠãƒ³ãƒˆå‰Šé™¤                                     â”‚
â”‚  TENANT_MEMBER_ADDED       ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ                                      â”‚
â”‚  TENANT_MEMBER_REMOVED     ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤                                     â”‚
â”‚  TENANT_OWNERSHIP_TRANSFERRED ã‚ªãƒ¼ãƒŠãƒ¼å§”è­²                                  â”‚
â”‚                                                                             â”‚
â”‚  ã€ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç®¡ç†ã€‘                                                          â”‚
â”‚  LICENSE_GRANTED           ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä»˜ä¸                                   â”‚
â”‚  LICENSE_UPGRADED          ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰                                   â”‚
â”‚  LICENSE_DOWNGRADED        ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰                                   â”‚
â”‚  LICENSE_REVOKED           ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å¤±åŠ¹                                   â”‚
â”‚                                                                             â”‚
â”‚  ã€ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆé«˜æ©Ÿå¯†ï¼‰ã€‘                                                â”‚
â”‚  DATA_EXPORTED             ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ                                â”‚
â”‚  DATA_DELETED              ãƒ‡ãƒ¼ã‚¿å‰Šé™¤                                       â”‚
â”‚  ADMIN_ACCESS              ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹                                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.3 AOPå®Ÿè£…è¨­è¨ˆ

```java
// ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface Audited {
    String eventType();
    String resourceType() default "";
    String resourceIdExpression() default ""; // SpELå¼
}

// AOP
@Aspect
@Component
public class AuditAspect {
    
    @Autowired
    private AuditLogRepository auditLogRepository;
    
    @Autowired
    private ExecutionContext executionContext;
    
    @AfterReturning(pointcut = "@annotation(audited)", returning = "result")
    public void recordAuditLog(JoinPoint jp, Audited audited, Object result) {
        AuditLog log = AuditLog.builder()
            .eventType(audited.eventType())
            .resourceType(audited.resourceType())
            .resourceId(resolveResourceId(jp, audited, result))
            .userId(executionContext.getCurrentUserId())
            .tenantId(executionContext.getCurrentTenantId())
            .ipAddress(executionContext.getIpAddress())
            .userAgent(executionContext.getUserAgent())
            .metadata(buildMetadata(jp, result))
            .build();
        
        auditLogRepository.save(log);
    }
    
    @AfterThrowing(pointcut = "@annotation(audited)", throwing = "ex")
    public void recordFailedAuditLog(JoinPoint jp, Audited audited, Exception ex) {
        // å¤±æ•—ãƒ­ã‚°ã‚‚è¨˜éŒ²
    }
}

// ä½¿ç”¨ä¾‹
@PostMapping("/login")
@Audited(eventType = "AUTH_LOGIN_SUCCESS", resourceType = "USER", resourceIdExpression = "#result.user.userId")
public AuthResponse login(@RequestBody LoginRequest request) {
    // ...
}
```

#### 4.3.4 Adminç›£æŸ»ãƒ­ã‚°ç”»é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Admin ç›£æŸ»ãƒ­ã‚°ç”»é¢                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ã€ãƒ•ã‚£ãƒ«ã‚¿ã€‘                                                                â”‚
â”‚  æœŸé–“: [2025-11-01] ã€œ [2025-11-28]                                         â”‚
â”‚  ã‚¤ãƒ™ãƒ³ãƒˆ: [ã™ã¹ã¦â–¼]  ãƒ¦ãƒ¼ã‚¶ãƒ¼: [___________]  ãƒ†ãƒŠãƒ³ãƒˆ: [ã™ã¹ã¦â–¼]          â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ æ—¥æ™‚                â”‚ ã‚¤ãƒ™ãƒ³ãƒˆ           â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼    â”‚ è©³ç´°     â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ 2025-11-28 10:30   â”‚ AUTH_LOGIN_SUCCESSâ”‚ john@ex.comâ”‚ [è¡¨ç¤º]   â”‚    â”‚
â”‚  â”‚ 2025-11-28 10:28   â”‚ AUTH_LOGIN_FAILED â”‚ (unknown)  â”‚ [è¡¨ç¤º]   â”‚    â”‚
â”‚  â”‚ 2025-11-28 10:15   â”‚ USER_UPDATED      â”‚ admin      â”‚ [è¡¨ç¤º]   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â”‚  [CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ] [è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ]                                            â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.5 å®Ÿè£…ã‚¿ã‚¹ã‚¯

```
â–¡ @Audited ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ + AOP å®Ÿè£…

â–¡ å…¨å¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰ã¸ã® @Audited ä»˜ä¸
  - AuthenticationController
  - AdminUserController
  - TenantController (æœªå®Ÿè£…å¾Œ)
  - LicenseController (æœªå®Ÿè£…å¾Œ)

â–¡ AuditLogService å®Ÿè£…
  - æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  - CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

â–¡ Admin ç›£æŸ»ãƒ­ã‚°ç”»é¢
  - /admin/audit-logs

â–¡ é•·æœŸä¿å­˜ãƒãƒªã‚·ãƒ¼è¨­å®š
  - 90æ—¥çµŒéå¾Œ â†’ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹•
  - 2å¹´çµŒéå¾Œ â†’ ç‰©ç†å‰Šé™¤ï¼ˆæ³•çš„è¦ä»¶ç¢ºèªï¼‰
```

---

### 4.4 GDPRå¯¾å¿œ

#### 4.4.1 å¿…è¦æ©Ÿèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        GDPRå¯¾å¿œæ©Ÿèƒ½                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ã€ãƒ‡ãƒ¼ã‚¿ä¸»ä½“ã®æ¨©åˆ©ã€‘                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. ã‚¢ã‚¯ã‚»ã‚¹æ¨© (Article 15)                                            â”‚  â”‚
â”‚  â”‚    - è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼ã‚’è¦æ±‚å¯èƒ½                                    â”‚  â”‚
â”‚  â”‚    â†’ GET /me/data-export                                              â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚ 2. å‰Šé™¤æ¨© (Article 17) - "å¿˜ã‚Œã‚‰ã‚Œã‚‹æ¨©åˆ©"                             â”‚  â”‚
â”‚  â”‚    - è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã‚’è¦æ±‚å¯èƒ½                                      â”‚  â”‚
â”‚  â”‚    â†’ POST /me/data-deletion-request                                   â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚ 3. è¨‚æ­£æ¨© (Article 16)                                                â”‚  â”‚
â”‚  â”‚    - ä¸æ­£ç¢ºãªãƒ‡ãƒ¼ã‚¿ã®è¨‚æ­£ã‚’è¦æ±‚å¯èƒ½                                    â”‚  â”‚
â”‚  â”‚    â†’ PUT /me/profile (æ—¢å­˜å®Ÿè£…ã§å¯¾å¿œ)                                 â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚ 4. ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£ (Article 20)                                   â”‚  â”‚
â”‚  â”‚    - æ©Ÿæ¢°å¯èª­å½¢å¼ã§ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ                                      â”‚  â”‚
â”‚  â”‚    â†’ GET /me/data-export?format=json                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  ã€ã‚µãƒ¼ãƒ“ã‚¹å´ç¾©å‹™ã€‘                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ - ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã®æ˜ç¤º                                           â”‚  â”‚
â”‚  â”‚ - ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®åŒæ„å–å¾—                                                 â”‚  â”‚
â”‚  â”‚ - ãƒ‡ãƒ¼ã‚¿ä¾µå®³æ™‚ã®72æ™‚é–“ä»¥å†…é€šçŸ¥                                         â”‚  â”‚
â”‚  â”‚ - å‡¦ç†è¨˜éŒ²ã®ä¿æŒ                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.4.2 APIè¨­è¨ˆ

```yaml
# ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¦æ±‚
POST /me/data-export
Headers:
  Authorization: Bearer <token>
Request:
  format: "JSON" | "CSV"  # ã‚ªãƒ—ã‚·ãƒ§ãƒ³
Response:
  202:
    requestId: "export-123"
    status: "PROCESSING"
    estimatedCompletionAt: "2025-11-28T11:00:00Z"
    message: "å‡¦ç†ãŒå®Œäº†ã—ãŸã‚‰ãƒ¡ãƒ¼ãƒ«ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™"

# ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆçŠ¶æ…‹ç¢ºèª
GET /me/data-export/{requestId}
Response:
  200:
    status: "COMPLETED"
    downloadUrl: "https://.../export-123.zip"  # ç½²åä»˜ãURLã€24æ™‚é–“æœ‰åŠ¹
    expiresAt: "2025-11-29T11:00:00Z"

# ãƒ‡ãƒ¼ã‚¿å‰Šé™¤è¦æ±‚
POST /me/data-deletion-request
Request:
  reason: string (optional)
  confirmPhrase: "DELETE MY DATA"  # ç¢ºèªç”¨
Response:
  202:
    requestId: "deletion-456"
    status: "PENDING_CONFIRMATION"
    confirmationDeadline: "2025-12-05T00:00:00Z"  # 7æ—¥ä»¥å†…ã«ç¢ºèª
    message: "ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ"

# å‰Šé™¤è¦æ±‚ç¢ºèªï¼ˆãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ã‹ã‚‰ï¼‰
POST /me/data-deletion-confirm/{token}
Response:
  200:
    status: "SCHEDULED"
    scheduledDeletionAt: "2025-12-28T00:00:00Z"  # 30æ—¥å¾Œ
    message: "30æ—¥å¾Œã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™"
```

#### 4.4.3 ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå†…å®¹

```json
{
  "exportedAt": "2025-11-28T10:00:00Z",
  "user": {
    "userId": "user-123",
    "email": "user@example.com",
    "displayName": "ãƒ¦ãƒ¼ã‚¶ãƒ¼å",
    "createdAt": "2025-01-01T00:00:00Z",
    "lastLoginAt": "2025-11-28T09:00:00Z"
  },
  "tenants": [
    {
      "tenantId": "tenant-abc",
      "tenantName": "My Workspace",
      "role": "OWNER",
      "joinedAt": "2025-01-01T00:00:00Z"
    }
  ],
  "licenses": [
    {
      "applicationId": "promarker",
      "tier": "PRO",
      "grantedAt": "2025-06-01T00:00:00Z",
      "expiresAt": "2025-12-31T23:59:59Z"
    }
  ],
  "activityLogs": [
    {
      "eventType": "AUTH_LOGIN_SUCCESS",
      "timestamp": "2025-11-28T09:00:00Z",
      "ipAddress": "xxx.xxx.xxx.xxx"
    }
  ],
  "applicationData": {
    "promarker": {
      "generatedFiles": 150,
      "stencils": [
        { "name": "my-stencil", "createdAt": "..." }
      ]
    }
  }
}
```

---

### 4.5 SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

#### 4.5.1 ç¾çŠ¶ç¢ºèªãƒã‚¤ãƒ³ãƒˆ

```
ã€JPA/Hibernateä½¿ç”¨æ™‚ã®å®‰å…¨æ€§ã€‘
âœ… @Query + ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚° (:param) ã¯å®‰å…¨
âœ… CriteriaBuilderä½¿ç”¨ã¯å®‰å…¨
âœ… Specificationä½¿ç”¨ã¯å®‰å…¨

ã€ãƒªã‚¹ã‚¯ãƒã‚¤ãƒ³ãƒˆã€‘
âš ï¸ ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¯ã‚¨ãƒª (@Query(nativeQuery = true))
âš ï¸ å‹•çš„ã‚¯ã‚¨ãƒªçµ„ã¿ç«‹ã¦ï¼ˆæ–‡å­—åˆ—é€£çµï¼‰
âš ï¸ EntityManager.createNativeQuery()
```

#### 4.5.2 ç¢ºèªãƒ»ãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯

```
â–¡ å…¨Repositoryã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¯ã‚¨ãƒªç¢ºèª
  - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ä½¿ç”¨ã‚’ç¢ºèª

â–¡ å‹•çš„ã‚¯ã‚¨ãƒªçµ„ã¿ç«‹ã¦ç®‡æ‰€ã®ç¢ºèª
  - Adminæ¤œç´¢æ©Ÿèƒ½ãªã©

â–¡ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
  - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è©¦è¡Œãƒ†ã‚¹ãƒˆ
  - SQLMapç­‰ã®ãƒ„ãƒ¼ãƒ«ã§ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒï¼‰
```

---

## 4. å®Ÿè£…ã‚¿ã‚¹ã‚¯ã¾ã¨ã‚

```
ã€Phase 1: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ (Week 1)ã€‘
â–¡ @RateLimit ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ + AOP
â–¡ èªè¨¼APIã¸ã®é©ç”¨
â–¡ ExceptionHandlerå®Ÿè£…

ã€Phase 2: CSRFå®Œå…¨åŒ– (Week 1)ã€‘
â–¡ é™¤å¤–ãƒ‘ã‚¹è¨­å®š
â–¡ Frontend Axios Interceptor
â–¡ E2Eãƒ†ã‚¹ãƒˆ

ã€Phase 3: ç›£æŸ»ãƒ­ã‚° (Week 2-3)ã€‘
â–¡ @Audited ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ + AOP
â–¡ å…¨å¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰ã¸ã®é©ç”¨
â–¡ Adminç›£æŸ»ãƒ­ã‚°ç”»é¢

ã€Phase 4: GDPRå¯¾å¿œ (Week 4-5)ã€‘
â–¡ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆAPI
â–¡ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤è¦æ±‚API
â–¡ ãƒãƒƒãƒå‡¦ç†ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆã€å‰Šé™¤å®Ÿè¡Œï¼‰

ã€Phase 5: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ (Week 6)ã€‘
â–¡ SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œè¨¼
â–¡ ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆï¼ˆç°¡æ˜“ï¼‰
â–¡ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
```

---

## 5. å·¥æ•°è¦‹ç©ã‚‚ã‚Š

| æ©Ÿèƒ½ | è¦‹ç©ã‚‚ã‚Š | å‚™è€ƒ |
|------|----------|------|
| APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ | 3æ—¥ | AOP + èªè¨¼APIé©ç”¨ |
| CSRFå®Œå…¨åŒ– | 1æ—¥ | è¨­å®š + ãƒ†ã‚¹ãƒˆ |
| ç›£æŸ»ãƒ­ã‚°æ°¸ç¶šåŒ– | 5æ—¥ | AOP + UI |
| GDPRå¯¾å¿œ | 6æ—¥ | ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ + å‰Šé™¤ |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ | 2æ—¥ | ãƒ†ã‚¹ãƒˆ + ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
| **åˆè¨ˆ** | **17æ—¥** | |

---

**ä½œæˆæ—¥**: 2025å¹´11æœˆ28æ—¥  
**ä½œæˆè€…**: GitHub Copilot ğŸ¤–
