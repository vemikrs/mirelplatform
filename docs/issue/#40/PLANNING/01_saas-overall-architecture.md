# SaaS化 全体鳥瞰図

## 1. 現状サマリー

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                       mirelplatform SaaS化 進捗状況                           │
├──────────────────────────────────────────────────────────────────────────────┤
│  Phase 1: データモデル                    ████████████████████  完了 (100%)   │
│  Phase 2: ExecutionContext               ████████████████████  完了 (100%)   │
│  Phase 3: バックエンドAPI                 ████████████░░░░░░░░  進行中 (60%)   │
│  Phase 4: フロントエンド                  ████████░░░░░░░░░░░░  進行中 (40%)   │
│  Phase 5: テスト・セキュリティ強化         ████░░░░░░░░░░░░░░░░  一部着手 (20%) │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. システムアーキテクチャ全体像

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    Internet                                          │
└───────────────────────────────────────┬─────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Load Balancer / CDN                                     │
│                             (nginx / CloudFront)                                     │
└───────────────────────────────────────┬─────────────────────────────────────────────┘
                                        │
              ┌─────────────────────────┼─────────────────────────┐
              │                         │                         │
              ▼                         ▼                         ▼
┌─────────────────────┐   ┌─────────────────────────┐   ┌─────────────────────┐
│   Frontend (Vite)   │   │   Backend (Spring Boot) │   │   Static Assets     │
│   React 19 + TS     │   │   Java 21 + Gradle 8    │   │   /public/*         │
│   :5173             │   │   :3000                 │   │                     │
└──────────┬──────────┘   └───────────┬─────────────┘   └─────────────────────┘
           │                          │
           │   /mapi/* Proxy          │
           └──────────────────────────┤
                                      │
              ┌───────────────────────┴───────────────────────┐
              │                                               │
              ▼                                               ▼
┌─────────────────────────────┐               ┌─────────────────────────────┐
│      Authentication         │               │      Application Layer       │
│  ┌─────────────────────┐   │               │  ┌─────────────────────┐    │
│  │ JwtAuthFilter       │   │               │  │ ProMarker           │    │
│  │ OtpController       │   │               │  │ (mste/api/*)        │    │
│  │ AuthController      │   │               │  └─────────────────────┘    │
│  └─────────────────────┘   │               │  ┌─────────────────────┐    │
│  ┌─────────────────────┐   │               │  │ Admin APIs          │    │
│  │ OAuth2 (GitHub)     │   │               │  │ (/admin/*)          │    │
│  │ OTP (Email)         │   │               │  └─────────────────────┘    │
│  └─────────────────────┘   │               │  ┌─────────────────────┐    │
└─────────────────────────────┘               │  │ Feature APIs        │    │
                                              │  │ (/features/*)       │    │
                                              │  └─────────────────────┘    │
                                              └─────────────────────────────┘
                                                          │
                                                          ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│                            ExecutionContext (Request Scope)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ CurrentUser  │  │CurrentTenant │  │  Licenses    │  │ Request Metadata     │  │
│  │ (User)       │  │ (Tenant)     │  │ (List<AL>)   │  │ (requestId, IP, etc) │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└───────────────────────────────────────────────────────────────────────────────────┘
                                                          │
                                                          ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│                               Data Layer (JPA/Hibernate)                          │
│  ┌──────────────────────────────────────────────────────────────────────────┐    │
│  │                       Core Entities (SaaS対応済み)                        │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────┐  │    │
│  │  │ SystemUser     │  │ User           │  │ Tenant                     │  │    │
│  │  │ (管理者)       │  │ (テナント配下)  │  │ (ワークスペース)            │  │    │
│  │  └────────────────┘  └────────────────┘  └────────────────────────────┘  │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────┐  │    │
│  │  │ UserTenant     │  │ ApplicationLicense│ │ RefreshToken             │  │    │
│  │  │ (ユーザー×テナント)│ │ (ライセンス)    │  │ (認証トークン)            │  │    │
│  │  └────────────────┘  └────────────────┘  └────────────────────────────┘  │    │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────┐  │    │
│  │  │ AuditLog       │  │ OtpToken       │  │ PasswordResetToken         │  │    │
│  │  │ (監査ログ)     │  │ (OTP認証)      │  │ (パスワードリセット)        │  │    │
│  │  └────────────────┘  └────────────────┘  └────────────────────────────┘  │    │
│  │  ┌────────────────┐  ┌────────────────┐                                  │    │
│  │  │ InvitationToken│  │FeatureFlag(予定)│                                  │    │
│  │  │ (テナント招待)  │  │ (機能フラグ)    │                                  │    │
│  │  └────────────────┘  └────────────────┘                                  │    │
│  └──────────────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────────────────────────────────────────────────────────┘
                                                          │
              ┌───────────────────────────────────────────┼──────────────────┐
              │                                           │                  │
              ▼                                           ▼                  ▼
┌─────────────────────┐               ┌──────────────────────┐  ┌────────────────┐
│  Database (H2/PG)   │               │  Redis (Cache/Rate)  │  │ Mail (SMTP)    │
│  - Entities         │               │  - OTP Rate Limit    │  │ - OTP送信      │
│  - Sessions         │               │  - Session Cache     │  │ - 招待メール   │
└─────────────────────┘               └──────────────────────┘  └────────────────┘
```

---

## 3. ユーザーモデル設計

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            User/Tenant 関連モデル                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌───────────────────┐                              ┌──────────────────────┐    │
│  │    SystemUser     │                              │       Tenant         │    │
│  │  (システム管理者)  │                              │   (ワークスペース)    │    │
│  ├───────────────────┤                              ├──────────────────────┤    │
│  │ id: UUID          │                              │ tenantId: String     │    │
│  │ email: String     │──────── 作成/管理 ──────────▶│ tenantName: String   │    │
│  │ passwordHash      │                              │ displayName: String  │    │
│  │ roles: ADMIN/USER │                              │ settings: JSON       │    │
│  │ isActive: Boolean │                              │ isActive: Boolean    │    │
│  └───────────────────┘                              └──────────┬───────────┘    │
│           │                                                     │               │
│           │ 認証後、テナント配下の                                │               │
│           │ User として活動可能                                   │               │
│           ▼                                                     ▼               │
│  ┌───────────────────┐        ┌──────────────────┐    ┌──────────────────┐     │
│  │       User        │◀───────│   UserTenant     │────▶│   (他Tenant)     │     │
│  │  (テナントユーザー) │        │   (所属関係)      │    └──────────────────┘     │
│  ├───────────────────┤        ├──────────────────┤                              │
│  │ userId: String    │        │ userId           │                              │
│  │ email: String     │        │ tenantId         │                              │
│  │ displayName       │        │ roleInTenant     │                              │
│  │ tenantId (default)│        │  (OWNER/MANAGER/ │                              │
│  │ roles             │        │   MEMBER/GUEST)  │                              │
│  │ isActive          │        │ isDefault        │                              │
│  └───────────────────┘        └──────────────────┘                              │
│           │                                                                      │
│           │ 1:N                                                                  │
│           ▼                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────┐     │
│  │                       ApplicationLicense                                │     │
│  │  ┌─────────────────────────┐    ┌─────────────────────────┐            │     │
│  │  │ subjectType: USER       │    │ subjectType: TENANT     │            │     │
│  │  │ subjectId: <userId>     │    │ subjectId: <tenantId>   │            │     │
│  │  │ applicationId: promarker│    │ applicationId: promarker│            │     │
│  │  │ tier: FREE/PRO/MAX      │    │ tier: FREE/PRO/MAX      │            │     │
│  │  │ expiresAt: Instant      │    │ expiresAt: Instant      │            │     │
│  │  └─────────────────────────┘    └─────────────────────────┘            │     │
│  └────────────────────────────────────────────────────────────────────────┘     │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 認証フロー

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              認証方式一覧                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  【実装済み】                                                                    │
│  ┌──────────────────────────────────────────────────────────────────────┐       │
│  │ 1. Email + Password + OTP                                            │       │
│  │    ┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────┐ │       │
│  │    │ ログイン   │───▶│ OTP送信    │───▶│ OTP検証    │───▶│ JWT発行│ │       │
│  │    │ (email/pw) │    │ (メール)   │    │ (6桁コード)│    │        │ │       │
│  │    └────────────┘    └────────────┘    └────────────┘    └────────┘ │       │
│  └──────────────────────────────────────────────────────────────────────┘       │
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────┐       │
│  │ 2. OAuth2 (GitHub)                                                    │       │
│  │    ┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────┐ │       │
│  │    │ GitHub     │───▶│ Callback   │───▶│ User作成   │───▶│ JWT発行│ │       │
│  │    │ 認可画面   │    │ 処理       │    │ or 紐付け  │    │        │ │       │
│  │    └────────────┘    └────────────┘    └────────────┘    └────────┘ │       │
│  └──────────────────────────────────────────────────────────────────────┘       │
│                                                                                  │
│  【実装済み（エンティティ/Repository）】                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐       │
│  │ 3. パスワードリセット                                                  │       │
│  │    ┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────┐ │       │
│  │    │ リセット   │───▶│ トークン   │───▶│ 新PW設定   │───▶│ 完了   │ │       │
│  │    │ 要求       │    │ メール送信 │    │ 画面       │    │        │ │       │
│  │    └────────────┘    └────────────┘    └────────────┘    └────────┘ │       │
│  └──────────────────────────────────────────────────────────────────────┘       │
│                                                                                  │
│  【未実装】                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐       │
│  │ 4. メール認証（Signup時）                                              │       │
│  │ 5. 2要素認証 (TOTP: Google Authenticator等)                           │       │
│  │ 6. SSO (SAML 2.0 / OIDC)                                              │       │
│  └──────────────────────────────────────────────────────────────────────┘       │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. API設計概要

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              API エンドポイント一覧                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  【認証系 - /auth/*】                                                           │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ ✅ POST /auth/login              - ログイン                              │   │
│  │ ✅ POST /auth/signup             - サインアップ                          │   │
│  │ ✅ POST /auth/refresh            - トークンリフレッシュ                   │   │
│  │ ✅ POST /auth/logout             - ログアウト                            │   │
│  │ ✅ POST /auth/switch-tenant      - テナント切替                          │   │
│  │ ✅ GET  /auth/me                 - 現在のユーザー情報                     │   │
│  │ ✅ POST /auth/otp/request        - OTP要求                               │   │
│  │ ✅ POST /auth/otp/verify         - OTP検証                               │   │
│  │ ⚠️ POST /auth/password-reset/request - パスワードリセット要求            │   │
│  │ ⚠️ POST /auth/password-reset     - パスワードリセット実行                 │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  【管理者系 - /admin/*】                                                        │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ ✅ GET  /admin/users             - ユーザー一覧                          │   │
│  │ ✅ GET  /admin/users/:id         - ユーザー詳細                          │   │
│  │ ✅ PUT  /admin/users/:id         - ユーザー更新                          │   │
│  │ ❌ DELETE /admin/users/:id       - ユーザー削除（未実装）                 │   │
│  │ ❌ GET  /admin/tenants           - テナント一覧（未実装）                 │   │
│  │ ❌ POST /admin/tenants           - テナント作成（未実装）                 │   │
│  │ ❌ GET  /admin/licenses          - ライセンス一覧（未実装）               │   │
│  │ ❌ POST /admin/licenses          - ライセンス付与（未実装）               │   │
│  │ ❌ GET  /admin/features          - フィーチャーフラグ一覧（計画中）       │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  【ユーザー系 - /features/*】                                                   │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ ❌ GET  /features/available      - 利用可能機能一覧（計画中）             │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  【アプリケーション - /apps/mste/*】                                            │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ ✅ POST /apps/mste/api/generate  - ProMarker コード生成                  │   │
│  │ ✅ @RequireLicense でライセンスチェック実装済み                           │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  凡例: ✅ 実装済み  ⚠️ 一部実装  ❌ 未実装                                      │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. フロントエンド構成

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Frontend ページ構成                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  【公開ページ】                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ ✅ /login                     - ログイン                                 │   │
│  │ ✅ /signup                    - サインアップ                             │   │
│  │ ✅ /auth/otp-verify           - OTP検証                                  │   │
│  │ ✅ /auth/password-reset       - パスワードリセット（OTP方式）             │   │
│  │ ⚠️ /password-reset            - パスワードリセット（トークン方式）        │   │
│  │ ✅ /oauth/callback            - OAuth2コールバック                       │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  【認証必須ページ】                                                             │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ ✅ /                          - ホーム（ダッシュボード）                  │   │
│  │ ✅ /promarker/*               - ProMarker機能                           │   │
│  │ ✅ /settings/profile          - プロフィール設定                         │   │
│  │ ✅ /settings/security         - セキュリティ設定                         │   │
│  │ ✅ /saas-status               - SaaS実装状況（開発用）                   │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  【管理者ページ（未実装）】                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ ❌ /admin/users               - ユーザー管理                             │   │
│  │ ❌ /admin/tenants             - テナント管理                             │   │
│  │ ❌ /admin/licenses            - ライセンス管理                           │   │
│  │ ❌ /admin/features            - フィーチャーフラグ管理                   │   │
│  │ ❌ /admin/audit-logs          - 監査ログ                                 │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  【状態管理 (Zustand)】                                                         │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ ✅ authStore                  - 認証状態、ユーザー情報、テナント         │   │
│  │    - user, currentTenant, tokens, isAuthenticated                        │   │
│  │    - login(), logout(), switchTenant(), signup()                         │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  凡例: ✅ 実装済み  ⚠️ 一部実装  ❌ 未実装                                      │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 依存関係マップ

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           外部サービス依存関係                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                        必須サービス (現在)                                 │  │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────┐  │  │
│  │  │ Database       │  │ SMTP Server    │  │ Redis (Optional)           │  │  │
│  │  │ H2 / PostgreSQL│  │ MailHog (dev)  │  │ Rate Limit, Session Cache  │  │  │
│  │  │                │  │ SendGrid (prod)│  │ Fallback: In-Memory        │  │  │
│  │  └────────────────┘  └────────────────┘  └────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                        計画中サービス (将来)                               │  │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────┐  │  │
│  │  │ Payment        │  │ Monitoring     │  │ Storage                    │  │  │
│  │  │ Stripe         │  │ Prometheus     │  │ S3 / Azure Blob            │  │  │
│  │  │ PayPal         │  │ Grafana        │  │                            │  │  │
│  │  └────────────────┘  └────────────────┘  └────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. セキュリティ設計

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            セキュリティ機構                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  【認証・認可】                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ ✅ JWT (Access Token)         - 15分有効、HS256署名                      │   │
│  │ ✅ Refresh Token              - 30日有効、SHA-256ハッシュ保存            │   │
│  │ ✅ OTP (Email)                - 5分有効、6桁、最大3回試行               │   │
│  │ ✅ BCrypt                     - パスワードハッシュ (strength: 12)        │   │
│  │ ✅ @PreAuthorize              - ロールベースアクセス制御                 │   │
│  │ ✅ @RequireLicense            - ライセンスベースアクセス制御             │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  【レート制限】                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ ✅ OTP Request                - 3回/分                                   │   │
│  │ ✅ OTP Verify                 - 5回/分                                   │   │
│  │ ❌ Login Attempts             - 未実装（5回/60秒 計画）                  │   │
│  │ ❌ API Rate Limit             - 未実装（ティア別制限 計画）              │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  【その他】                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │ ⚠️ CSRF Protection           - 設定可能（本番: enabled）                │   │
│  │ ✅ CORS                       - 設定可能                                 │   │
│  │ ✅ AuditLog Entity            - 定義済み（自動記録未実装）               │   │
│  │ ❌ データ暗号化               - 未実装                                   │   │
│  │ ❌ IP制限                     - 未実装                                   │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  凡例: ✅ 実装済み  ⚠️ 設定依存  ❌ 未実装                                      │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 実装優先度マトリクス

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                   緊急度 × 重要度 マトリクス                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│                    高重要度                           低重要度                   │
│                ──────────────────────────────────────────────────               │
│     高緊急度    │ 🔴 P1: MUST NOW                 │ 🟡 P2: SHOULD          │     │
│                │ - APIレート制限                  │ - 多言語対応            │     │
│                │ - ヘルスチェック強化             │ - ダークモード          │     │
│                │ - E2Eテスト整備                 │ - オンボーディング      │     │
│                │ - Admin UI (Users/Tenants)      │                         │     │
│                ├─────────────────────────────────┼─────────────────────────┤     │
│     低緊急度    │ 🟠 P3: COULD                    │ ⚪ P4: FUTURE           │     │
│                │ - 課金システム連携              │ - モバイルアプリ        │     │
│                │ - 2FA (TOTP)                    │ - GraphQL API          │     │
│                │ - GDPR対応                      │ - A/Bテスト            │     │
│                │ - SSO (SAML/OIDC)               │ - アフィリエイト       │     │
│                ──────────────────────────────────────────────────               │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

**作成日**: 2025年11月28日  
**作成者**: GitHub Copilot 🤖
