# MirelPlatform 初期セットアップガイド

MirelPlatformを新規環境にデプロイした際の初期セットアップ手順を説明します。

## 前提条件

- PostgreSQLデータベースが構築済み
- アプリケーションサーバーにアクセス可能
- ストレージディレクトリへの読み書き権限あり

## セットアップ手順

### 1. 初回起動

アプリケーションを初回起動すると、以下が自動実行されます：

1. **システムデータのシーディング**
   - メニュー定義 (`mir_menus`)
   - 機能フラグ (`mir_feature_flag`)
   - AIモデル定義 (`mir_mira_model_registry`)

2. **Bootstrapトークンの生成**
   - ストレージディレクトリにトークンファイルが生成されます
   - パス: `${MIREL_STORAGE_DIR}/bootstrap/setup-token.txt`

### 2. トークンの確認

サーバーにログインし、トークンファイルを確認します：

```bash
cat /path/to/storage/bootstrap/setup-token.txt
```

ファイル内容例：

```
========================================
MirelPlatform 初期セットアップトークン
========================================

以下のトークンを使用して初期管理者を作成してください。

トークン: a1b2c3d4-e5f6-7890-abcd-ef1234567890

セットアップ方法:
1. ブラウザで {base-url}/bootstrap にアクセス
2. または以下のAPIを呼び出し

※このファイルはセットアップ完了後に自動削除されます
========================================
```

### 3. 初期管理者の作成

#### 方法A: Web UIから作成（推奨）

1. ブラウザで `https://your-domain.com/bootstrap` にアクセス
2. トークンファイルからトークンをコピー
3. フォームに以下を入力：
   - トークン
   - ユーザー名
   - メールアドレス
   - パスワード（8文字以上）
   - 表示名（オプション）
4. 「初期管理者を作成」ボタンをクリック

#### 方法B: API経由で作成

```bash
curl -X POST https://your-domain.com/mipla2/api/bootstrap/admin \
  -H "Content-Type: application/json" \
  -d '{
    "token": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "username": "admin",
    "email": "admin@example.com",
    "password": "SecurePassword123!",
    "displayName": "System Administrator"
  }'
```

### 4. セットアップ完了の確認

- 成功するとトークンファイルが自動削除されます
- `/bootstrap` にアクセスすると「セットアップ完了済み」と表示されます
- 作成した管理者アカウントでログインできます

## データベース初期化モード

`mirel.database.initialize-mode` で制御：

| モード   | 説明                                               |
| -------- | -------------------------------------------------- |
| `ONCE`   | 初回起動時のみシーディング実行（デフォルト・推奨） |
| `ALWAYS` | 毎起動時にシーディング実行（開発環境向け）         |
| `NEVER`  | シーディングを一切実行しない                       |

## サンプルデータ

`mirel.database.seed-sample-data` で制御：

- `true`: デモ用のテナント・ユーザーを投入
- `false`: 投入しない（本番環境推奨）

## トラブルシューティング

### トークンファイルが生成されない

- ストレージディレクトリのパーミッションを確認
- `MIREL_STORAGE_DIR` 環境変数が正しく設定されているか確認

### Bootstrap完了後にトークンファイルが残っている

- 通常は自動削除されますが、残っている場合は手動で削除してください

### 既にBootstrap完了済みと表示される

- `mir_system_migration` テーブルの `BOOTSTRAP_V1` レコードを確認
- 必要に応じてレコードを削除して再実行

## セキュリティに関する注意

- トークンファイルはサーバーストレージにのみ保存されます
- ファイル権限は600（所有者のみ読み書き可）で設定されます
- トークンは一度使用されると無効になります
- 初期管理者は `ADMIN` ロールで作成されます
