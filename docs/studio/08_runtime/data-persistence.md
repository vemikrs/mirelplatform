# 44 Runtime データ永続化方式（JSONB/SQL）

Runtime のデータ永続化には  
**JSONB（柔軟性）**と**通常 SQL カラム（検索用）**を併用する方式を採用する。

---

# 1. 永続化の基本方針

- モデル変更に強い  
- スキーマレスだが検索可能  
- JSONB と SQL のハイブリッド  

---

# 2. テーブル構造

```
runtime_transaction
├── transaction_id (PK)
├── entity_id
├── data (JSONB)
├── updated_at
```

---

# 3. JSONB を採用する理由

- モデル変更に追随できる  
- Entity ごとに異なる構造を保持可能  
- ネスト構造に強い  

---

# 4. SQL カラム併用（将来）

頻出検索項目のみ SQL カラム化する案：

```
customer_id
order_date
status
```

同期方式：

```
保存時に JSONB → SQL カラムへ自動マッピング
```

---

# 5. インデックス戦略

- JSONB の特定フィールドに GIN インデックス  
- SQL カラムは B-tree  
- コード値は index 付与推奨  

---

# 6. データ移行（モデル変更）

- フィールド削除：JSONB そのまま保持  
- 型変更：保存時に自動変換（可能な範囲）  
- 埋め込みモデル構造変更：既存データは旧構造で保持  

Runtime は「保存時の構造」を尊重する。

---

# 7. 設計意図

- 柔軟性と性能の両立  
- モデル変更と運用継続性の確保  
