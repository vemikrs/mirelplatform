# ユースケース: Field 編集

## 1. 概要

既存の Entity/Domain のフィールドを編集するユースケース。

---

## 2. アクター

- **モデル設計者**: フィールドを編集するユーザー

---

## 3. 事前条件

- ユーザーがログイン済み
- 対象モデルが存在する
- Model Designer 画面にアクセス可能
- フィールド編集権限を持っている

---

## 4. 基本フロー

### Step 1: Designer 画面を開く

```
User Action: 
  - Explorer から対象モデルを選択
  - [編集] ボタンまたはダブルクリック

System Response:
  - Model Designer 画面へ遷移
  - モデル定義をロード
  - Domain Tree にフィールド一覧を表示
```

### Step 2: 編集対象フィールドを選択

```
User Action: Domain Tree でフィールドノードをクリック

System Response:
  - 選択ノードをハイライト表示
  - 右カラムに Property Panel を表示
  - 選択フィールドのプロパティを表示
```

**Property Panel 表示:**
```
┌─────────────────────────────────────────────────────────────┐
│ Node: customerId                                            │
│ Type: string (Primitive)                                    │
├──────────┬──────────┬──────────┬──────────┬────────────────┤
│ 基本 ★   │ 表示     │ 検証     │ 関連     │                │
├──────────┴──────────┴──────────┴──────────┴────────────────┤
│                                                             │
│ フィールドID                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ customerId                                              │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 表示名                                                      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 顧客ID                                                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ データ型                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ string                                              ▼  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ コードグループ                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ CustomerType                                        ▼  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ □ 必須  ☑ PK                                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Step 3: プロパティを編集

```
User Action: Property Panel でプロパティを変更
  - 表示名: "顧客ID" → "取引先ID" に変更
  - 必須: チェックを追加

System Response:
  - 変更を即座に反映（オートセーブはしない）
  - 変更追跡: change log に記録
  - Domain Tree のノード表示を更新
  - Draft バッジを表示: "1件の未保存変更"
```

### Step 4: 表示タブで UI 設定

```
User Action: [表示] タブをクリック

System Response:
  - 表示タブのプロパティを表示
```

**表示タブ内容:**
```
┌─────────────────────────────────────────────────────────────┐
│ UIコンポーネント                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ select                                              ▼  │ │
│ └─────────────────────────────────────────────────────────┘ │
│ 推奨: コードグループが設定されている場合は select           │
│                                                             │
│ プレースホルダ                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 取引先を選択してください                                │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ヘルプテキスト                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 登録済みの取引先から選択します                          │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 表示幅（グリッド）                                          │
│ ┌──────────┐                                                │
│ │ 6       ▼│  / 12                                         │
│ └──────────┘                                                │
│                                                             │
│ ☑ 一覧に表示                                                │
│                                                             │
│ 一覧表示幅                                                  │
│ ┌──────────┐                                                │
│ │ 150     ▼│ px                                            │
│ └──────────┘                                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Step 5: 検証タブでバリデーション設定

```
User Action: [検証] タブをクリック

System Response:
  - 検証タブのプロパティを表示
```

**検証タブ内容:**
```
┌─────────────────────────────────────────────────────────────┐
│ 必須                                                        │
│ ☑ このフィールドは入力必須です                               │
│                                                             │
│ ─── 文字列制約 ───                                          │
│                                                             │
│ 最小文字数                                                  │
│ ┌──────────┐                                                │
│ │ 1        │                                                │
│ └──────────┘                                                │
│                                                             │
│ 最大文字数                                                  │
│ ┌──────────┐                                                │
│ │ 20       │                                                │
│ └──────────┘                                                │
│                                                             │
│ 正規表現パターン                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ^[A-Z0-9]+$                                             │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ⓘ 入力値がこのパターンに一致する必要があります               │
│                                                             │
│ エラーメッセージ                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 英大文字と数字のみ使用できます                          │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Step 6: 関連タブでリレーション設定

```
User Action: [関連] タブをクリック

System Response:
  - 関連タブのプロパティを表示
```

**関連タブ内容:**
```
┌─────────────────────────────────────────────────────────────┐
│ 参照先エンティティ                                          │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Customer                                            ▼  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 参照キー                                                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ customerId                                          ▼  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ リレーション種別                                            │
│ (●) Many-to-One  ( ) One-to-Many                            │
│                                                             │
│ ─── 参照整合性 ───                                          │
│                                                             │
│ ON DELETE                                                   │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ RESTRICT                                            ▼  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ON UPDATE                                                   │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ CASCADE                                             ▼  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Step 7: 変更を保存

```
User Action: [保存] ボタンをクリック

System Response:
  1. バリデーション実行
  2. API 呼び出し: POST /mapi/apps/schema/api/saveDraft
  3. Draft として保存
  4. Toast 通知: "Draft を保存しました（3件の変更）"
  5. Draft バッジを更新
```

---

## 5. 代替フロー

### 5a. インライン編集

```
Step 2a:
  User Action: Domain Tree でフィールドノードをダブルクリック

  System Response:
    - フィールド名がインライン編集モードになる
    - テキスト入力可能

Step 2b:
  User Action: Enter キーまたはフォーカス外れ

  System Response:
    - フィールド名を更新
    - 変更を追跡
```

### 5b. ドラッグ&ドロップで順序変更

```
Step 2a:
  User Action: フィールドノードをドラッグ

  System Response:
    - ドラッグ中のノードを半透明表示
    - ドロップ可能位置にインジケーター表示

Step 2b:
  User Action: 目的の位置でドロップ

  System Response:
    - sort 値を更新
    - ツリーを再描画
    - 変更を追跡
```

### 5c. 右クリックメニューから編集

```
Step 2a:
  User Action: フィールドノードを右クリック

  System Response:
    - コンテキストメニュー表示
      - 編集
      - 複製
      - 削除
      - 上に移動
      - 下に移動

Step 2b:
  User Action: [編集] を選択

  System Response:
    - Property Panel を表示（Step 2 と同様）
```

---

## 6. 例外フロー

### 6a. バリデーションエラー

```
Step 7 でバリデーションエラーの場合:

System Response:
  - エラー箇所にマーカー表示
  - Property Panel で該当フィールドにエラー表示
  - Toast 警告: "入力内容にエラーがあります"
  - 保存は実行しない
```

### 6b. フィールドID 重複

```
Step 3 でフィールドID を変更した場合:

System Response:
  - リアルタイムで重複チェック
  - 重複がある場合: エラー表示
  - 保存時にも再チェック
```

### 6c. 循環参照検出

```
Step 6 でリレーション設定時:

System Response:
  - 循環参照をリアルタイムチェック
  - 検出時: エラー表示 "循環参照が検出されました: Order → Customer → Order"
```

---

## 7. 事後条件

- フィールド定義が Draft 状態で更新されている
- 変更履歴が記録されている
- Draft バッジが表示されている

---

## 8. シーケンス図

```
User            Designer         TreeNode        Panel            API
 │                │                │               │               │
 │ ノードクリック │                │               │               │
 ├───────────────►│                │               │               │
 │                │ selectNode()   │               │               │
 │                ├───────────────►│               │               │
 │                │                │ highlight     │               │
 │                │                ├──────────────►│               │
 │                │                │               │ showProps     │
 │                │                │               ├──────────────►│
 │                │                │               │               │
 │ プロパティ変更 │                │               │               │
 ├────────────────────────────────────────────────►│               │
 │                │                │               │ updateField   │
 │                │                ├───────────────┤               │
 │                │ trackChange    │               │               │
 │                │◄───────────────┤               │               │
 │                │                │               │               │
 │ [保存]         │                │               │               │
 ├───────────────►│                │               │               │
 │                │ validate()     │               │               │
 │                ├───────────────►│               │               │
 │                │                │               │               │
 │                │ saveDraft()    │               │               │
 │                ├───────────────────────────────────────────────►│
 │                │                │               │               │
 │                │ success        │               │               │
 │◄───────────────┤                │               │               │
```

---

## 9. キーボード操作

| キー | 動作 |
|-----|------|
| Tab | 次のプロパティフィールドへ移動 |
| Shift + Tab | 前のプロパティフィールドへ移動 |
| ↑ / ↓ | ツリー内でノード移動 |
| Enter | 選択ノードを編集モードに |
| Escape | 編集モード終了 |
| Ctrl + S | 保存 |
| Ctrl + Z | アンドゥ |
| Ctrl + Y | リドゥ |

---

## 10. 変更追跡データ

```typescript
// 変更ログの例
const change: Change = {
  id: "change-001",
  type: "modify",
  path: ["order", "customerId"],
  field: "fieldName",
  oldValue: "顧客ID",
  newValue: "取引先ID",
  timestamp: 1701504000000,
};

// 複数変更の場合
const changes: Change[] = [
  { id: "change-001", type: "modify", path: ["order", "customerId"], field: "fieldName", ... },
  { id: "change-002", type: "modify", path: ["order", "customerId"], field: "isRequired", ... },
  { id: "change-003", type: "modify", path: ["order", "customerId"], field: "placeholder", ... },
];
```

---

## 11. API 呼び出し

### リクエスト

```typescript
POST /mapi/apps/schema/api/saveDraft
Content-Type: application/json

{
  "content": {
    "modelId": "order",
    "fields": [
      {
        "fieldId": "customerId",
        "fieldName": "取引先ID",
        "dataType": "string",
        "isRequired": true,
        "widgetType": "select",
        "placeholder": "取引先を選択してください",
        "helpText": "登録済みの取引先から選択します",
        "displayWidth": 6,
        "isHeader": true,
        "headerWidth": 150,
        "validation": {
          "minLength": 1,
          "maxLength": 20,
          "regexPattern": "^[A-Z0-9]+$",
          "errorMessage": "英大文字と数字のみ使用できます"
        },
        "relationCodeGroup": "CustomerType",
        "relationEntityId": "customer",
        "relationFieldId": "customerId",
        "relationType": "many-to-one",
        "onDelete": "restrict",
        "onUpdate": "cascade",
        "status": "draft"
      }
    ]
  }
}
```

### レスポンス

```typescript
{
  "data": {
    "modelId": "order",
    "draftVersion": 2,
    "changeCount": 3
  },
  "messages": ["Draft を保存しました"],
  "errors": []
}
```

---

# 以上
