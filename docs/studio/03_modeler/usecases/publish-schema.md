# ユースケース: Schema 公開

## 1. 概要

Draft 状態のスキーマ変更を公開（Publish）し、Runtime へ反映するユースケース。

---

## 2. アクター

- **モデル設計者**: Draft を作成したユーザー
- **公開権限者**: Publish 権限を持つユーザー

---

## 3. 事前条件

- ユーザーがログイン済み
- 対象モデルに Draft 変更が存在する
- ユーザーが Publish 権限を持っている

---

## 4. 基本フロー（単一モデル公開）

### Step 1: Designer 画面で Draft を確認

```
User Action: Model Designer 画面を開く

System Response:
  - Draft 状態を表示
  - Header に Draft バッジ表示: "Draft: ● 4件の未公開変更"
```

**Header 表示:**
```
┌─────────────────────────────────────────────────────────────┐
│ ← Explorer │ Model: Order (Entity)                          │
│            │ Draft: ● 4件の未公開変更があります              │
│            │                   [変更破棄] [保存] [保存して公開] │
└─────────────────────────────────────────────────────────────┘
```

### Step 2: 変更内容を確認

```
User Action: Draft バッジをクリック（または変更履歴パネルを開く）

System Response:
  - 変更履歴パネルを表示
  - 変更内容の詳細を一覧表示
```

**変更履歴パネル:**
```
┌─────────────────────────────────────────────────────────────┐
│ 変更履歴 (Draft)                                     [×]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 4件の未公開変更                                             │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ● 追加  │ フィールド「orderDate」                       │ │
│ │         │ 2025-12-02 10:30  by admin                   │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ◐ 変更  │ フィールド「customerId」の表示名             │ │
│ │         │ "顧客ID" → "取引先ID"                        │ │
│ │         │ 2025-12-02 10:25  by admin                   │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ◐ 変更  │ フィールド「customerId」の必須設定           │ │
│ │         │ false → true                                 │ │
│ │         │ 2025-12-02 10:25  by admin                   │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ × 削除  │ フィールド「oldField」                        │ │
│ │         │ 2025-12-02 10:20  by admin                   │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                        [すべて破棄]  [公開]                 │
└─────────────────────────────────────────────────────────────┘
```

### Step 3: 公開を実行

```
User Action: [保存して公開] または [公開] ボタンをクリック

System Response:
  - 公開確認ダイアログを表示
```

**確認ダイアログ:**
```
┌─────────────────────────────────────────────────────────────┐
│ スキーマを公開                                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 以下の変更を公開します：                                     │
│                                                             │
│ Entity: Order                                               │
│   ● 追加: フィールド「orderDate」                           │
│   ◐ 変更: フィールド「customerId」（2件）                   │
│   × 削除: フィールド「oldField」                            │
│                                                             │
│ ⚠️ 公開後、Runtime（フォーム、API等）に即座に反映されます。  │
│    この操作は取り消せません。                                │
│                                                             │
│ 影響を受ける可能性のあるリソース:                            │
│   - OrderEntryForm                                          │
│   - OrderListView                                           │
│   - POST /api/orders                                        │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                              [キャンセル]  [公開する]        │
└─────────────────────────────────────────────────────────────┘
```

### Step 4: 公開確認

```
User Action: [公開する] ボタンをクリック

System Response:
  1. 未保存の変更があれば先に保存
  2. バリデーション実行
  3. API 呼び出し: POST /mapi/apps/schema/api/publish
  4. トランザクション処理:
     - Draft 状態のフィールドを Published に更新
     - 削除予定フィールドを削除
     - Draft 履歴を published に更新
     - バージョン番号をインクリメント
  5. 成功時:
     - Toast 通知: "スキーマを公開しました（Version 3）"
     - Draft バッジを非表示
     - 変更履歴パネルを更新
```

---

## 5. 一括公開フロー

### Step 1: Explorer で Draft 状態を確認

```
User Action: Model Explorer 画面を開く

System Response:
  - Header に Draft 状態を表示: "Draft: 3件"
  - リストで Draft のあるモデルにバッジ表示
```

**Explorer Header:**
```
┌─────────────────────────────────────────────────────────────┐
│ [mirel schema ▼] │ 🔍 モデルを検索... │ Draft: 3件 │ [Publish All] │
└─────────────────────────────────────────────────────────────┘
```

### Step 2: 一括公開を開始

```
User Action: [Publish All] ボタンをクリック

System Response:
  - 一括公開確認ダイアログを表示
```

**一括公開ダイアログ:**
```
┌─────────────────────────────────────────────────────────────┐
│ 一括公開                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 以下の 3 件のモデルを公開します：                           │
│                                                             │
│ ☑ Order (Entity)                                            │
│   ├ ● 追加: orderDate                                       │
│   ├ ◐ 変更: customerId（2件）                               │
│   └ × 削除: oldField                                        │
│                                                             │
│ ☑ OrderLine (Entity)                                        │
│   └ ◐ 変更: price（1件）                                    │
│                                                             │
│ ☑ CustomerType (Code)                                       │
│   └ ● 追加: コード「VIP」                                   │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ □ 個別に選択する                                            │
│                                                             │
│ ⚠️ 公開後、すべての変更が Runtime に即座に反映されます。     │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                              [キャンセル]  [すべて公開]      │
└─────────────────────────────────────────────────────────────┘
```

### Step 3: モデルを選択（オプション）

```
User Action: "個別に選択する" にチェック

System Response:
  - 各モデルのチェックボックスが編集可能に
  - 選択を解除したモデルは公開対象から除外
```

### Step 4: 一括公開を実行

```
User Action: [すべて公開] ボタンをクリック

System Response:
  1. 選択されたモデルを順次公開
  2. 進捗表示
  3. 結果サマリーを表示
```

**進捗表示:**
```
┌─────────────────────────────────────────────────────────────┐
│ 公開中...                                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ✓ Order          公開完了                                   │
│ ✓ OrderLine      公開完了                                   │
│ ◐ CustomerType   公開中...                                  │
│                                                             │
│ [━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━] 67%                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**結果サマリー:**
```
┌─────────────────────────────────────────────────────────────┐
│ 公開完了                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ✓ 3件のモデルを公開しました                                 │
│                                                             │
│ ✓ Order          Version 3                                  │
│ ✓ OrderLine      Version 2                                  │
│ ✓ CustomerType   Version 4                                  │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                              [閉じる]       │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 代替フロー

### 6a. 変更を破棄

```
Step 3a:
  User Action: [変更破棄] ボタンをクリック

  System Response:
    - 破棄確認ダイアログを表示
```

**破棄確認ダイアログ:**
```
┌─────────────────────────────────────────────────────────────┐
│ 変更を破棄                                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ⚠️ 以下の 4 件の未公開変更を破棄します：                     │
│                                                             │
│   ● 追加: フィールド「orderDate」                           │
│   ◐ 変更: フィールド「customerId」（2件）                   │
│   × 削除予定: フィールド「oldField」（復元されます）         │
│                                                             │
│ この操作は取り消せません。                                   │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                              [キャンセル]  [破棄する]        │
└─────────────────────────────────────────────────────────────┘
```

```
Step 3b:
  User Action: [破棄する] ボタンをクリック

  System Response:
    1. API 呼び出し: POST /mapi/apps/schema/api/discardDraft
    2. Draft 状態のフィールドを削除（追加されたもの）
    3. 変更されたフィールドを元に戻す
    4. 削除予定フィールドを復元
    5. Toast 通知: "変更を破棄しました"
    6. 最新の Published 状態を再読み込み
```

### 6b. 個別フィールドの変更破棄

```
Step 2a:
  User Action: 変更履歴パネルで特定の変更項目を選択 → [この変更を破棄]

  System Response:
    - 確認ダイアログなしで該当変更のみ破棄
    - 変更履歴パネルを更新
    - Toast 通知: "変更を破棄しました"
```

---

## 7. 例外フロー

### 7a. バリデーションエラー

```
Step 4 でバリデーションエラーの場合:

System Response:
  - エラーダイアログを表示
  - 公開は実行しない
```

**エラーダイアログ:**
```
┌─────────────────────────────────────────────────────────────┐
│ ⚠️ 公開できません                                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 以下のエラーを修正してください：                             │
│                                                             │
│ ✗ Entity に Primary Key が設定されていません                 │
│   → いずれかのフィールドを PK に設定してください             │
│                                                             │
│ ✗ フィールド「customerId」の参照先「Customer」が存在しません│
│   → 参照先エンティティを作成するか、参照を解除してください   │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                              [閉じる]       │
└─────────────────────────────────────────────────────────────┘
```

### 7b. 競合エラー

```
Step 4 で競合が発生した場合:

System Response:
  - 競合ダイアログを表示
  - 解決方法を提示
```

**競合ダイアログ:**
```
┌─────────────────────────────────────────────────────────────┐
│ ⚠️ 競合が検出されました                                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ このモデルは他のユーザーによって変更されています。          │
│                                                             │
│ あなたの変更:                                               │
│   ◐ フィールド「customerId」の表示名を変更                  │
│                                                             │
│ サーバーの変更 (by user2, 10分前):                          │
│   ◐ フィールド「customerId」のバリデーションを変更          │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ (●) サーバーの変更を優先（自分の変更を破棄）                 │
│ ( ) 自分の変更を優先（サーバーの変更を上書き）               │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                              [キャンセル]  [解決して公開]    │
└─────────────────────────────────────────────────────────────┘
```

### 7c. 権限エラー

```
Step 4 で権限エラーの場合:

System Response:
  - エラー Toast: "スキーマを公開する権限がありません"
  - ダイアログを閉じる
```

### 7d. 一括公開で一部失敗

```
Step 4 で一部のモデルが失敗した場合:

System Response:
  - 結果サマリーでエラーを表示
  - 成功したモデルは公開済み
  - 失敗したモデルは Draft のまま
```

**部分失敗サマリー:**
```
┌─────────────────────────────────────────────────────────────┐
│ 公開完了（一部エラー）                                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ✓ 2件のモデルを公開しました                                 │
│ ✗ 1件のモデルが失敗しました                                 │
│                                                             │
│ ✓ Order          Version 3                                  │
│ ✓ OrderLine      Version 2                                  │
│ ✗ CustomerType   バリデーションエラー                        │
│   └ コード「VIP」と「vip」が重複しています                  │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                              [閉じる]       │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 事後条件

- 公開されたモデルは Published 状態
- Runtime（フォーム、API）に変更が反映されている
- バージョン番号がインクリメントされている
- Draft 履歴が published としてアーカイブされている

---

## 9. シーケンス図

```
User            Designer         Dialog           API              DB
 │                │                │               │                │
 │ [公開]         │                │               │                │
 ├───────────────►│                │               │                │
 │                │ showConfirm    │               │                │
 │                ├───────────────►│               │                │
 │                │                │               │                │
 │ [公開する]     │                │               │                │
 ├────────────────────────────────►│               │                │
 │                │                │ publish()     │                │
 │                │                ├──────────────►│                │
 │                │                │               │                │
 │                │                │               │ BEGIN TX       │
 │                │                │               ├───────────────►│
 │                │                │               │                │
 │                │                │               │ UPDATE fields  │
 │                │                │               ├───────────────►│
 │                │                │               │                │
 │                │                │               │ UPDATE drafts  │
 │                │                │               ├───────────────►│
 │                │                │               │                │
 │                │                │               │ COMMIT         │
 │                │                │               ├───────────────►│
 │                │                │               │                │
 │                │                │ success       │                │
 │                │                │◄──────────────┤                │
 │                │                │               │                │
 │                │ closeDialog    │               │                │
 │                │◄───────────────┤               │                │
 │                │                │               │                │
 │ Toast: 成功   │                │               │                │
 │◄───────────────┤                │               │                │
```

---

## 10. API 呼び出し

### 単一モデル公開

```typescript
POST /mapi/apps/schema/api/publish
Content-Type: application/json

{
  "content": {
    "modelId": "order",
    "force": false
  }
}
```

### レスポンス（成功）

```typescript
{
  "data": {
    "modelId": "order",
    "publishedVersion": 3,
    "publishedAt": "2025-12-02T10:45:00Z"
  },
  "messages": ["スキーマを公開しました"],
  "errors": []
}
```

### 一括公開

```typescript
POST /mapi/apps/schema/api/publishAll
Content-Type: application/json

{
  "content": {
    "modelIds": ["order", "orderLine", "customerType"]
  }
}
```

### レスポンス（一括）

```typescript
{
  "data": {
    "publishedModels": [
      { "modelId": "order", "version": 3 },
      { "modelId": "orderLine", "version": 2 }
    ],
    "failedModels": [
      { "modelId": "customerType", "error": "コード「VIP」と「vip」が重複しています" }
    ]
  },
  "messages": ["2件のモデルを公開しました"],
  "errors": ["1件のモデルが失敗しました"]
}
```

### Draft 破棄

```typescript
POST /mapi/apps/schema/api/discardDraft
Content-Type: application/json

{
  "content": {
    "modelId": "order"
  }
}
```

---

## 11. 通知

### 公開成功時

- **アプリ内**: Toast 通知
- **関係者**: アプリ内通知（ベルアイコン）
- **メール**: 設定により（オプション）

### 公開内容

```
📢 スキーマが公開されました

Entity: Order (Version 3)
公開者: admin
公開日時: 2025-12-02 10:45

変更内容:
  ● 追加: フィールド「orderDate」
  ◐ 変更: フィールド「customerId」
  × 削除: フィールド「oldField」
```

---

# 以上
