# ユースケース: Entity 作成

## 1. 概要

新規 Entity（データモデル）を作成するユースケース。

---

## 2. アクター

- **モデル設計者**: Entity を設計・定義するユーザー

---

## 3. 事前条件

- ユーザーがログイン済み
- Model Explorer または Designer 画面にアクセス可能
- Entity 作成権限を持っている

---

## 4. 基本フロー

### Step 1: 新規作成ダイアログを開く

```
User Action: Model Explorer の [+ 新規モデル作成] ボタンをクリック
System Response: 新規モデル作成ダイアログを表示
```

**ダイアログ内容:**
```
┌─────────────────────────────────────────────────────────────┐
│ 新規モデル作成                                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ モデルタイプ:                                               │
│   (●) Entity  ( ) View                                      │
│                                                             │
│ モデルID *:                                                 │
│   ┌─────────────────────────────────────────────────────┐   │
│   │ order                                               │   │
│   └─────────────────────────────────────────────────────┘   │
│   英数字、アンダースコアのみ。小文字推奨。                   │
│                                                             │
│ モデル名 *:                                                 │
│   ┌─────────────────────────────────────────────────────┐   │
│   │ 注文                                                │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│ カテゴリ:                                                   │
│   (●) トランザクション  ( ) マスタ                           │
│                                                             │
│ 説明:                                                       │
│   ┌─────────────────────────────────────────────────────┐   │
│   │ 顧客の注文トランザクションを管理するエンティティ       │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│ □ テンプレートから作成                                       │
│   [ テンプレートを選択... ▼ ]                                │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                              [キャンセル] [作成]             │
└─────────────────────────────────────────────────────────────┘
```

### Step 2: モデル情報を入力

```
User Action: 
  - モデルタイプ: Entity を選択
  - モデルID: "order" を入力
  - モデル名: "注文" を入力
  - カテゴリ: トランザクション を選択
  - 説明: 任意で入力

System Response:
  - リアルタイムバリデーション実行
  - モデルID の重複チェック
```

**バリデーションルール:**
- モデルID: 必須、英数字とアンダースコアのみ、2-50文字
- モデル名: 必須、1-100文字
- モデルID が既存の場合: エラー表示

### Step 3: 作成を実行

```
User Action: [作成] ボタンをクリック

System Response:
  1. API 呼び出し: POST /mapi/apps/schema/api/createModel
  2. モデルヘッダーを作成（Draft 状態）
  3. デフォルト PK フィールド "id" を自動作成
  4. Model Designer 画面へ遷移
  5. Toast 通知: "Entity 'order' を作成しました"
```

### Step 4: フィールドを追加

```
User Action: Model Designer でフィールドを追加

System Flow:
  1. [+ フィールド] ボタンをクリック
  2. フィールド追加ダイアログまたはインライン編集
  3. フィールド定義を入力
  4. Domain Tree に新規ノードとして表示
```

### Step 5: 保存

```
User Action: [保存] ボタンをクリック

System Response:
  1. API 呼び出し: POST /mapi/apps/schema/api/saveDraft
  2. Draft として保存
  3. Draft バッジを更新
  4. Toast 通知: "Draft を保存しました"
```

---

## 5. 代替フロー

### 5a. テンプレートから作成

```
Step 2a:
  User Action: "テンプレートから作成" にチェック
  
  System Response:
    - テンプレート選択ドロップダウンを表示
    - 選択可能なテンプレート:
      - 基本マスタ（ID, 名称, 有効フラグ）
      - 履歴管理マスタ（+ 開始日, 終了日）
      - トランザクション（+ 作成日, 更新日, ステータス）

Step 2b:
  User Action: テンプレートを選択
  
  System Response:
    - テンプレートのフィールド定義を読み込み
    - プレビュー表示

Step 3a:
  User Action: [作成] ボタンをクリック
  
  System Response:
    - テンプレートのフィールドを含めて Entity 作成
    - Designer 画面へ遷移
```

### 5b. 既存モデルをコピー

```
Step 1b:
  User Action: 既存モデルを右クリック → [複製]
  
  System Response:
    - 複製ダイアログを表示
    - 元モデルの情報がプリセット

Step 2b:
  User Action: 新しいモデルID を入力
  
  System Response:
    - 元モデルのフィールド定義をコピー
    - 新しい Entity を作成
```

---

## 6. 例外フロー

### 6a. モデルID 重複

```
Step 2 でモデルID が既存の場合:

System Response:
  - フィールドにエラー表示: "モデルID 'order' は既に存在します"
  - [作成] ボタンを無効化
```

### 6b. API エラー

```
Step 3 で API エラーが発生した場合:

System Response:
  - エラー Toast: "Entity の作成に失敗しました"
  - エラー詳細をコンソールに出力
  - ダイアログは閉じない
```

### 6c. 権限エラー

```
Step 3 で権限エラーの場合:

System Response:
  - エラー Toast: "Entity を作成する権限がありません"
  - ダイアログを閉じる
```

---

## 7. 事後条件

- 新規 Entity が Draft 状態で作成されている
- Model Explorer のリストに新規 Entity が表示される
- Designer 画面でフィールド編集が可能

---

## 8. シーケンス図

```
User            Explorer          Dialog           API              Store
 │                │                 │               │                 │
 │ [+新規作成]    │                 │               │                 │
 ├───────────────►│                 │               │                 │
 │                │ openDialog()    │               │                 │
 │                ├────────────────►│               │                 │
 │                │                 │               │                 │
 │ 入力           │                 │               │                 │
 ├────────────────────────────────►│               │                 │
 │                │                 │ validate()    │                 │
 │                │                 ├──────────────►│                 │
 │                │                 │               │                 │
 │ [作成]         │                 │               │                 │
 ├────────────────────────────────►│               │                 │
 │                │                 │ createModel   │                 │
 │                │                 ├──────────────►│                 │
 │                │                 │               │ INSERT          │
 │                │                 │               ├────────────────►│
 │                │                 │ success       │                 │
 │                │                 │◄──────────────┤                 │
 │                │                 │               │                 │
 │                │ closeDialog     │               │                 │
 │                │◄────────────────┤               │                 │
 │                │                 │               │                 │
 │                │ navigate(/designer/order)       │                 │
 │◄───────────────┤                 │               │                 │
```

---

## 9. 画面遷移

```
Model Explorer
    │
    │ [+ 新規モデル作成]
    ▼
┌─────────────────┐
│ 作成ダイアログ   │
└────────┬────────┘
         │ [作成]
         ▼
Model Designer (/apps/schema/designer/order)
```

---

## 10. API 呼び出し

### リクエスト

```typescript
POST /mapi/apps/schema/api/createModel
Content-Type: application/json

{
  "content": {
    "modelId": "order",
    "modelName": "注文",
    "modelType": "entity",
    "modelCategory": "transaction",
    "description": "顧客の注文トランザクションを管理するエンティティ",
    "copyFrom": null
  }
}
```

### レスポンス（成功）

```typescript
{
  "data": {
    "modelId": "order",
    "created": true
  },
  "messages": ["Entity 'order' を作成しました"],
  "errors": []
}
```

### レスポンス（エラー）

```typescript
{
  "data": {},
  "messages": [],
  "errors": ["モデルID 'order' は既に存在します"],
  "errorCode": "DUPLICATE_KEY"
}
```

---

# 以上
